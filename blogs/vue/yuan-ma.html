<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue源码 | ccy&#39;s blogs</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/ccyblog/favicon.ico">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/UsernameFull/l2d@0.2/js/frame/live2dcubismcore.min.js"></script>
    <script src="https://pixijs.download/v4.8.4/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/litstronger/live2d-moc3@master/js/live2dcubismframework.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/litstronger/live2d-moc3@master/js/live2dcubismpixi.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/litstronger/live2d-moc3@master/js/l2d.js"></script>
    <meta name="description" content="个人技术博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/ccyblog/assets/css/0.styles.79d32354.css" as="style"><link rel="preload" href="/ccyblog/assets/js/app.61cc9ff9.js" as="script"><link rel="preload" href="/ccyblog/assets/js/3.897744a6.js" as="script"><link rel="preload" href="/ccyblog/assets/js/1.371d3697.js" as="script"><link rel="preload" href="/ccyblog/assets/js/18.71e79375.js" as="script"><link rel="preload" href="/ccyblog/assets/js/8.b19724a0.js" as="script"><link rel="prefetch" href="/ccyblog/assets/js/10.a51d9fc9.js"><link rel="prefetch" href="/ccyblog/assets/js/11.8d124275.js"><link rel="prefetch" href="/ccyblog/assets/js/12.a334a46b.js"><link rel="prefetch" href="/ccyblog/assets/js/13.8010945d.js"><link rel="prefetch" href="/ccyblog/assets/js/14.8e3c3ac4.js"><link rel="prefetch" href="/ccyblog/assets/js/15.81bd0ba2.js"><link rel="prefetch" href="/ccyblog/assets/js/16.232611db.js"><link rel="prefetch" href="/ccyblog/assets/js/17.667dde35.js"><link rel="prefetch" href="/ccyblog/assets/js/19.f10b5e62.js"><link rel="prefetch" href="/ccyblog/assets/js/20.dd05ecdc.js"><link rel="prefetch" href="/ccyblog/assets/js/21.4a07e2cf.js"><link rel="prefetch" href="/ccyblog/assets/js/22.29c735e7.js"><link rel="prefetch" href="/ccyblog/assets/js/23.04beb3f2.js"><link rel="prefetch" href="/ccyblog/assets/js/24.e4efbb4f.js"><link rel="prefetch" href="/ccyblog/assets/js/25.63de8752.js"><link rel="prefetch" href="/ccyblog/assets/js/26.1a8c82ca.js"><link rel="prefetch" href="/ccyblog/assets/js/27.47678a4d.js"><link rel="prefetch" href="/ccyblog/assets/js/28.4d87f639.js"><link rel="prefetch" href="/ccyblog/assets/js/29.d613dcd8.js"><link rel="prefetch" href="/ccyblog/assets/js/30.610dbdf4.js"><link rel="prefetch" href="/ccyblog/assets/js/31.c4817f6d.js"><link rel="prefetch" href="/ccyblog/assets/js/32.7af520a4.js"><link rel="prefetch" href="/ccyblog/assets/js/33.5ce06274.js"><link rel="prefetch" href="/ccyblog/assets/js/34.b2117dfb.js"><link rel="prefetch" href="/ccyblog/assets/js/35.377603e6.js"><link rel="prefetch" href="/ccyblog/assets/js/36.883e88a6.js"><link rel="prefetch" href="/ccyblog/assets/js/37.872a7cdf.js"><link rel="prefetch" href="/ccyblog/assets/js/38.18f351f9.js"><link rel="prefetch" href="/ccyblog/assets/js/39.0487dd57.js"><link rel="prefetch" href="/ccyblog/assets/js/4.9b4181ee.js"><link rel="prefetch" href="/ccyblog/assets/js/40.abacd655.js"><link rel="prefetch" href="/ccyblog/assets/js/41.abf116df.js"><link rel="prefetch" href="/ccyblog/assets/js/42.7f9de919.js"><link rel="prefetch" href="/ccyblog/assets/js/43.d41da37b.js"><link rel="prefetch" href="/ccyblog/assets/js/44.7c2519a6.js"><link rel="prefetch" href="/ccyblog/assets/js/45.29a6bc83.js"><link rel="prefetch" href="/ccyblog/assets/js/46.5f6478d4.js"><link rel="prefetch" href="/ccyblog/assets/js/47.631bdc1f.js"><link rel="prefetch" href="/ccyblog/assets/js/48.6df6dfd4.js"><link rel="prefetch" href="/ccyblog/assets/js/49.8fdfb49c.js"><link rel="prefetch" href="/ccyblog/assets/js/5.bd4235cd.js"><link rel="prefetch" href="/ccyblog/assets/js/50.88f2f8bf.js"><link rel="prefetch" href="/ccyblog/assets/js/51.f502157e.js"><link rel="prefetch" href="/ccyblog/assets/js/52.9bf27ff9.js"><link rel="prefetch" href="/ccyblog/assets/js/53.56ba7eeb.js"><link rel="prefetch" href="/ccyblog/assets/js/54.212c55f1.js"><link rel="prefetch" href="/ccyblog/assets/js/55.6fc8672f.js"><link rel="prefetch" href="/ccyblog/assets/js/56.8cbf943d.js"><link rel="prefetch" href="/ccyblog/assets/js/57.8b84c069.js"><link rel="prefetch" href="/ccyblog/assets/js/58.df9fd31e.js"><link rel="prefetch" href="/ccyblog/assets/js/59.4a889f7f.js"><link rel="prefetch" href="/ccyblog/assets/js/6.1ebcf0d6.js"><link rel="prefetch" href="/ccyblog/assets/js/60.045b3756.js"><link rel="prefetch" href="/ccyblog/assets/js/61.4e8f609c.js"><link rel="prefetch" href="/ccyblog/assets/js/62.4fe15d75.js"><link rel="prefetch" href="/ccyblog/assets/js/63.e9ac2545.js"><link rel="prefetch" href="/ccyblog/assets/js/64.083e8d2c.js"><link rel="prefetch" href="/ccyblog/assets/js/65.b6e595bc.js"><link rel="prefetch" href="/ccyblog/assets/js/66.26689277.js"><link rel="prefetch" href="/ccyblog/assets/js/67.60ccd17c.js"><link rel="prefetch" href="/ccyblog/assets/js/68.42b6df4a.js"><link rel="prefetch" href="/ccyblog/assets/js/69.1d5ac1c5.js"><link rel="prefetch" href="/ccyblog/assets/js/7.58212ba9.js"><link rel="prefetch" href="/ccyblog/assets/js/70.6b794575.js"><link rel="prefetch" href="/ccyblog/assets/js/71.09fac264.js"><link rel="prefetch" href="/ccyblog/assets/js/72.ee6a2190.js"><link rel="prefetch" href="/ccyblog/assets/js/73.da9be3f4.js"><link rel="prefetch" href="/ccyblog/assets/js/74.d901de2d.js"><link rel="prefetch" href="/ccyblog/assets/js/75.a8f3a837.js"><link rel="prefetch" href="/ccyblog/assets/js/76.26405b7a.js"><link rel="prefetch" href="/ccyblog/assets/js/77.abe05554.js"><link rel="prefetch" href="/ccyblog/assets/js/78.6fd39cf3.js"><link rel="prefetch" href="/ccyblog/assets/js/79.5a5a23fb.js"><link rel="prefetch" href="/ccyblog/assets/js/80.5de6685c.js"><link rel="prefetch" href="/ccyblog/assets/js/81.452915be.js"><link rel="prefetch" href="/ccyblog/assets/js/82.04c6cc59.js"><link rel="prefetch" href="/ccyblog/assets/js/83.8288a3e4.js"><link rel="prefetch" href="/ccyblog/assets/js/84.e49e3728.js"><link rel="prefetch" href="/ccyblog/assets/js/85.8ad8ef5d.js"><link rel="prefetch" href="/ccyblog/assets/js/86.1d4c8e78.js"><link rel="prefetch" href="/ccyblog/assets/js/87.fc6b54da.js"><link rel="prefetch" href="/ccyblog/assets/js/88.1e7cf8b0.js"><link rel="prefetch" href="/ccyblog/assets/js/9.a8e5976d.js">
    <link rel="stylesheet" href="/ccyblog/assets/css/0.styles.79d32354.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-1156296a><div data-v-1156296a><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-1156296a data-v-1156296a><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out" style="display:none;" data-v-4e82dffc data-v-1156296a data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>ccy's blogs</h3> <p class="description" data-v-4e82dffc data-v-4e82dffc>个人技术博客</p> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>月夕花辰</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-1156296a><header class="navbar" data-v-1156296a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ccyblog/" class="home-link router-link-active"><img src="/ccyblog/avatar.png" alt="ccy's blogs" class="logo"> <span class="site-name">ccy's blogs</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ccyblog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ccyblog/categories/配置/" class="nav-link"><i class="undefined"></i>
  配置
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/手写题/" class="nav-link"><i class="undefined"></i>
  手写题
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/直播/" class="nav-link"><i class="undefined"></i>
  直播
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/Webpack/" class="nav-link"><i class="undefined"></i>
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/优化/" class="nav-link"><i class="undefined"></i>
  优化
</a></li></ul></div></div><div class="nav-item"><a href="/ccyblog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/ccyblog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/FrancisSaber" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="./public/avatar.png"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-1156296a></div> <aside class="sidebar" data-v-1156296a><div class="personal-info-wrapper" data-v-828910c6 data-v-1156296a><img src="/ccyblog/avatar.png" alt="author-avatar" class="personal-img" data-v-828910c6> <h3 class="name" data-v-828910c6>
    月夕花辰
  </h3> <div class="num" data-v-828910c6><div data-v-828910c6><h3 data-v-828910c6>72</h3> <h6 data-v-828910c6>文章</h6></div> <div data-v-828910c6><h3 data-v-828910c6>19</h3> <h6 data-v-828910c6>标签</h6></div></div> <ul class="social-links" data-v-828910c6></ul> <hr data-v-828910c6></div> <nav class="nav-links"><div class="nav-item"><a href="/ccyblog/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ccyblog/categories/配置/" class="nav-link"><i class="undefined"></i>
  配置
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/vue/" class="nav-link"><i class="undefined"></i>
  vue
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/手写题/" class="nav-link"><i class="undefined"></i>
  手写题
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/直播/" class="nav-link"><i class="undefined"></i>
  直播
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/网络/" class="nav-link"><i class="undefined"></i>
  网络
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/Webpack/" class="nav-link"><i class="undefined"></i>
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/ccyblog/categories/优化/" class="nav-link"><i class="undefined"></i>
  优化
</a></li></ul></div></div><div class="nav-item"><a href="/ccyblog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/ccyblog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/FrancisSaber" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="./public/avatar.png"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ccyblog/blogs/vue/yuan-ma.html" aria-current="page" class="active sidebar-link">Vue源码</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-4e82dffc data-v-1156296a><h3 class="title" data-v-4e82dffc data-v-4e82dffc>Vue源码</h3> <!----> <label id="box" class="inputBox" data-v-4e82dffc data-v-4e82dffc><input type="password" value="" data-v-4e82dffc> <span data-v-4e82dffc>Konck! Knock!</span> <button data-v-4e82dffc>OK</button></label> <div class="footer" data-v-4e82dffc data-v-4e82dffc><span data-v-4e82dffc><i class="iconfont reco-theme" data-v-4e82dffc></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-4e82dffc>vuePress-theme-reco</a></span> <span data-v-4e82dffc><i class="iconfont reco-copyright" data-v-4e82dffc></i> <a data-v-4e82dffc><span data-v-4e82dffc>月夕花辰</span>
            
          <span data-v-4e82dffc>2021 - </span>
          2022
        </a></span></div></div> <div data-v-1156296a><main class="page"><section><div class="page-title"><h1 class="title">Vue源码</h1> <div data-v-1ff7123e><i class="iconfont reco-account" data-v-1ff7123e><span data-v-1ff7123e>月夕花辰</span></i> <i class="iconfont reco-date" data-v-1ff7123e><span data-v-1ff7123e>2021/11/10</span></i> <!----> <i class="tags iconfont reco-tag" data-v-1ff7123e><span class="tag-item" data-v-1ff7123e>部署</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="变化侦测"><a href="#变化侦测" class="header-anchor">#</a> 变化侦测</h2> <h3 id="什么是变化侦测"><a href="#什么是变化侦测" class="header-anchor">#</a> 什么是变化侦测</h3> <ol><li><p>从状态生成DOM，再输出到用户界面显示的一整套流程叫作渲染，应用在运待时会不断地进行重新渲染。而响应式系统赋予框架重新渲染的能力，其重要组成部分是变化侦测。<font color="orange">变化侦测是响应式系统的核心，没有它，就没有重新渲染。框架在运行时，视图也就无法随着状态的变化而变化。</font></p> <blockquote><p><font color="orange">状态</font>可以是JavaScript 中的任意类型。object、Array、String、Number、Boolean等都可以作为状态，这些状态可能最终会以段落、表单、链接或按钮等元素呈现在用户界面上，具体地说是呈现在页面上。</p></blockquote></li> <li><p>vue.js的变化侦测属于推，当状态发生变化时，Vue.js立即就知道了，并一定程度上知道哪些状态变化了，因此它知道的信息更多，可立即进行细粒度更新。</p></li> <li><p>所谓更细粒度的更新，就是说:假如有一个状态绑定着好多个依赖，每个依赖表示一个具体的 DOM节点,那么当这个状态发生变化时,向这个状态的所有依赖发送通知，让它们进行DOM更新操作。相比较而言，“拉”的粒度是最粗的。</p></li> <li><p>但是它也有一定的代价，因为粒度越细，每个状态所绑定的依赖就越多，依赖追踪在内存上的开销就会越大。因此，<font color="orange">从 Vue.js 2.0开始，引入了虚拟DOM，将粒度调整为中等粒度，即一个状态所绑定的依赖不再是具体的 DOM节点，而是一个组件。</font><font color="pink">这样状态变化后，会通知到组件，组件内部再使用虚拟DOM进行比对。这可以大大降低依赖数量，从而降低依赖追踪所消耗的内存。</font></p></li></ol> <h3 id="如何追踪变化侦测"><a href="#如何追踪变化侦测" class="header-anchor">#</a> 如何追踪变化侦测</h3> <p><font color="cornflowerblue">有两种方法可以侦测到变化:使用object.defineProperty和 ES6的Proxy.              </font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> val<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token literal-property property">emumerable</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>	<span class="token comment">//可枚举</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>	<span class="token comment">//可修改</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>
            val <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//这里定义一个defineReactive函数是对Object.defineProperty进行封装，将传入的数据转化成响应式数据进行变化侦测追踪。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="如何收集函数依赖"><a href="#如何收集函数依赖" class="header-anchor">#</a> 如何收集函数依赖</h3> <p><font color="orange">当一个状态被某个依赖使用时，会触发该状态的get函数，因此可以在get函数触发时储存该依赖，当状态被修改时，会触发set函数，在set函数触发时向依赖发出通知，让视图更新</font></p> <h3 id="依赖收集在哪-订阅者"><a href="#依赖收集在哪-订阅者" class="header-anchor">#</a> 依赖收集在哪  （订阅者）</h3> <p>通过改造defineReactive函数，在将状态转化成响应式数据的同时，创建数组用以收集状态相关依赖</p> <p><font color="orange">Vue实例化后都会生成一个用于渲染DOM的订阅者。此订阅者在实例化时传入的getter方法为渲染DOM的方法。</font></p> <p>Vue实例在初始化时，会为需要侦测的状态生成订阅者对象，并通过获取对象值将自身加入侦测对象的依赖数组</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//执行 this.getter(),可以获取expOrFn的值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>	<span class="token comment">//参数为一个字符串，如data.a.b.c，通过解析获取具体值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//用以获取侦测对象当前值，具体执行通过getter函数</span>
        widnow<span class="token punctuation">.</span>target  <span class="token operator">=</span> <span class="token keyword">this</span>			   <span class="token comment">//将依赖执行target</span>
        <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">)</span>	<span class="token comment">//获取观察对象的值，因为所获取的对象为响应式数据，会触发其getter方法，从而将window.target加入其dep数组，收集依赖</span>
        window<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> oldVal <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value 	<span class="token comment">//获取旧值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//获取对象的新值</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span>	 	<span class="token comment">//执行回调函数</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">parsePath</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> bailRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\w.$]</span><span class="token regex-delimiter">/</span></span> 	<span class="token comment">//不匹配字母、数字、下划线、点号和$符号，用于检查路径是否符合规则</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>bailRE<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> segments <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token comment">//解析字符串，遇到就将.的前面字符取出推入数组</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//传入的参数为Vue示例，首先会读取Vue[data]，data[a],a[b],b[c]</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>segments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span>
            obj <span class="token operator">=</span> obj<span class="token punctuation">[</span>segments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>	<span class="token comment">//递归读取对象属性，直到读取到字符串所匹配的属性值</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> obj
    <span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h4 id="用以收集依赖的dep类"><a href="#用以收集依赖的dep类" class="header-anchor">#</a> 用以收集依赖的Dep类</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 	<span class="token comment">//创建一个空数组</span>
    <span class="token punctuation">}</span>
    <span class="token function">addSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>	<span class="token comment">//往数组加入依赖</span>
    <span class="token punctuation">}</span>
    <span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">,</span> sub<span class="token punctuation">)</span>	<span class="token comment">//删除依赖</span>
    <span class="token punctuation">}</span>
    <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果存在依赖，收集</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//通知依赖更新视图</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果数组存在元素</span>
            <span class="token keyword">const</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>		<span class="token comment">//获取所要删除元素序号</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		    	<span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>		<span class="token comment">//删除该元素</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//改造后的defineReactive</span>
<span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> val<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token literal-property property">emumerable</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>	<span class="token comment">//可枚举</span>
        <span class="token literal-property property">configurable</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>	<span class="token comment">//可修改</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//假设依赖在window.target</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span>
            <span class="token punctuation">}</span>  
            val <span class="token operator">=</span> newVal
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">//通知状态相关依赖更新视图</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="什么是依赖"><a href="#什么是依赖" class="header-anchor">#</a> 什么是依赖</h3> <p>依赖就是当状态更新时，需要通知用到数据的模板或watch等。为此，可以创建一个watcher类，当状态更新时，只需通知它一个，再由watcher通知进行视图更新</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span><span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//expOrFn为观察数据，cb为回调函数，vm为vue实例</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="递归侦测所有的key"><a href="#递归侦测所有的key" class="header-anchor">#</a> 递归侦测所有的key</h3> <p>通过<font color="orange">Observer</font>类将数据的所有属性及其子属性转换成响应式数据</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Arrary<span class="token punctuation">.</span><span class="token function">isArrary</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果所传入参数非数组，将其转成响应式数据</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">walk</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>	<span class="token comment">//将传入对象所有属性转换成响应式数据</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">defineReactive</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token comment">//defineReactive 要新加入一个判断，如果传入值仍有子属性，继续递归Observer</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="dep和watcher类"><a href="#dep和watcher类" class="header-anchor">#</a> Dep和Watcher类</h3> <blockquote><p><font color="orange">Dep</font> : 一个订阅者的列表类，可以增加或删除订阅者，可以向订阅者发送消息</p> <p><font color="orange">Watcher</font> : 订阅者类。它在初始化时可以接受getter, callback两个函数作为参数。getter用来计算Watcher对象的值。当Watcher被触发时，会重新通过getter计算当前Watcher的值，如果值改变，则会执行callback.</p></blockquote> <h3 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h3> <p><code>Vue.js通过object.defineProperty来将对象的 key转换成getter/setter的形式来追踪变化,但getter/setter 只能追踪一个数据是否被修改，无法追踪新增属性和删除属性</code></p> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <blockquote><p><font color="pink">变化侦测就是侦测数据的变化。当数据发生变化时，要能侦测到并发出通知</font>。
<font color="orange"><code>object</code>可以通过<code>object.defineProperty</code>将属性转换成<code>getter/setter</code>的形式来追踪变化。读取数据时会触发getter，修改数据时会触发setter。</font>
我们需要在getter中收集有哪些依赖使用了数据。当setter被触发时，去通知 getter中收集的依赖数据发生了变化。
收集依赖需要为依赖找一个存储依赖的地方，为此我们创建了Dep，它用来收集依赖、删除依赖和向依赖发送消息等。
所谓的依赖，其实就是watcher。<font color="red">只有watcher触发的getter才会收集依赖，哪个watcher触发了getter，就把哪个watcher收集到Dep中。</font>当数据发生变化时，会循环依赖列表，把所有的 watcher都通知一遍。
<font color="orange">watcher的原理是先把自己设置到全局唯一的指定位置（例如window.target )，然后读取数据。因为读取了数据，所以会触发这个数据的 getter。接着，在 getter 中就会从全局唯一的那个位置读取当前正在读取数据的 watcher,并把这个watcher收集到Dep中去。通过这样的方式，watcher可以主动去订阅任意一个数据的变化。</font> <font color="orange">此外，我们创建了observer类，它的作用是把一个object 中的所有数据（包括子数据)都转换成响应式的，也就是它会侦测object中所有数据（包括子数据）的变化。</font>
由于在ES6之前JavaScript并没有提供元编程的能力，所以在对象上新增属性和删除属性都无法被追踪到。</p></blockquote> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210902161639539.png" alt="image-20210902161639539" style="zoom:80%;"> <h2 id="arrary的变化侦测"><a href="#arrary的变化侦测" class="header-anchor">#</a> Arrary的变化侦测</h2> <h3 id="如何追踪变化"><a href="#如何追踪变化" class="header-anchor">#</a> 如何追踪变化</h3> <blockquote><p>object的变化是靠setter来追踪的，只要一个数据发生了变化，一定会触发setter。
同理，前面例子中使用push来改变数组的内容，那么我们只要能在用户使用push操作数组的时候得到通知，就能实现同样目的。
可惜的是，在 ES6之前，JavaScript并没有提供元编程的能力，也就是没有提供可以拦截原型方法的能力，但是这难不倒聪明的程序员们。我们可以用自定义的方法去覆盖原生的原型方法。
我们可以用一个拦截器覆盖Array.prototype。之后，每当使用Array原型上的方法操作数组时，其实执行的都是拦截器中提供的方法，比如push方法。然后，在拦截器中使用原生Array 的原型方法去操作数组。</p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210902162108668.png" alt="image-20210902162108668" style="zoom:80%;"></blockquote> <h3 id="拦截器"><a href="#拦截器" class="header-anchor">#</a> 拦截器</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype 	<span class="token comment">//获取Array的原型对象</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> arrayMethods <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>arrayProto<span class="token punctuation">)</span>	<span class="token comment">//用Array的原型对象创建新对象</span>
<span class="token comment">// arrayMethods.__proto__ === arrayProto		true 即arrayMethods上可以使用array原型上数组操作等方法</span>
<span class="token punctuation">;</span><span class="token punctuation">[</span>
    <span class="token string">'push'</span><span class="token punctuation">,</span>
    <span class="token string">'pop'</span><span class="token punctuation">,</span>
    <span class="token string">'shift'</span><span class="token punctuation">,</span>
    <span class="token string">'unshift'</span><span class="token punctuation">,</span>
    <span class="token string">'splice'</span><span class="token punctuation">,</span>
    <span class="token string">'sort'</span><span class="token punctuation">,</span>
    <span class="token string">'reverse'</span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> orignal <span class="token operator">=</span> arraryProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token comment">// 获取array原型对象的同名方法</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arraryMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token comment">//新定义对象的数组同名操作方法</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>               <span class="token comment">//修改原始数组方法</span>
            <span class="token keyword">return</span> orignal<span class="token punctuation">.</span><span class="token function">applay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>           <span class="token comment">//将数组原型对象方法运用于arraryMethods对象</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="使用拦截器覆盖array原型"><a href="#使用拦截器覆盖array原型" class="header-anchor">#</a> 使用拦截器覆盖Array原型</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Obeserver</span><span class="token punctuation">{</span>			
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value		
        <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果侦测对象为数组</span>
            value<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> arrayMethods		<span class="token comment">//使用arrayMethods覆盖原型方法</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>				   <span class="token comment">//否则执行将对象转为响应式方法</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>_proto_</code>其实是object.getPrototypeoF和 object.setPrototypeof的早期实现，所以使用ES6的0bject.setPrototypeOf 来代替_proto_完全可以实现同样的效果。只是到目前为止，ES6在浏览器中的支持度并不理想。</p> <h4 id="处理不能使用-proto-的情况"><a href="#处理不能使用-proto-的情况" class="header-anchor">#</a> 处理不能使用<code>__proto__</code>的情况</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> hasProto <span class="token operator">=</span> <span class="token string">'__proto__'</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>	<span class="token comment">//判断能否使用__proto__</span>
<span class="token keyword">const</span> arrayKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">)</span>	<span class="token comment">//获取拦截器的属性方法</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> augment <span class="token operator">=</span> hasProto<span class="token operator">?</span>protoAugment<span class="token operator">:</span>copyAugment
            <span class="token function">augment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">protoAugment</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    target<span class="token punctuation">.</span>__proto__ <span class="token operator">=</span> src		<span class="token comment">//如果侦测数组可使用原型对象，直接加上拦截器</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">copyAgument</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> src<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果不能</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> l<span class="token operator">=</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	
        <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token function">def</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>		    <span class="token comment">//通过遍历拦截器属性值，一个个为侦测数组添加添加响应式属性方法值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="依赖列表的存储"><a href="#依赖列表的存储" class="header-anchor">#</a> 依赖列表的存储</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Obesever</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span>value
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> augment <span class="token operator">=</span> hasProto<span class="token operator">?</span>protoAugment<span class="token operator">:</span>copyAugment
            <span class="token function">augment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="收集依赖"><a href="#收集依赖" class="header-anchor">#</a> 收集依赖</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">defineReactive</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> childOb <span class="token operator">=</span> <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// val为数组</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>childOb<span class="token punctuation">)</span><span class="token punctuation">{</span>
                childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
		   <span class="token punctuation">}</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">===</span> newVal<span class="token punctuation">)</span> <span class="token keyword">return</span>
            dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            val <span class="token operator">=</span> newVal
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> asRootData</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>	<span class="token comment">//	如果侦测值不是对象返回</span>
    <span class="token keyword">let</span> ob
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>__ob__ <span class="token keyword">instanceof</span> <span class="token class-name">Observer</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果侦测值有ob对象</span>
        ob <span class="token operator">=</span> value<span class="token punctuation">.</span>__ob__	
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>		<span class="token comment">//没有的话使用Obsever类转换成响应对象</span>
        ob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ob	<span class="token comment">//返回依赖</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="在拦截器获取observer实例"><a href="#在拦截器获取observer实例" class="header-anchor">#</a> 在拦截器获取Observer实例</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">def</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> emumerable</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//在侦测对象上加上 __ob__属性值，可通过value.__ob__ 访问到 </span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span>val<span class="token punctuation">,</span>
    	<span class="token literal-property property">emumerable</span><span class="token operator">:</span><span class="token operator">!</span><span class="token operator">!</span>emumerable  	<span class="token comment">//因为实际传参没有传emumerable值，所有默认为undefined，加上两个非为true</span>
        <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
	<span class="token function">constrcutor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Aarray<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">const</span> <span class="token function">augment</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> arrayMethods<span class="token punctuation">,</span> arrayKeys<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> orignal <span class="token operator">=</span> arraryProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token comment">// 获取array原型对象的同名方法</span>
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>arraryMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token punctuation">{</span>      <span class="token comment">//新定义对象的数组同名操作方法</span>
        <span class="token function-variable function">value</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token function">mutator</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>               <span class="token comment">//修改原始数组方法</span>
    	    <span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__     <span class="token comment">//  当有数组用到原型方法时，可以通过传入方法的value使用Observer对象</span>
            <span class="token keyword">return</span> orignal<span class="token punctuation">.</span><span class="token function">applay</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>           <span class="token comment">//将数组原型对象方法运用于arraryMethods对象</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="发送通知"><a href="#发送通知" class="header-anchor">#</a> 发送通知</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> orignal <span class="token operator">=</span> arraryProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token comment">// 获取array原型对象的同名方法</span>
    <span class="token comment">//def函数作用是让拦截器可以访问到依赖，并在数组变更时通知依赖数组发生更新</span>
    <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	 	<span class="token keyword">const</span> result  <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
		<span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
         ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> result		<span class="token comment">//让拦截器可以使用原生数组操作方法</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//当添加了拦截器数组进行操作时，拦截器可以访问到数组操作值上的依赖（Obsever）</span>
<span class="token comment">//通过依赖通知视图更新</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><blockquote><p>以上是对数组自身变化的侦测，当数组增加或者删除元素时，可以侦测发出通知</p> <h4 id="具体步骤"><a href="#具体步骤" class="header-anchor">#</a> 具体步骤</h4> <ul><li><p>需要被侦测的数组被定义（defineReactive）时，会定义一个存储依赖的数组,判断其是否有依赖对象属性<code>__ob__</code></p></li> <li><p>有就返回没有就创建</p> <blockquote><p>创建的具体步骤是判断其是否可以使用 <code>__proto__</code>,可以则直接将侦测数组的<code>__proto__</code>指向拦截器，否则就遍历拦截器上的属性，一个个为数组添加拦截器上的属性方法</p> <p><font color="orange">拦截器作用是让数组可以使用原生的mutator方法，并且可以访问依赖（Observer），当使用mutator方法时，向依赖发通知</font></p></blockquote></li> <li><p>接着如同对象，当有状态使用到则添加依赖到dep，一个数组的依赖函数上也有dep对象存储相同依赖</p></li> <li></li></ul></blockquote> <h3 id="对数组单个元素进行侦测"><a href="#对数组单个元素进行侦测" class="header-anchor">#</a> 对数组单个元素进行侦测</h3> <p>通过递归侦测数组的每一个元素</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Observer</span><span class="token punctuation">{</span>
    <span class="token comment">//遍历数组元素，如果是对象执行walk，是数组递归执行observerArray</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
		<span class="token function">def</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span><span class="token string">'__ob__'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>		<span class="token comment">//将依赖添加在侦测对象的__ob__属性上</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">observerArray</span><span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>items<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">observe</span><span class="token punctuation">(</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>			<span class="token comment">//子元素是否已有__ob__，有则返回，无则生成添加</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="侦测新增元素的变化"><a href="#侦测新增元素的变化" class="header-anchor">#</a> 侦测新增元素的变化</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> orignal <span class="token operator">=</span> arraryProto<span class="token punctuation">[</span>method<span class="token punctuation">]</span> <span class="token comment">// 获取array原型对象的同名方法</span>
    <span class="token comment">//def函数作用是让拦截器可以访问到依赖，并在数组变更时通知依赖数组发生更新</span>
    <span class="token function">def</span><span class="token punctuation">(</span>arrayMethods<span class="token punctuation">,</span> method<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">mutator</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	 	<span class="token keyword">const</span> result  <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
		<span class="token keyword">const</span> ob <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>__ob__
		<span class="token keyword">let</span> insert	
		<span class="token keyword">switch</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">case</span><span class="token operator">:</span><span class="token string">'push'</span><span class="token operator">:</span>
             <span class="token keyword">case</span><span class="token operator">:</span><span class="token string">'unshift'</span><span class="token operator">:</span>	<span class="token comment">//当在数组最前面添加了元素</span>
                insert <span class="token operator">=</span> args
                <span class="token keyword">break</span>
             <span class="token keyword">case</span><span class="token operator">:</span><span class="token string">'splice'</span><span class="token operator">:</span>		 
             <span class="token comment">//如果使用splice，参数为3个，只需侦测第三个元素（索引为2），即新加入的元素</span>
             insert <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>	
             <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>insert<span class="token punctuation">)</span> ob<span class="token punctuation">.</span><span class="token function">observeArray</span><span class="token punctuation">(</span>insert<span class="token punctuation">)</span>	<span class="token comment">//将变化的元素进行递归侦测</span>
         ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> result		<span class="token comment">//让拦截器可以使用原生数组操作方法</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="问题-2"><a href="#问题-2" class="header-anchor">#</a> 问题</h3> <p>对 Array的变化侦测是通过拦截原型的方式实现的。正是因为这种实现方;其实有些数组操作Vue.js是拦截不到的，例如:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>arrays<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>arrays<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//这样修改数组不会触发 re-render 或者watch</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <ul><li>Array追踪变化的方式和 object 不一样。因为它是通过方法来改变内容的，所以我们通过创建拦截器去覆盖数组原型的方式来追踪变化。</li> <li>为了不污染全局Array.prototype，我们在observer中只针对那些需要侦测变化的数组使用_proto_来覆盖原型方法，但_proto_在ES6之前并不是标准属性，不是所有浏览器都支持它。因此，<font color="orange">针对不支持_proto_属性的浏览器，我们直接循环拦截器，把拦截器中的方法直接设置到数组身上来拦截Array . prototype 上的原生方法。</font></li> <li><font color="orange">Array收集依赖的方式和 object一样,都是在getter中收集.但是由于使用依赖的位置不同，数组要在拦截器中向依赖发消息，所以依赖不能像object那样保存在defineReactive中，而是把依赖保存在了observer实例上。</font></li> <li>在Observer中，我们<font color="orange">对每个侦测了变化的数据都标上印记_ob_，并把 this ( observer实例)保存在_ob_上</font>。这主要有两个作用，<font color="pink">一方面是为了标记数据是否被侦测了变化(保证同一个数据只被侦测一次)，另一方面可以很方便地通过数据取到_ob_,从而拿到observer实例上保存的依赖。当拦截到数组发生变化时，向依赖发送通知。</font></li> <li>除了侦测数组自身的变化外，数组中元素发生的变化也要侦测。我们在0bserver中判断如果当前被侦测的数据是数组，则<font color="pink">调用observeArray方法将数组中的每一个元素都转换成响应式的并侦测变化。</font></li> <li>除了侦测已有数据外，当用户使用push等方法向数组中新增数据时，新增的数据也要进行变化侦测。我们使用当前操作数组的方法来进行判断，如果是push、unshift和 splice方法，则从参数中将新增数据提取出来，然后使用observeArray对新增数据进行变化侦测。</li> <li>由于在ES6之前，JavaScript并没有提供元编程的能力，所以对于数组类型的数据，一些语法无法追踪到变化，只能拦截原型上的方法，而无法拦截数组特有的语法，例如使用length清空数组的操作就无法拦截。</li></ul> <h2 id="变化侦测相关api实现"><a href="#变化侦测相关api实现" class="header-anchor">#</a> 变化侦测相关API实现</h2> <h3 id="vm-watch"><a href="#vm-watch" class="header-anchor">#</a> vm.$watch</h3> <p><code>vm.$watch(expOrFn, callback, [options])</code></p> <p><code>expOrFn可以是String|Function</code> <code>callback 是Object|Function</code> <code>options 是 布尔类型的 deep 和 immediate</code></p> <p>返回值是 <code>{Function}</code>  unwatch 可以执行该函数取消watch的观测</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> unwatch <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'a.b.c'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//把watcher实例从正在观察的依赖列表删除</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>当deep 值为 true 时，可以发现对象内部值的变化</p> <p>当immediate值为true时， 立即以当前 a.b.c的值触发回调函数</p> <h3 id="watch内部原理"><a href="#watch内部原理" class="header-anchor">#</a> watch内部原理</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> watcher  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">,</span>expOrFn<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token comment">//执行watcher时，会将自身指向某个值，并主动获取侦测值，触发其get函数，get再将那个值收集起来</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> watcher<span class="token punctuation">.</span>value<span class="token punctuation">)</span>	<span class="token comment">//watcher.value 为侦测对象值-=</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 因为expOrFn还支持函数，watcher 要判断是否为函数，是无需解析其路径，只需将函数赋值给getter</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>当某个组件模板要用到哪个数据时，就会生成 一个<code>watch</code>（） 订阅者，并被收集在侦测对象的依赖列表里面
想要执行unwatch取消侦测，就需要知道自己侦测了哪些数据，<font color="orange">因此需要在订阅者中存储自己观测了哪些数据</font></p> <h4 id="具体实现"><a href="#具体实现" class="header-anchor">#</a> 具体实现</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span>vm<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>depIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">//生成一个有序不重复集合</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>cb <span class="token operator">=</span> cb
		<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">addDep</span><span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//参数为 侦测对象的依赖数组</span>
        <span class="token keyword">const</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id		<span class="token comment">//获取侦测对象数组ID</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>			<span class="token comment">//判断自身是否已被添加到侦测对象依赖数组中</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>			<span class="token comment">//没有则添加自身ID到其依赖ID数组中</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>		 <span class="token comment">//添加自身到其依赖数组中</span>
			dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>			
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="vm-set"><a href="#vm-set" class="header-anchor">#</a> <code>vm.$set</code></h3> <h4 id="参数"><a href="#参数" class="header-anchor">#</a> 参数</h4> <ul><li><code>{Object | Array} targert</code></li> <li><code>{String| number} key</code></li> <li><code>{any} value</code></li></ul> <h4 id="返回值"><a href="#返回值" class="header-anchor">#</a> 返回值</h4> <p><code>{Function} unwatch</code></p> <h4 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h4> <p>在object 上设置一个属性，如果 object是响应式的，Vue.js 会保证属性被创建后也是响应式的，并且触发视图更新。这个方法主要用来避开Vue.js<font color="orange">不能侦测属性被添加的限制。</font>（即避免新属性被添加检测不到）</p> <h4 id="修改dep类"><a href="#修改dep类" class="header-anchor">#</a> 修改Dep类</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> uid <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Dep</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> uid<span class="token operator">++</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token function">depned</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>	
            window<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>	<span class="token comment">//新增将对象依赖添加到watch的消息中</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="taerdown-函数"><a href="#taerdown-函数" class="header-anchor">#</a> <code>taerdown</code> 函数</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length	<span class="token comment">//获取拥有此watch的依赖数组数目</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>				   
        <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>		<span class="token comment">//将每一个有次watch依赖数组的中删去watch</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token comment">//Dep 的removeSub 方法</span>
<span class="token function">removeSub</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>	<span class="token comment">//获取依赖数组目的watch的索引</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//删除</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="deep参数原理"><a href="#deep参数原理" class="header-anchor">#</a> deep参数原理</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 如果deep值为true</span>
<span class="token comment">// 在设置window.target = undefined 前执行 traverse函数</span>
<span class="token comment">// 递归所有子值触发其收集依赖的功能</span>
<span class="token keyword">const</span> seenObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">traverse</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//侦测对象值</span>
    <span class="token function">_traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> seenObjects<span class="token punctuation">)</span>	
    seenObjects<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">_traverse</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> seen</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> keys
    <span class="token keyword">const</span> isA <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>		
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>isA<span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">||</span>Object<span class="token punctuation">.</span><span class="token function">isFrozen</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token comment">//值不是数组且不是对象或者对象被冻结，返回</span>
    <span class="token comment">//说明侦测值只是一个属性，无需操作或者无法对侦测进行操作</span>
    <span class="token comment">//以下是侦测对象是数组或者对象的情况</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span>__ob__<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果是数组对象且有__ob__</span>
		<span class="token keyword">const</span> depId <span class="token operator">=</span> val<span class="token punctuation">.</span>__ob__<span class="token punctuation">.</span>dep<span class="token punctuation">.</span>id <span class="token comment">//拿到这个侦测值的依赖ID</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>depId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> 		<span class="token comment">//如果seen还没添加此ID，添加</span>
        seen<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>depId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>isA<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果侦测值是数组，对数组每个元素递归往seenObjects添加依赖ID</span>
		i <span class="token operator">=</span> val<span class="token punctuation">.</span>length
         <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token function">_traverse</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>	<span class="token comment">//如果不是数组，读取对象上的每一个属性，递归往seenObjects添加依赖数组ID</span>
        i<span class="token operator">=</span>keys<span class="token punctuation">.</span>length
        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">_traverse</span><span class="token punctuation">(</span>val<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> seen<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="vm-set-2"><a href="#vm-set-2" class="header-anchor">#</a> vm.$set</h3> <ul><li><p>用法</p> <p><code>vm.$set(target, key, value)</code></p></li> <li><p>参数
<code>{Object | Array} target</code> <code>{string| number} key</code> <code>{any} value</code></p></li> <li><p>返回值：<code>{Function} unwatch</code></p></li> <li><p>用法：在 object 上设置一个属性，如果 object是响应式的，Vue.js会保证属性被创建后也是响应式的，并且触发视图更新。<font color="orange">这个方法主要用来避开Vue.js不能侦测属性被添加的限制。</font></p></li></ul> <h4 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//检测target是否为数组</span>
		target<span class="token punctuation">.</span>length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>length<span class="token punctuation">,</span>key<span class="token punctuation">)</span>		<span class="token comment">//设置数组长度</span>
		target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>val<span class="token punctuation">)</span>					<span class="token comment">//通过splice方法添加属性可将新增属性可被拦截器侦测到</span>
		<span class="token keyword">return</span> val 	 
	<span class="token punctuation">}</span>
    <span class="token comment">// 目标对象不是数组，属性已存在且但不在Object原型上</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> target <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val	<span class="token comment">//直接修改，因为此属性已被侦测</span>
        <span class="token keyword">return</span> val
    <span class="token punctuation">}</span>
    <span class="token comment">//处理新增属性</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__
    <span class="token comment">//target不能是Vue.js实例或者根数据（vue.$data）</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> &quot; production<span class="token string">' &amp;&amp; warn('</span>Avoid adding reactive properties to a Vue instance or 			its root $data <span class="token string">' +'</span>at runtime <span class="token operator">-</span> declare it upfront <span class="token keyword">in</span> the data option<span class="token punctuation">.</span> '
         <span class="token keyword">return</span> val
    <span class="token punctuation">}</span>
    <span class="token comment">//如果target不是响应式对象，其新添加的属性也无需是响应式，普通添加新属性就行</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span><span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
        <span class="token keyword">return</span> val
    <span class="token punctuation">}</span>
    <span class="token comment">//通过defineReactive 设置属性为响应式</span>
    <span class="token function">defineReactive</span><span class="token punctuation">(</span>ob<span class="token punctuation">.</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">//通知相关依赖进行视图更新</span>
    <span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="vm-delete"><a href="#vm-delete" class="header-anchor">#</a> vm.$delete</h3> <ul><li>用法：<code>vm.$delete(target, key)</code></li> <li>参数：
<code>{Object | Array} target</code> <code>{String| number} key/index</code></li> <li>用法：删除对象的属性。<font color="pink">如果对象是响应式的，需要确保删除能触发更新视图</font>。这个方法主要用于<font color="orange">避开Vue.,js不能检测到属性被删除的限制，但是你应该很少会使用它。</font></li></ul> <h4 id="手动删除属性发通知"><a href="#手动删除属性发通知" class="header-anchor">#</a> 手动删除属性发通知</h4> <p><code>delete this.obj.name</code> <code>this.obj.__ob__dep.notify()</code>	手动发送依赖</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">del</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">isValidArrayIndex</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//检测target是否为数组</span>
		target<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>					<span class="token comment">//通过splice方法删除属性可将属性可被拦截器侦测到</span>
		<span class="token keyword">return</span> val 	 
	<span class="token punctuation">}</span>
    <span class="token keyword">const</span> ob <span class="token operator">=</span> target<span class="token punctuation">.</span>__ob__
    <span class="token keyword">if</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>_isVue <span class="token operator">||</span> <span class="token punctuation">(</span>ob <span class="token operator">&amp;&amp;</span> ob<span class="token punctuation">.</span>vmCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//不能删除vue实例或根数据属性</span>
         process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> &quot; production<span class="token string">' &amp;&amp; warn('</span>Avoid <span class="token keyword">delete</span> reactive properties to a Vue instance or 			its root $data <span class="token string">' +'</span>at runtime <span class="token operator">-</span> declare it upfront <span class="token keyword">in</span> the data option<span class="token punctuation">.</span> '
         <span class="token keyword">return</span> val
    <span class="token punctuation">}</span>
    <span class="token comment">//判断key是否是target（数组）的自身属性，不是终止返回</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">delete</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> 	<span class="token comment">//删除属性</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ob<span class="token punctuation">)</span><span class="token punctuation">{</span>		   <span class="token comment">//判断是否是响应式数据，不是终止程序</span>
		<span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    ob<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//是响应数据，删除后发送通知变化</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="虚拟dom"><a href="#虚拟dom" class="header-anchor">#</a> 虚拟DOM</h2> <p>现在，我们使用的三大主流框架Vue.js、Angular和 React都是声明式操作DOM。我们通过描述状态和DOM之间的映射关系是怎样的，就可以将状态渲染成视图。关于状态到视图的转换过程，框架会帮我们做，不需要我们自己手动去操作DOM。</p> <p>状态可以是JavaScript中的任意类型。0bject、Array、String、Number、Boolean等都可以作为状态，这些状态可能最终会以段落、表单、链接或按钮等元素呈现在用户界面上，具体地说是旱现在而面上。</p> <p>将状态作为输入，并生成DOM输出到页面上显示，这个过程叫渲染
<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210906143822110.png" alt="image-20210906143822110" style="zoom:67%;"></p> <p>通常程序在运行时，状态会不断发生变化(引起状态变化的原因有很多，有可能是用户点击了某个按钮，也可能是某个Ajax 请求，这些行为都是异步发生的。理论上，所有异步行为都有可能引起状态变化)。每当状态发生变化时，都需要重新渲染。</p> <p>因为状态变化影响的只是部分DOM，为了尽可能节省性能，需要确认具体需要访问修改哪些DOM，只更新与状态变化有关的节点</p> <h3 id="为什么引入虚拟dom"><a href="#为什么引入虚拟dom" class="header-anchor">#</a> 为什么引入虚拟DOM</h3> <p>在Angular 和 React的变化侦测中，它们都不知道哪些状态变了，React通过比较虚拟DOM， Angular通过脏检查</p> <p>而在Vue.js1.0中，通过更细粒度的绑定来更新视图，当一个状态变化时，Vue一定程度知道哪些节点使用了该状态需要更新，而无需对比。</p> <p>Vue.js 2.0开始选择了一个中等粒度的解决方案，那就是引入了虚拟DOM。<font color="orange">组件级别是一个watcher实例，</font>就是说即便一个组件内有10个节点使用了某个状态，但其实也只有一个watcher在观察这个状态的变化。所以当这个<font color="orange">状态发生变化时，只能通知到组件，然后组件内部通过虚拟DOM去进行比对与渲染。</font>这是一个比较折中的方案。</p> <p>Vue.js之所以能随意调整绑定的粒度，本质上还要归功于变化侦测。</p> <h3 id="vue-js的虚拟dom"><a href="#vue-js的虚拟dom" class="header-anchor">#</a> Vue.js的虚拟DOM</h3> <p>在Vue.js中，我们使用模板（template）来描述状态与DOM之间的映射关系。<font color="orange">Vue.js通过编译将模板转换成渲染函数(render )，执行渲染函数就可以得到一个虚拟节点树</font>，使用这个虚拟节点树就可以渲染页面，具体如图所示。</p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210906144931077.png" alt="image-20210906144931077" style="zoom:80%;"> <p>因为DOM操作比较慢，避免无必要的DOM操作可以节省很多性能，为了避免不必要的 DOM操作，虚拟DOM在虚拟节点映射到视图的过程中，将虚拟节点与上一次渲染视图所使用的旧虚拟节点( oldVnode )做对比,找出真正需要更新的节点来进行DOM操作，从而避免操作其他无任何改动的 DOM。<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210906150729434.png" alt="image-20210906150729434" style="zoom:80%;"></p> <p>vnode在JavaScript中就是一个普通的对象，对象属性上保存了DOM节点所需的数据，虚拟节点比较算法（patch）是核心算法</p> <h3 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h3> <p>虚拟DOM是将状态映射成视图的众多解决方案中的一种，它的运作原理是使用状态生成虚拟节点，然后使用虚拟节点渲染视图。</p> <p>之所以需要先使用状态生成虚拟节点，是因为如果<font color="orange">直接用状态生成真实DOM，会有一定程度的性能浪费</font>。而<font color="pink">先创建虚拟节点再渲染视图，就可以将虚拟节点缓存，然后使用新创建的虚拟节点和上一次渲染时缓存的虚拟节点进行对比，然后根据对比结果只更新需要更新的真实DOM节点，从而避免不必要的DOM操作，节省一定的性能开销。</font></p> <p>由于Vue.js 的变化侦测粒度更细，所以当状态发生变化时，Vue.js知道的信息更多，一定程度上可以知道哪些位置使用了状态。因此，Vue.js可以通过细粒度的绑定来更新视图，Vue.js 1.0就是这样实现的。</p> <p>但是这样做也有一定的代价。因为粒度太细，就会有很多watcher同时观察某些状态，会有一些内存开销以及一些依赖追踪的开销，所以Vue.js 2.0采取了一个中等粒度的解决方案，<font color="orange">状态侦测不再细化到某个具体节点，而是某个组件，组件内部通过虚拟DOM来渲染视图</font>，这可以大大缩减依赖数量和 watcher数量。</p> <p><font color="orange">Vue.,js中通过模板来描述状态与视图之间的映射关系，所以它会先将模板编译成渲染函数，然后执行渲染函数生成虚拟节点，最后使用虚拟节点更新视图。</font></p> <p>因此,虚拟DOM在Vue.js中所做的事是提供虚拟节点 vnode和对新旧两个vnode进行比对，并根据比对结果进行DOM操作来更新视图。</p> <h2 id="vnode"><a href="#vnode" class="header-anchor">#</a> VNode</h2> <p>节点描述对象</p> <p>在Vue.js 中存在一个VNode类，使用它可以实例化不同类型的vnode实例，而不同类型的vnode实例各自表示不同类型的DOM元素。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">vNode</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span>children<span class="token punctuation">,</span>text<span class="token punctuation">,</span>elm，context，componentOptions<span class="token punctuation">,</span>asyncFactory</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag
        <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data
        <span class="token keyword">this</span><span class="token punctuation">.</span>children <span class="token operator">=</span> childrenthis<span class="token punctuation">.</span>text <span class="token operator">=</span> text
        <span class="token keyword">this</span><span class="token punctuation">.</span>elm <span class="token operator">=</span> elm
        <span class="token keyword">this</span><span class="token punctuation">.</span>ns <span class="token operator">=</span> undefinedthis<span class="token punctuation">.</span>context <span class="token operator">=</span> context
        <span class="token keyword">this</span><span class="token punctuation">.</span>functionalContext <span class="token operator">=</span> undefinedthis<span class="token punctuation">.</span>functional0ptions <span class="token operator">=</span> undefinedthis<span class="token punctuation">.</span>functionalscopeId <span class="token operator">=</span> 				    undefinedthis<span class="token punctuation">.</span>key <span class="token operator">=</span> data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>key
        <span class="token keyword">this</span><span class="token punctuation">.</span>componentoptions <span class="token operator">=</span> componentoptionsthis<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isStatic <span class="token operator">=</span> falsethis<span class="token punctuation">.</span>isRootInsert <span class="token operator">=</span> truethis<span class="token punctuation">.</span>isComment <span class="token operator">=</span> falsethis<span class="token punctuation">.</span>isCloned <span class="token operator">=</span> falsethis<span class="token punctuation">.</span>isonce <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>asyncFactory <span class="token operator">=</span> asyncFactorythis<span class="token punctuation">.</span>asyncMeta <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
   <span class="token keyword">get</span> <span class="token function">child</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentInstance
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>简单地说，vnode可以理解成节点描述对象，它描述了应该怎样去创建真实的DOM节点。
<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210906151646725.png" alt="image-20210906151646725" style="zoom:80%;"></p> <p>需要重新渲染视图时，新生成的VNode和上次的缓存的VNode进行比较，基于此修改DOM改变视图</p> <p>当某个状态改变时，通知相关组件，只更新组件内与状态有关的节点</p> <h3 id="vnode类型"><a href="#vnode类型" class="header-anchor">#</a> VNode类型</h3> <h4 id="注释节点"><a href="#注释节点" class="header-anchor">#</a> 注释节点</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token function-variable function">createEmptyVNode</span> <span class="token operator">=</span> <span class="token parameter">text</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	node<span class="token punctuation">.</span>text <span class="token operator">=</span> text
	node<span class="token punctuation">.</span>isComment <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">return</span> node
<span class="token punctuation">}</span>
<span class="token comment">//可以看出，一个注释节点只有两个有效属性——text 和 isComment，其余属性全是默认的undefined或者false。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="文本节点"><a href="#文本节点" class="header-anchor">#</a> 文本节点</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token function">createTextVNode</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//文本节点只有text属性</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="克隆节点"><a href="#克隆节点" class="header-anchor">#</a> 克隆节点</h4> <p>克隆节点是将现有节点的属性复制到新节点中,让新创建的节点和被克隆节点的属性保持一致，从而实现克隆效果。它的作用是<font color="orange">优化静态节点和插槽节点( slot node )。</font>
以静态节点为例，当组件内的某个状态发生变化后，当前组件会通过虚拟DOM重新渲染视图，静态节点因为它的内容不会改变，所以除了首次渲染需要执行渲染函数获取vnode之外，后续更新不需要执行渲染函数重新生成vnode。因此，这时就会使用创建克隆节点的方法将vnode克隆一份,使用克隆节点进行渲染。这样就<font color="orange">不需要重新执行渲染函数生成新的静态节点的vnode,从而提升一定程度的性能</font>。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span><span class="token parameter">vnode<span class="token punctuation">,</span> deep</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//deep为是否克隆目标节点的子节点</span>
	<span class="token keyword">const</span> cloned <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>tag <span class="token operator">...</span><span class="token punctuation">)</span>
    cloned<span class="token punctuation">.</span>ns <span class="token operator">=</span> vnode<span class="token punctuation">.</span>ns 
    <span class="token operator">...</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>deep<span class="token punctuation">)</span><span class="token punctuation">{</span>
		cloned<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token function">cloneVnode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
普通节点和克隆节点的区别是isCloned属性
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="克隆节点-2"><a href="#克隆节点-2" class="header-anchor">#</a> 克隆节点</h4> <h5 id="属性"><a href="#属性" class="header-anchor">#</a> 属性</h5> <ul><li>tag:顾名思义，tag就是一个节点的名称，例如 p、ul、li和 div等。</li> <li>data:该属性包含了一些节点上的数据，比如 attrs、class 和 style等。</li> <li>children:当前节点的子节点列表。</li> <li>context:它是当前组件的Vue.js 实例。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span>VNode<span class="token punctuation">,</span> VNode<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">context</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token string">'p'</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="组件节点"><a href="#组件节点" class="header-anchor">#</a> 组件节点</h4> <h5 id="属性-2"><a href="#属性-2" class="header-anchor">#</a> 属性</h5> <ul><li>componentoptions：顾名思义，<font color="orange">就是组件节点的选项参数，其中包含propsData、tag和children等信息。</font></li> <li>componentInstance：<font color="orange">组件的实例，也是Vue.js的实例。事实上，在Vue.js中，每个组件都是一个Vue.,js 实例。</font></li></ul> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>//一个组件节点
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child</span><span class="token punctuation">&gt;</span></span>
{
	componentInstance:{...},
	componentOptions:{...}
	context:{...},
    data:{..},
    tag:'vue-component-1-child'
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="函数式组件"><a href="#函数式组件" class="header-anchor">#</a> 函数式组件</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>//类似组件式节点
{
	functionContext:{...},
	functionOptions:{...}
	context:{...},
    data:{..},
    tag:'p'
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="总结-4"><a href="#总结-4" class="header-anchor">#</a> 总结</h3> <p>VNode是一个类，可生成不同vnode实例，不同类型vnode表示不同类型的DOM元素
Vnode有多种类型本质是VNode的类实例，<font color="orange">唯一区别是属性不同</font></p> <h2 id="patch算法"><a href="#patch算法" class="header-anchor">#</a> patch算法</h2> <p>patch也可以叫作patching算法，通过它渲染真实DOM时，并不是暴力覆盖原有DOM，而是比对新旧两个vnode之间有哪些不同，然后根据对比结果找出需要更新的节点进行更新。这一点从名字就可以看出，patch本身就有补丁、修补等意思，其实际作用是在现有DOM上进行修改来实现更新视图的目的。</p> <p>DOM操作的速度慢JavaScript的运算速度很多，将DOM操作搬运到JavaScript中，可以显著减少DOM操作，提升性能</p> <h3 id="patch介绍"><a href="#patch介绍" class="header-anchor">#</a> patch介绍</h3> <blockquote><ul><li>创建新增节点</li> <li>删除已废弃节点</li> <li>修改需要更新的节点</li></ul></blockquote> <h4 id="新增节点"><a href="#新增节点" class="header-anchor">#</a> 新增节点</h4> <p>当oldVnode不存在时（首次渲染时），需要使用Vnode创建新节点、新节点和旧节点不是同一个节点时。</p> <p>首次渲染视图时，使用Vnode直接渲染</p> <h4 id="删除节点"><a href="#删除节点" class="header-anchor">#</a> 删除节点</h4> <p>当一个节点只在旧节点存在时，需要将其从DOM中删除</p> <h3 id="更新节点"><a href="#更新节点" class="header-anchor">#</a> 更新节点</h3> <p>当新旧节点是相同节点是，需要对这两个节点进行细致的对比，然后对oldVnode在视图中对应的真实节点进行更新。</p> <h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <p>通过前面的介绍，可以发现整个patch 的过程并不复杂。当oldVnode不存在时，直接使用vnode渲染视图;当oldVnode和 vnode都存在但并不是同一个节点时，使用vnode创建的DOM元素替换旧的 DOM元素;当oldVnode和 vnode是同一个节点时，使用更详细的对比操作对真实的DOM节点进行更新。</p> <h3 id="创建节点"><a href="#创建节点" class="header-anchor">#</a> 创建节点</h3> <p>只有三种节点会被创建并插入到DOM中：元素节点、注释节点、文本节点</p> <p>如果一个节点有tag属性，证明其是元素属性。接着，我们就可以调用当前环境下的createElement方法(在<font color="orange">浏览器环境下就是 document.createElement</font>)来创建真实的元素节点。当一个元素节点被创建后，接下来要做的事情就是<font color="orange">将它插入到指定的父节点</font>中。</p> <p>将元素渲染到视图的过程非常简单。只需要调用当前环境下的 <font color="orange">appendchild</font>方法(在浏览器环境下就是调用parentNode . appendChild )，就可以将一个元素插入到指定的父节点中。<font color="orange">如果这个指定的父节点已经被渲染到视图，那么把元素插入到它的下面将会自动将元素渲染到视图。</font></p> <p>创建节点还需创建其子节点并插入到其下面</p> <p>创建子节点的过程是一个递归过程。vnode 中的 children属性保存了当前节点的所有子虚拟节点( child virtual node )，所以<font color="orange">只需要将vnode中的children属性循环一遍，将每个子虚拟节点都执行一遍创建元素的逻辑，就可以实现我们想要的功能。</font></p> <p>创建子节点时，子节点的父节点就是当前刚创建出来的这个节点，所以子节点被创建后，会被插人到当前节点的下面。当所有子节点都创建完并插入到当前节点中之后，我们把当前节点插人到指定父节点的下面。如果这个指定的父节点已经被渲染到视图中，那么将当前这个节点插入进去之后，会将当前节点（包括其子节点）渲染到视图中。</p> <p>使用虚拟DOM创建真实DOM并渲染到视图的过程<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210910194148625.png" alt="image-20210910194148625" style="zoom:80%;"></p> <p><font color="orange">只有注释节点的isComment属性为true，可以通过该属性判断是否为注释节点</font>
通过调用<code>createTextNode</code>（浏览器下 <code>document.createTextNode</code>）创建注释节点</p> <h3 id="删除节点-2"><a href="#删除节点-2" class="header-anchor">#</a> 删除节点</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">removeVnodes</span><span class="token punctuation">(</span><span class="token parameter">vnodes<span class="token punctuation">,</span> startIdx<span class="token punctuation">,</span> endIdx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> startIdx<span class="token operator">&lt;</span>endIdx<span class="token punctuation">;</span><span class="token operator">++</span>startIdx<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> ch <span class="token operator">=</span> <span class="token function">vnodes</span><span class="token punctuation">(</span>startIdx<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">removeNode</span><span class="token punctuation">(</span>ch<span class="token punctuation">.</span>elm<span class="token punctuation">)</span> <span class="token comment">//删除Vnodes数组指定位置内容</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//对节点操作的封装</span>
<span class="token keyword">const</span> nodeOps <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">removeChild</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> child</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		node<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">const</span> parent <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>	<span class="token comment">//获取要删除节点的父节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> el<span class="token punctuation">)</span>     
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><font color="orange">将节点的操作封装到nodeOps可以应该跨平台渲染的情况，主要是因为不同平台渲染机制不同。</font></p> <h3 id="更新节点-2"><a href="#更新节点-2" class="header-anchor">#</a> 更新节点</h3> <p><font color="orange">更新节点之前，需判断节点是否是静态节点</font></p> <h4 id="静态节点"><a href="#静态节点" class="header-anchor">#</a> 静态节点</h4> <p>静态节点指的是那些一旦渲染到界面上之后，无论日后状态如何变化，都不会发生任何变化的节点。因此无需重新渲染。<code>&lt;p&gt; 我是静态节点&lt;/p&gt;</code></p> <h4 id="新节点具有文本属性"><a href="#新节点具有文本属性" class="header-anchor">#</a> 新节点具有文本属性</h4> <p>如果新生成的虚拟节点具有文本属性，且与旧节点文本不相同，直接调用<code>setTextContent</code>（浏览器环境下是<code>node.setTextContent</code>）方法，否则不需要操作</p> <h4 id="新节点无文本属性"><a href="#新节点无文本属性" class="header-anchor">#</a> 新节点无文本属性</h4> <h5 id="有children情况"><a href="#有children情况" class="header-anchor">#</a> 有children情况</h5> <p><font color="orange">当新节点有children，旧节点也有children时，需对新旧节点进行详细比较更新。当旧节点无children时，要清空旧节点并插入新节点，否则就无需插入新节点。</font></p> <h5 id="无children情况"><a href="#无children情况" class="header-anchor">#</a> 无children情况</h5> <p><font color="pink">看旧节点有没有children或文本，有则删除</font></p> <h3 id="更新策略"><a href="#更新策略" class="header-anchor">#</a> 更新策略</h3> <h4 id="创建子节点"><a href="#创建子节点" class="header-anchor">#</a> 创建子节点</h4> <p>在对比新旧节点时，如果在旧节点没有找到目的节点，说明需要创建新节点，并插入所有未处理旧节点的前面</p> <h5 id="创建的新节点插入所有未处理旧节点前面的原因"><a href="#创建的新节点插入所有未处理旧节点前面的原因" class="header-anchor">#</a> 创建的新节点插入所有未处理旧节点前面的原因</h5> <p><font color="orange">因为对比的是旧节点，如果插入所有已处理的节点后面，可能会位置错误，因为插入的节点是相对于旧节点而言的，新节点的结构可能与旧节点不同。</font></p> <h4 id="更新子节点"><a href="#更新子节点" class="header-anchor">#</a> 更新子节点</h4> <p>新节点除了内容与旧节点不同，可能位置也不同，需要进行移动节点的操作</p> <h4 id="移动子节点"><a href="#移动子节点" class="header-anchor">#</a> 移动子节点</h4> <p>对比新旧节点是通过从左向右循环新节点列表，每循环一个，就去旧节点找到对应的</p> <p>由于新节点的左部分都是处理过的，因此只需在真实DOM中调用<code>Node.insertBefore()</code>将需要移动的节点移动到所有未处理的节点前面就行</p> <h4 id="删除子节点"><a href="#删除子节点" class="header-anchor">#</a> 删除子节点</h4> <p>如果新虚拟节点列表被循环一遍后，旧节点还有剩下的节点，说明这些剩下的节点为需要被废弃删除的节点。</p> <h3 id="优化策略"><a href="#优化策略" class="header-anchor">#</a> 优化策略</h3> <p>通常情况下，并非所有节点都需要移动，总有几个节点位置是固定不变的，这些节点无需循环去找，有更快捷的寻找方式。</p> <p>首先尝试使用相同位置的两个节点对比是否相同，相同直接进行更新，否则再循环旧节点寻找</p> <h5 id="四种查找方式"><a href="#四种查找方式" class="header-anchor">#</a> 四种查找方式</h5> <ul><li>新前与旧前</li> <li>新后与旧后</li> <li>新后与旧前</li> <li>新前与旧后</li></ul> <h5 id="含义-都是基于未处理节点的"><a href="#含义-都是基于未处理节点的" class="header-anchor">#</a> 含义（都是基于未处理节点的）</h5> <ul><li>新前:newChildren中所有未处理的第一个节点。</li> <li>新后:newChildren中所有未处理的最后一个节点。</li> <li>旧前: oldChildren中所有未处理的第一个节点。</li> <li>旧后: oldChildren 中所有未处理的最后一个节点。</li></ul> <h5 id="新前与旧前"><a href="#新前与旧前" class="header-anchor">#</a> 新前与旧前</h5> <p>对比新列表第一个与旧列表第一个，若相同则进行更新，否则尝试下一种方法</p> <h4 id="新后与旧后"><a href="#新后与旧后" class="header-anchor">#</a> 新后与旧后</h4> <p>对比新列表最后一个与旧列表最后一个，若相同则进行更新，否则尝试下一种方法</p> <h5 id="新后与旧前"><a href="#新后与旧前" class="header-anchor">#</a> 新后与旧前</h5> <p>对比<font color="orange">，若相同更新节点并将节点移动到所有未处理节点的最后面</font></p> <h5 id="新前与旧后"><a href="#新前与旧后" class="header-anchor">#</a> 新前与旧后</h5> <p>对比，<font color="orange">若相同更新节点并将其节点移动到所有未处理节点前面</font></p> <p>移动都是基于未处理节点是因为真实DOM可能两侧已经有了处理过的节点，已处理的节点位置都是正确的，只需在未处理的中更改即可。</p> <h3 id="判断未处理的节点"><a href="#判断未处理的节点" class="header-anchor">#</a> 判断未处理的节点</h3> <p>由于优化策略，节点可能从后面开始比较，循环会从两边往中间进行</p> <blockquote><p>需要准备四个变量：<code>oldStartIdx、newStartIdx、oldEndIndx、newEndIdx</code></p> <p>这4个变量分别表示 oldChildren的开始位置的下标( oldstartIdx)和结束位置的下标( oldEndIdx )，以及 newChildren 的开始位置的下标（( newStartIdx)和结束位置的下标( newEndIdx )。
<font color="pink">在循环体内，<u>每处理一个节点，就将下标向指定的方向移动一个位置，</u>通常情况下是对新旧两个节点进行更新操作，就相当于一次性处理两个节点,将新旧两个节点的下标都向指定方向移动一个位置。
开始位置所表示的节点被处理后，就向后移动一个位置;结束位置的节点被处理后，则向前移动一个位置。</font>
也就是说，<font color="orange"><code>oldStartIdx和 newStartIdx</code>只能向后移动，而oldEndIdx和 newEndIdx只能向后移动</font></p></blockquote> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">while</span><span class="token punctuation">(</span>oldStartIdx<span class="token operator">&lt;=</span>oldEndIndx<span class="token operator">&amp;&amp;</span>newStartIdx<span class="token operator">&lt;=</span>newEndIdx<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//do something</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当newChildren或者oldChildren其中一个结束都会结束循环，此循环结束后新节点或旧节点其中一个可能存在未处理的节点</p> <p><font color="orange">如果是新节点先结束循环，说明还剩下的旧节点中未处理的节点是应该被删除的节点</font> <font color="orange">如果是旧节点先结束循环，说明新节点剩下的都是旧节点没有的，需要创建新节点并插入。
新节点未处理的节点在（<code>newStartIndx和oldEndIdx中间</code>）</font></p> <h4 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h4> <p>更新子节点可分为四种操作，分别是：新增子节点、删除子节点、更新子节点、移动子节点。</p> <p>移动节点时，实际移动的是真实的DOM，移动真的的DOM后，为了防止后续重复处理同一个节点，旧的虚拟节点会设为undefined，用来标记这个节点已被处理并移动到其他位置。</p> <p>进入循环具体流程（进入下一步的前提是不符合上一步条件）</p> <ul><li>判断旧前节点是否存在，不存在旧前后移，再次循环</li> <li>判断旧后是否存在，不存在旧后前移，再次循环</li> <li>判断新前和旧前，相同新前和新后都后移，再次循环</li> <li>判断新后和旧后，相同二者前移，再次循环</li> <li>判断旧前和新后，相同将该节点移动到所有未处理后面，再次循环</li> <li>判断旧后和新前，相同将该节点移动到所有未处理前面，再次循环</li> <li>如果四种方式都找不到，建立旧节点索引（如果存在key直接找，否则通过sameVnode找），再循环旧节点去寻找，找不到创建新节点，再次循环</li> <li>找到进行详细比较更新，移动响应是否未处理节点指针</li></ul> <h2 id="第三篇"><a href="#第三篇" class="header-anchor">#</a> 第三篇</h2> <p>在Vue.js内部，模板编译是一项比较重要的技术。我们平时使用Vue.js进行开发时，会经常使用模板。模板赋予我们很多强大的能力，例如可以在模板中访问变量。</p> <p><font color="orange">在Vue.,js 中创建 HTML并不是只有模板这一种途径，我们既可以手动写渲染函数来创建HTML，也可以在Vue.js中使用JSX来创建HTML。</font></p> <p><font color="orange">渲染函数是创建HTML最原始的方法。模板最终会通过编译转换成渲染函数，渲染函数执行后，会得到一份vnode用于虚拟DOM渲染。</font>所以模板编译其实是配合虚拟DOM进行渲染。</p> <h2 id="模板编译"><a href="#模板编译" class="header-anchor">#</a> 模板编译</h2> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210911105817545.png" alt="image-20210911105817545" style="zoom:80%;"> <ul><li>Vue.js提供了模板语法，允许我们<font color="orange">声明式地描述状态和 DOM之间的绑定关系</font>，然后通过模板来生成真实DOM并将其呈现在用户界面上。</li> <li>在底层实现上，Vue.js会将模板编译成虚拟DOM渲染函数。当应用内部的状态发生变化时,<font color="orange"></font></li> <li><code>Vue.js</code>可以<font color="orange">结合响应式系统，聪明地找出最小数量的组件进行重新渲染以及最少量地进行DOM操作。</font></li></ul> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p><font color="orange">模板编译的主要目的就是生成渲染函数，执行渲染函数会根据当前状态生成新的虚拟节点</font></p> <h3 id="模板编译成渲染函数"><a href="#模板编译成渲染函数" class="header-anchor">#</a> 模板编译成渲染函数</h3> <p>将模板编译成渲染函数可以分两个步骤，<font color="orange">先将模板解析成AST ( Abstract Syntax Tree，抽象语法树)，然后再使用AST生成渲染函数。</font>
但是<font color="orange">由于静态节点不需要总是重新渲染，所以在生成AST之后、生成渲染函数之前这个阶段，需要做一个操作，那就是遍历一遍AST，给所有静态节点做一个标记</font>，这样在虚拟DOM中更新节点时，如果发现节点有这个标记，就不会重新渲染它。</p> <p>大体上，模板编译分成以下3步骤</p> <ul><li>将模板解析为AST</li> <li>遍历AST标记静态节点</li> <li>使用AST生成渲染函数</li></ul> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210911111545114.png" alt="image-20210911111545114" style="zoom:80%;"> <h4 id="解析器"><a href="#解析器" class="header-anchor">#</a> 解析器</h4> <p>作用：将模板解析成AST（抽象语法树）</p> <p>在解析器内部，分成了很多小解析器，其中包括过滤器解析器、文本解析器和 HTML解析器。然后通过一条主线将这些解析器组装在一起<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210911114526163.png" alt="image-20210911114526163" style="zoom:60%;"></p> <p>使用模板时，使用的过滤器便是通过过滤解析器解析的</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>{{ temp | formatter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><font color="orange">文本解析器用于解析带变量的文本，纯文本无需文本解析器来解析</font> <code>Hello </code></p> <h5 id="html解析器"><a href="#html解析器" class="header-anchor">#</a> HTML解析器</h5> <p>HTML解析器是解析器中最核心的模块，它的作用就是解析模板,每当解析到HTML标签的开始位置、结束位置、文本或者注释时，都会触发钩子函数，然后将相关信息通过参数传递出来。</p> <p><font color="orange">主线上做的事就是监听HTML解析器。每当触发钩子函数时，就生成一个对应的AST节点。</font>生成AST前，会<font color="orange">根据类型使用不同的方式生成不同的AST</font>。例如，如果是文本节点，就生成文本类型的AST。</p> <p><font color="orange">AST其实和 vnode有点类似，都是使用JavaScript中的对象来表示节点。</font></p> <p>当HTML解析器把所有模板都解析完，AST也生成好了</p> <h4 id="优化器"><a href="#优化器" class="header-anchor">#</a> 优化器</h4> <p>当AST 中的静态子树被打上标记后，<font color="orange">每次重新渲染时，就不需要为打上标记的静态节点创建新的虚拟节点</font>，而是<font color="orange">直接克隆已存在的虚拟节点</font>。在虚拟DOM的更新操作中，如果发现两个节点是同一个节点，正常情况下会对这两个节点进行更新，但是如果这两个节点是静态节点，则可以直接跳过更新节点的流程。
总体来说，<font color="orange">优化器的主要作用是避免一些无用功来提升性能</font>。因为静态节点除了首次渲染,后续不需要任何重新渲染操作。</p> <h4 id="代码生成器"><a href="#代码生成器" class="header-anchor">#</a> 代码生成器</h4> <p>将抽象语法树（AST）转换成渲染函数的内容，‘代码字符串’</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jack<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
`with(this){
	return _c{
		'p',						  //标签名
        {
			attrs:{'title:':'jack'},	//属性
			on:{'click':c}			   //实际
        },
	    [_v(&quot;1&quot;)]	//标签包裹内容
	}
}`

例子
const code = `with(this){return 'hello 'jack'}`
const hello = new Function(code)
hello()  // hello jack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>渲染函数的作用是创建vnode。渲染函数之所以可以生成vnode，是因为代码字符串中会有很多函数调用（例如，上面生成的代码字符串中有两个函数调用<code>_c</code>和<code>_v</code>)，这些函数是虚拟DOM提供的创建vnode的方法。vnode有很多种类型，<font color="orange">不同的类型对应不同的创建方法</font>,所以代码字符串中的<code>_c</code>和<code>_v</code>其实都是创建vnode的方法,只是创建的vnode的类型不同。例如，<font color="orange"><code>_c</code>可以创建元素类型的vnode</font>，而<font color="orange"><code>_v</code>可以创建文本类型的vnode。</font></p> <h2 id="解析器-2"><a href="#解析器-2" class="header-anchor">#</a> 解析器</h2> <h3 id="解析器的作用"><a href="#解析器的作用" class="header-anchor">#</a> 解析器的作用</h3> <p>解析模板生成AST</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
转化成AST
{
    tag: &quot;div&quot;,
	type: 1,
    staticRoot: false,static: false,plain: true,
    parent: undefined,
    attrsList: []，
    attrsMap: i
}，
    children: [
		{
                tag: &quot;p&quot;type: 1,
                staticRoot: false,static: false,plain: true,
                parent: {tag: &quot;div&quot;, ...},
                attrsList: [],
                attrsMap: {},
                children:[{type: 2,
                text: &quot;i{name}}&quot;,
                static: false,
                expression: &quot;_s(name)&quot;
			 }]
		}
	]
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>AST只是用JavaScript中的对象来描述一个节点，一个对象表示一个节点，对象中的属性用来保存节点所需的各种数据。比如,parent属性保存了父节点的描述对象，<font color="orange">children属性是一个数组，里面保存了一些子节点的描述对象</font>。再比如，<font color="orange">type属性表示一个节点的类型等</font>。当很多个独立的节点通过parent属性和children属性连在一起时，就变成了一个树，而这样一个用对象描述的节点树其实就是AST。</p> <h3 id="解析器内部原理"><a href="#解析器内部原理" class="header-anchor">#</a> 解析器内部原理</h3> <p>解析器内部也分了好几个子解析器，比如 <font color="orange">HTML解析器、文本解析器以及过滤器解析器</font>，其中最主要的是HTML解析器。顾名思义，HTML解析器的作用是解析HTML，它在<font color="orange">解析HTML的过程中会不断触发各种钩子函数。这些钩子函数包括开始标签钩子函数、结束标签钩子函数、文本钩子函数以及注释钩子函数。</font></p> <p>伪代码</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>	<span class="token comment">//解析到开始标签触发</span>
    <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>				   <span class="token comment">//解析到结束标签触发</span>
    <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>			   <span class="token comment">//解析到文本触发</span>
    <span class="token function">comment</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>				<span class="token comment">//解析到注释触发</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>解析器在钩子函数中建立AST节点，遇到不同类型模板内容，建立不同节点数，</p> <p>钩子函数<code>start</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
        tag<span class="token punctuation">,</span>
        <span class="token literal-property property">attrsList</span><span class="token operator">:</span>attrs<span class="token punctuation">,</span>
        parent<span class="token punctuation">,</span>
        <span class="token literal-property property">children</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> unary</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//unary 说明标签是否属于自闭合标签</span>
        <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token function">createASTElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> currentParent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>钩子函数 <code>chars</code>和<code>comment</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> text<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token function">comment</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> <span class="token literal-property property">isComment</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ul><li>构建AST层级关系其实非常简单，我们只需要维护一个栈( stack )即可，用栈来记录层级关系，这个层级关系也可以理解为DOM的深度。</li> <li>HTML解析器在解析HTML时，是从前向后解析。每当遇到开始标签,就触发钩子函数start。每当遇到结束标签，就会触发钩子函数end。</li> <li>基于HTML解析器的逻辑，我们可以在每次触发钩子函数 start时，把当前构建的节点推入栈中;每当触发钩子函数end 时，就从栈中弹出一个节点。</li></ul> <h3 id="html解析器-2"><a href="#html解析器-2" class="header-anchor">#</a> HTML解析器</h3> <h4 id="运行原理"><a href="#运行原理" class="header-anchor">#</a> 运行原理</h4> <p>事实上，解析HTML模板的过程就是循环的过程，简单来说就是用HTML模板字符串来循环，每轮循环都从HTML模板中截取一小段字符串，然后重复以上过程，直到HTML模板被截成一个空字符串时结束循环，解析完毕
在截取一小段字符串时，有可能截取到开始标签，也有可能截取到结束标签，又或者是文本或者注释，我们可以<font color="orange">根据截取的字符串的类型来触发不同的钩子函数</font>。（通过正则表达式判断）</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//截取字符串模板并触发options上的钩子函数}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="被截取的片段分为以下类型"><a href="#被截取的片段分为以下类型" class="header-anchor">#</a> 被截取的片段分为以下类型</h5> <ul><li><p>开始标签，例如</p><div>。结束标签，例如</div>。<p></p></li> <li><p>HTML注释，例如。</p></li> <li><p>DOCTYPE，例如&lt;! DOCTYPE html&gt;。</p></li> <li><p>条件注释，例如我是注释&lt;! --&lt;! [endif]--&gt;。</p></li> <li><p>文本，例如我是Berwin。</p></li> <li><p>通常，最常见的是开始标签、结束标签、文本以及注释。</p></li></ul> <h4 id="截取开始标签"><a href="#截取开始标签" class="header-anchor">#</a> 截取开始标签</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>var ncname = '[a-zA-Z_][\\w\\-\\.]*';
var qnameCapture = '((?:' + ncname + '\\:)?' + ncname + ')';
var startTagOpen = new RegExp('^&lt;' + qnameCapture);

const start = '<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>.match(startTagOpen)'
console.log(start) 	//['<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>', 'div', index:0, input:&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>&quot;]
if(start){
	const match = {
		tagName:start[1],
		attrs:[]
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h4 id="解析标签属性"><a href="#解析标签属性" class="header-anchor">#</a> 解析标签属性</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>const atartTagClose = /^\s*(\/?)/		// 匹配标签结尾
const attribute = 
let html = 'class=&quot;box&quot; id=&quot;el&quot;&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>'
let end ,attr
const match = {tagName:'div', attrs:[]}
while(!(end =html.match(startTagClose))&amp;&amp;(attr=html.match(attribute))){
	html=html.substring(attr[0].length)	//截取匹配的标签部分
	match.attrs.push(attr)		//将匹配的标签加入到attrs中
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>如果剩余HTML模板不符合开始标签结尾部分的特征，并且具有标签属性特征，进入到循环中进行解析和截取。</p> <h4 id="自闭合标识"><a href="#自闭合标识" class="header-anchor">#</a> 自闭合标识</h4> <p><font color="orange">自闭合标签是没有总结点的，因此无需将其加入到栈中</font></p> <p>例如：<code>&lt;input type=&quot;text&quot; /&gt;</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseStartTagEnd</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)</span><span class="token regex-delimiter">/</span></span>	
    <span class="token keyword">const</span> end <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>
        match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>	<span class="token comment">//截去自闭合的/</span>
        <span class="token keyword">return</span> match	<span class="token comment">//放回自闭合标识</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'/&gt;'</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//[&quot;/&quot;, &quot;/&quot;, index: 0, input: &quot;/&gt;&quot;,groups: undefined]</span>
consolo<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">parseStartTagEnd</span><span class="token punctuation">(</span><span class="token string">'&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">//{unarySlash:&quot;&quot;}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">parseStartTagEnd</span><span class="token punctuation">(</span><span class="token string">'/&gt;&lt;div&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//{unarySlash:'/'}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><font color="orange">从代码中打印出来的结果可以看到，自闭合标签解析后的unarySlash属性为/，而非自闭合标签为空字符串。</font></p> <h4 id="实现源码"><a href="#实现源码" class="header-anchor">#</a> 实现源码</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ncname <span class="token operator">=</span> <span class="token string">'[a-zA-Z_][\\w\\-\\.]*'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token string">'((?:'</span> <span class="token operator">+</span> ncname <span class="token operator">+</span> <span class="token string">'\\:)?'</span> <span class="token operator">+</span> ncname <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> startTagOpen <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token string">'^&lt;'</span> <span class="token operator">+</span> qnameCapture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> startTagClose <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\s*(\/?)</span><span class="token regex-delimiter">/</span></span>	
<span class="token keyword">function</span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    html<span class="token operator">=</span>html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment">//用来截取已处理的模板</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span>html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagOpen<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> match <span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token literal-property property">tagName</span><span class="token operator">:</span>start<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">advance</span><span class="token punctuation">(</span>start<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lengtg<span class="token punctuation">)</span>
    <span class="token comment">//解析标签属性</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>end<span class="token operator">=</span>html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>startTagClose<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>attr <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>attribute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>attr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
        mathc<span class="token punctuation">.</span>attrs<span class="token operator">/</span><span class="token function">push</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token comment">//此循环结束后，标签上的属性已全部加入到match的attrs上</span>
    <span class="token comment">//最后判断是否是自闭合标签</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">{</span>
        match<span class="token punctuation">.</span>unarySlash <span class="token operator">=</span> end<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>	<span class="token comment">//在match属性上加上是否是自闭合标志</span>
        <span class="token function">advance</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>		<span class="token comment">//截取自闭合标志</span>
        <span class="token keyword">return</span> match	<span class="token comment">//返回</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 此代码的HTML的变量是HTML模板</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>调用<code>parseStartTag</code>，如果没有返回值，说明HTML模板的开始部分不符合开始标签的正则规则，返回<code>undefined</code>，如果符合，取出解析结果（<font color="orange">就是截取出的模板</font>），并调用钩子函数<code>start</code></p> <h4 id="截取结束标签"><a href="#截取结束标签" class="header-anchor">#</a> 截取结束标签</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> ncnamae <span class="token operator">=</span> <span class="token string">'[z-zA-Z_][\\w\\-\\.]*'</span>
<span class="token keyword">const</span> qnameCapture <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\\:)?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ncname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> endTag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">^&lt;\\/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>qnameCapture<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">[^&gt;]*&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token comment">//以上是 结束标签的正则</span>
<span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
    html<span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment">//触发钩子函数，传入结束标签名</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="截取注释"><a href="#截取注释" class="header-anchor">#</a> 截取注释</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!--</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">if</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>			<span class="token comment">//判断是否符合注释开始</span>
    <span class="token keyword">const</span> commentEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'--&gt;'</span><span class="token punctuation">)</span>	<span class="token comment">//寻找注释结束</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>commentEnd<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果存在</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>shouldKeepComment<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//判断是否需要触发钩子函数</span>
            options<span class="token punctuation">.</span><span class="token function">comment</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> commentEnd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//截取注释内容到钩子函数</span>
        <span class="token punctuation">}</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>commentEnd<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>	<span class="token comment">//截取调整个注释返回后面的内容</span>
        <span class="token keyword">continue</span>	
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="截取条件注释"><a href="#截取条件注释" class="header-anchor">#</a> 截取条件注释</h4> <p>条件注释不需要触发钩子函数，我们只需要把它截取掉就行了。
截取条件注释的原理与截取注释非常相似，如果模板的第一个字符是&lt;，并且符合我们事先用正则表达式定义好的规则，就说明需要进行条件注释的截取操作。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> conditionalComment <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!\[</span><span class="token regex-delimiter">/</span></span>		<span class="token comment">//匹配 &lt;![</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>conditionalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> conditionalEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">']&gt;'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>conditionalEnd<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>conditionalEnd<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//如果let html = '&lt;![if !IE]&gt;&lt;link href=&quot;non-ie.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;! [endif]&gt; '</span>
<span class="token comment">//执行console.log(html) &lt;link href=&quot;non-ie.css&quot; rel=&quot;stylesheet&quot;&gt;&lt; ! [endif]&gt;'</span>
通过这个逻辑可以发现，在Vue<span class="token punctuation">.</span>js中条件注释其实没有用，写了也会被截取掉，通俗一点说就是写了也白写。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="截取doctypehtml-文档说明"><a href="#截取doctypehtml-文档说明" class="header-anchor">#</a> 截取DOCTYPE	html 文档说明</h4> <p><font color="orange">无需触发钩子函数</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> doctype <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&lt;!DOCTYPE[^&gt;]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span>
<span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
    html<span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">continue</span>
<span class="token punctuation">}</span>
<span class="token comment">// 只需截取整个DOCTYPE标签</span>
<span class="token comment">//let html = '&lt;IDOCTYPE html&gt;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;'</span>
<span class="token comment">//console.log(html) &lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="截取文本"><a href="#截取文本" class="header-anchor">#</a> 截取文本</h4> <p><font color="orange">在前面的其他标签类型中，我们都会判断剩余HTML模板的第一个字符是否是&lt;，如果是，再进一步确认到底是哪种类型。这是因为以&lt;开头的标签类型太多了，如开始标签、结束标签和注释等。然而文本只有一种，如果HTML模板的第一个字符不是&lt;，那么它一定是文本了。</font></p> <p>文本可能存在 &lt;、\、&gt;等特殊符号，需要进行如下判断处理</p> <ul><li>截取到遇到的&lt;之前内容后，剩余部分是开始标签吗</li> <li>符合结束标签特征吗</li> <li>符合注释特征吗</li> <li>都不符合说明还是文本，因此继续找到&lt;，将之前的加入到文本内容中,重复此操作</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//伪代码</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> text<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> next
    <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>
    <span class="token comment">//截取文本</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>textEnd<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>		<span class="token comment">//返回&lt;的后续模板</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>
        	<span class="token operator">!</span>endTag<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>			<span class="token comment">//结束标签</span>
            <span class="token operator">!</span><span class="token function">startTagOpen</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>			<span class="token comment">//开始标签	</span>
            <span class="token operator">!</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>			<span class="token comment">//注释</span>
            <span class="token operator">!</span>conditonalComment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>rest<span class="token punctuation">)</span>	<span class="token comment">//条件注释</span>
        <span class="token punctuation">)</span><span class="token punctuation">{</span>
            next <span class="token operator">=</span> rest<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>		<span class="token comment">//寻找下一个 &lt;的位置</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>next<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">break</span>				<span class="token comment">//如果不存在下一个&lt;，结束循环</span>
            textEnd <span class="token operator">+=</span>next				<span class="token comment">//如果存在，返回下一个&lt;索引</span>
            rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>	 <span class="token comment">//截取剩余内容</span>
        <span class="token punctuation">}</span>	
        text <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>textEnd<span class="token punctuation">)</span>	<span class="token comment">//至此，textEnd为最后一个文本索引</span>
        html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>		<span class="token comment">//截取掉文本内容</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果模板找不到&lt;,说明整个模板都是文本</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>textEnd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>			<span class="token comment">//将文本加入text并清空模板</span>
		text <span class="token operator">=</span> html
         html <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars <span class="token operator">&amp;&amp;</span> text<span class="token punctuation">)</span><span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>		<span class="token comment">//触发钩子函数</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="纯文本内容处理"><a href="#纯文本内容处理" class="header-anchor">#</a> 纯文本内容处理</h4> <p><code>script、style和textarea</code>这三种元素叫作纯文本内容元素。解析它们的时候,会把这三种标签内包含的所有内容都当作文本处理。
前面介绍开始标签、结束标签、文本、注释的截取时，其实都是默认当前需要截取的元素的父级元素不是纯文本内容元素。事实上，如果要截取元素的父级元素是纯文本内容元素的话，处理逻辑将完全不一样。
事实上，在 while循环中，最外层的判断条件就是父级元素是不是纯文本内容元素。例如下面的伪代码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lsatTag <span class="token operator">||</span> <span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//父元素为正常元素		lastTag用于判断父元素是否为纯文本标签</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">//父元素为script、texterea、style</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//在上面的代码中，lastTag 表示父元素。可以看到，在while中，首先进行判断，如果父元素不存在或者不是纯文本内容元素，那么进行正常的处理逻辑，也就是前面介绍的逻辑。</span>

<span class="token comment">//而当父元素是 script这种纯文本内容元素时，会进入到else这个语句里面。由于纯文本内容元素都被视作文本处理，所以我们的处理逻辑就变得很简单，只需要把这些文本截取出来并触发钩子函数chars，然后再将结束标签截取出来并触发钩子函数end。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//整体流程</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lsatTag <span class="token operator">||</span> <span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//父元素为正常元素</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> stackedTag <span class="token operator">=</span> lastTag<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> reStackedTag <span class="token operator">=</span> reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>reCache<span class="token punctuation">[</span>stackedTag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> 				<span class="token class-name">RegExp</span><span class="token punctuation">(</span> <span class="token string">' ([ls\IS]*?)(&lt;/'</span> <span class="token operator">+</span> stackedTag <span class="token operator">+</span> <span class="token string">'[^&gt;]*&gt;)'</span><span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">//用空字符替换html中所有父元素为纯文本内容</span>
        <span class="token keyword">const</span> rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reStackedTag<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">all<span class="token punctuation">,</span> text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars<span class="token punctuation">)</span><span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token comment">//text为纯文本内容还有其父元素</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token string">''</span>	<span class="token comment">//用空字符串替换reStackedTag</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        html <span class="token operator">=</span> rest
        options<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>stackedTag<span class="token punctuation">)</span>	<span class="token comment">//纯文本标签名 </span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
//chars(text)
//end(script)
//最后剩余 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="使用栈维护dom层级"><a href="#使用栈维护dom层级" class="header-anchor">#</a> 使用栈维护DOM层级</h4> <p><font color="orange">栈可以用于检查标签是否闭合，每找到一个结束标签，会从栈顶找对应起始标签，找不到从栈顶往·栈底找，会发现之前的标签都未闭合，因此控制台报错。</font></p> <h4 id="整体逻辑114"><a href="#整体逻辑114" class="header-anchor">#</a> 整体逻辑114</h4> <p><code>模板.match(正则表达式)</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseHTML</span><span class="token punctuation">(</span><span class="token parameter">html<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>lastTag <span class="token operator">||</span> <span class="token function">isPlainTextElement</span><span class="token punctuation">(</span>lastTag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">let</span> textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>	<span class="token comment">//返回&lt;的索引</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>textEnd<span class="token operator">===</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//说明模板开头为&lt;</span>
                <span class="token comment">//注释</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//获取结束标签索引</span>
                    <span class="token comment">//判断是否需要截取注释内容触发钩子函数</span>
                    <span class="token comment">//截取掉整个注释，continue</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//条件注释	&lt;![if !IE]&gt;....&lt;![endif]&gt;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>conditional<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">html</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                	<span class="token comment">//判断是否符合条件注释开头</span>
                    <span class="token comment">//获取条件注释开始标签的结尾索引</span>
                   	<span class="token comment">//截去模板的注释开始标签</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//DOCTYPE处理</span>
                <span class="token keyword">const</span> doctypeMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>doctype<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    html <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>doctypeMatch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//结束标签处理</span>
                <span class="token keyword">const</span> endTagMatch <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>endTagMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//截去模板的结束标签</span>
                    <span class="token comment">//触发end的钩子</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//开始标签处理</span>
                <span class="token keyword">const</span> startTagMatch <span class="token operator">=</span><span class="token function">parseStartTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">handleStartTag</span><span class="token punctuation">(</span>startTagMatch<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span>
                    <span class="token comment">//startTagMatch函数执行以下内容</span>
                    <span class="token comment">//判断是否符合开始标签特征</span>
                    <span class="token comment">//循环解析标签属性并截取模板</span>
                    <span class="token comment">//判断是否自闭合并截取</span>
                    <span class="token comment">//handleStartTag执行startTagMatch函数并取出match对象触发钩子函数</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">let</span> text<span class="token punctuation">,</span> rest<span class="token punctuation">,</span> next
            textEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">)</span>	<span class="token comment">//获取&lt;的索引</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>textEnd<span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
            	rest <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>textEnd<span class="token punctuation">)</span>	<span class="token comment">//获取&lt;后面的模板</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>
                	判断rest是否为结束标签
                    判断rest是否为起始标签
                    判断rest是否是注释是否是条件注释，都不是再次取<span class="token operator">&lt;</span>索引，将<span class="token operator">&lt;</span>之前的加入到
                    textEnd中，
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>	
            <span class="token keyword">if</span><span class="token punctuation">(</span>textEnd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> text <span class="token operator">=</span> html <span class="token punctuation">,</span> html <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">}</span><span class="token comment">//剩余的都是文本</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>chars<span class="token operator">&amp;&amp;</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>  <span class="token comment">//触发钩子函数</span>
                options<span class="token punctuation">.</span><span class="token function">chars</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//进入else时，模板如下</span>
            <span class="token comment">//处理 模板例子 console.log(1)&lt;/script&gt;</span>
		   <span class="token comment">//父元素为texterea、style、script</span>
            截取结束标签前的所有内容，用<span class="token string">''</span>替换，触发钩子函数，最后触发end函数移除整个纯文			本内容
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="文本解析器"><a href="#文本解析器" class="header-anchor">#</a> 文本解析器</h3> <p><font color="orange">HTML解析器将文本解析出来后，需要对文本进行二次加工，因为文本存在带变量和不带变量的情况</font>
带变量的文本在使用虚拟DOM渲染时，需要将变量替换成变量的值</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">parseHTML</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function">chars</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        text <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//去除空格</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//currentParent为栈中的最后一个节点</span>
            <span class="token keyword">const</span> children <span class="token operator">=</span> currentParent<span class="token punctuation">.</span>children
            <span class="token keyword">let</span> expression
            <span class="token comment">//如果parseText有返回值，说明文本带变量且已经被加工</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>expression <span class="token operator">=</span> <span class="token function">parseText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	
                children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
                    expression<span class="token punctuation">,</span>
                    text
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>	<span class="token comment">//如果返回值为undefined</span>
                children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
                    text		<span class="token comment">//直接往childrne加入普通文本</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>在chars函数中，如果执行parseText后有返回结果，则说明文本是带变量的文本，并且已经通过文本解析器( parseText)二次加工，此时构建一个带变量的文本类型的AST并将其忍加到父节点的children属性中。否则，就直接构建一个普通的文本节点并将其添加到父节点的children属性中。而代码中的currentParent是当前节点的父节点，也就是前面介绍的栈中的最后一个节点。
假设chars函数被触发后，我们得到的text是一个带变量的文本：
<code>&quot;Hello &quot;</code>这个带变量的文本被文本解析器解析之后，得到的expression变量是这样的：<code>&quot;Hello &quot;+_s(name)</code> <code>_s 为toString()别名</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> val <span class="token operator">==</span> <span class="token keyword">null</span><span class="token operator">?</span><span class="token string">''</span><span class="token operator">:</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span>
    <span class="token operator">?</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringfy</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">String</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">parseText</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> tagRE <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\{\{((?:.|\n)+?)\}\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span>
    <span class="token comment">//判断是否存在 {{变量}}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tagRE</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> lastIndex  <span class="token operator">=</span> tagRE<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> <span class="token number">0</span>	
    <span class="token keyword">let</span> match<span class="token punctuation">,</span> index
    <span class="token comment">//tagRE.exec(text)返回index和lastIndex</span>
    <span class="token comment">//lastIndex为匹配文本最后一个字符的下一个位置索引，找不到置为0</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> tagRE<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        index <span class="token operator">=</span> match<span class="token punctuation">.</span>index		<span class="token comment">//index为匹配文本第一个字符位置</span>
        <span class="token comment">//先把{{}}前面文本加入到token</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">&gt;</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//截取模板转成JSON,存入token数组</span>
            token<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringfy</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//把变量变成_s(x)函数形式加到数组</span>
        token<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_s(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> 	<span class="token comment">//{{变量}}</span>
        <span class="token comment">//设置lastIndex来保证下一轮循环时，正则表达式不再重复匹配已经解析过的文本</span>
        lastIndex <span class="token operator">=</span> index<span class="token operator">+</span>match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length	<span class="token comment">//存储上一个{{ }} 的最后一个 }索引</span>
        <span class="token comment">//当所有变量都处理完毕后，如果最后一个变量右边还有文本，就将文本添加到数组中</span>
        <span class="token comment">//如果没有lastIndex应该为text初始长度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> lastIndex <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">)</span> i
        tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//最后token将含模板以变量作为分割</span>
    <span class="token comment">//如 text = '卡Q因{{name}}world{{cnm}}'</span>
    <span class="token comment">// token = [&quot;\&quot;卡Q因\&quot;&quot;, &quot;_s(name)&quot;, &quot;\&quot;world\&quot;&quot;, &quot;_s(cnm)&quot;]</span>
	<span class="token keyword">return</span> tokens<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'+'</span><span class="token punctuation">)</span> <span class="token comment">//  &quot;卡Q因&quot;+_s(name)+&quot;world&quot;+_s(cnm)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p><code>lastIndex:</code>每处理完一个变量后，会重新设置<code>lastIndex</code>的位置，这样可以保证如果后面还有其他变量，那么在下一轮循环时可以从 lastIndex的位置开始向后匹配，而<code>lastIndex</code>之前的文本将不再被匹配。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">parseText</span><span class="token punctuation">(</span><span class="token string">'你好{{name}}'</span><span class="token punctuation">)</span>
<span class="token comment">// '&quot;你好&quot;+_s(name)'</span>
<span class="token function">parseText</span><span class="token punctuation">(</span><span class="token string">'你好jack'</span><span class="token punctuation">)</span>
<span class="token comment">// undefined</span>
<span class="token function">parseText</span><span class="token punctuation">(</span><span class="token string">'你好{{name}}，你今年已经{{age}}岁啦&quot;'</span><span class="token punctuation">)</span>
<span class="token comment">//'你好&quot;+_s( name)+&quot;，你今年已经&quot;+_s(age)+&quot;岁啦&quot;'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="总结-5"><a href="#总结-5" class="header-anchor">#</a> 总结</h3> <ul><li>解析器的作用是通过模板得到AST（抽象语法树)。</li> <li>生成AST的过程需要借助HTML解析器，当HTML解析器触发不同的钩子函数时，我们可以构建出不同的节点。</li> <li>随后，我们可以通过栈来得到当前正在构建的节点的父节点,然后将构建出的节点添加到父节点的下面。</li> <li>最终，当HTML解析器运行完毕后，我们就可以得到一个完整的带DOM层级关系的AST。HTML解析器的内部原理是一小段一小段地截取模板字符串，每截取一小段字符串，就会根据截取出来的字符串类型触发不同的钩子函数，直到模板字符串截空停止运行。</li> <li>文本分两种类型，不带变量的纯文本和带变量的文本，后者需要使用文本解析器进行二次加工。</li></ul> <h2 id="优化器-2"><a href="#优化器-2" class="header-anchor">#</a> 优化器</h2> <p>作用：在抽象语法树找出静态节点并打上标记</p> <p>好处：</p> <ul><li><font color="orange">每次重新渲染时，不需要为静态子树创建新节点;</font></li> <li><font color="orange">在虚拟DOM中打补丁( patching)的过程可以跳过。</font></li></ul> <p>优化器的内部实现主要分为两个步骤:</p> <ol><li>在AST中找出所有静态节点并打上标记;</li> <li>在AST中找出所有静态根节点并打上标记。</li></ol> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;静态节点&lt;/--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>静态节点<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;静态根节点&lt;/--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在抽象语法树中，静态节点指的是<code>static</code>属性为<code>true</code>的节点</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token string">'p'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">staticRoot</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">static</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>AST经过优化器处理后，其属性多了<code>static</code>属性和 <code>staticRoot</code>属性，它们分别用来标记节点是否是静态节点与是否是静态根节点。</p> <h3 id="找出静态节点并标记"><a href="#找出静态节点并标记" class="header-anchor">#</a> 找出静态节点并标记</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStatic</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>	<span class="token comment">//排队是否静态节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>				<span class="token comment">//如果节点为元素节点递归处理子节点</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>  	<span class="token comment">//带变量的文本不是静态节点</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span><span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>		<span class="token comment">//纯文本属于静态节点</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>pre <span class="token operator">||</span><span class="token punctuation">(</span>	<span class="token comment">//不包含pre属性 或</span>
        <span class="token operator">!</span> node<span class="token punctuation">.</span>hasBindings <span class="token operator">&amp;&amp;</span> <span class="token comment">//没有动态绑定</span>
        <span class="token operator">!</span> node<span class="token punctuation">.</span>if <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> node<span class="token punctuation">.</span>for <span class="token operator">&amp;&amp;</span> <span class="token comment">// 没有v-if 或v-for或v-else</span>
        <span class="token operator">!</span><span class="token function">isBuiltInTag</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token comment">//不是内置标签</span>
        <span class="token function">isPlatformReservedTag</span><span class="token punctuation">(</span> node<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span><span class="token comment">//不是组件</span>
        <span class="token operator">!</span><span class="token function">isDirectchildOfTemplateFor</span><span class="token punctuation">(</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span> node <span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span>isstaticKey <span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>因为父节点是静态但子节点可能不是静态节点，因此,我们需要在子节点被打上标记之后重新校对当前节点的标记是否准确,具体的做法是:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStatic</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token function">isStatic</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>	<span class="token comment">//排队是否静态节点</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>				<span class="token comment">//如果节点为元素节点递归处理子节点</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> child <span class="token operator">=</span> node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token function">markStatic</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span>
            <span class="token comment">//判断子节点是否是静态节点</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>child<span class="token punctuation">.</span>static<span class="token punctuation">)</span><span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>static <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="找出所有的静态根节点"><a href="#找出所有的静态根节点" class="header-anchor">#</a> 找出所有的静态根节点</h3> <p>找出静态根节点的过程与找出静态节点的过程类似,都是从根节点开始向下一层一层地用递归方式去找。不一样的是，如果一个节点被判定为静态根节点，那么将不会继续向它的子级继续寻找。因为静态子树肯定只有一个根，就是最上面的那个静态节点。</p> <p><font color="orange">有一种特殊情况下是一个元素节点只有一个文本节点，这种由于优化成本大于收益，因此不标记为静态根节点</font> <code>&lt;p&gt;一个元素节点只有一个文本节点&lt;/p&gt;</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">markStaticRoots</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//没有子节点也不认为是静态根节点</span>
        <span class="token comment">//是静态节点、存在子节点、子节点不是只有一个纯文本节点</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>static <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length 				<span class="token operator">===</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">===</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>staticRoot <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span>node<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">markStaticRoots</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>	<span class="token comment">//递归处理子节点</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>&lt;/抽象语法树<code>type</code>取值<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210915170353369.png" alt="image-20210915170353369" style="zoom:80%;"></p> <h2 id="代码生成器-2"><a href="#代码生成器-2" class="header-anchor">#</a> 代码生成器</h2> <p><font color="orange">代码生成器是模板编译的最后一步，它的作用是将AST转换成渲染函数中的内容，这个内容可以称为代码字符串。</font></p> <p>一个简单的模板   <code>&lt;div id=&quot;el&quot;&gt;Hellp &lt;/div&gt;</code></p> <p>经过解析器解析再标记静态节点后，最后生成如下代码字符串</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;el&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;Hellp&quot;</span><span class="token operator">+</span><span class="token function">_s</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><font color="orange">这是一个嵌套的函数调用。函数<code>_c</code>的参数中执行了函数<code>_v</code>，而函数<code>_v</code>的参数中又执行了函数<code>_s</code>。</font>
代码字符串中的_c其实是createElement的别名。createElement是虚拟DOM中所提供的方法，它的作用是创建虚拟节点，有三个参数，分别是：</p> <ul><li>标签名</li> <li>一个包含模板相关属性的数据对象</li> <li>子节点列表</li></ul> <p>调用createElement方法，我们可以得到一个VNode。
这也就知道了渲染函数可以生成VNode的原因:渲染函数其实是执行了createElement,而createElement可以创建一个vNode。</p> <h3 id="通过ast生成代码字符串"><a href="#通过ast生成代码字符串" class="header-anchor">#</a> 通过AST生成代码字符串</h3> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210916134029182.png" alt="image-20210916134029182" style="zoom:80%;"> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>el<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Hello {{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;代码字符串如下&lt;--&gt;</span>
with(){
	return _c('div',{attrs:{&quot;id&quot;:&quot;el&quot;}},[_c('div',[_c(&quot;p&quot;,[_v(&quot;Hello&quot;+_s)])])])
}
<span class="token comment">&lt;!--&gt;伪代码&lt;--&gt;</span>
`whit(){
	return &amp;{code}
}`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="具体原理"><a href="#具体原理" class="header-anchor">#</a> 具体原理</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">genElement</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// plain是否去除标签属性  genData用户获取节点属性</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> el<span class="token punctuation">.</span>plain<span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span><span class="token function">genData</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword">const</span> children <span class="token operator">=</span> <span class="token function">genChildren</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_c('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>el<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">'</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data`<span class="token operator">:</span><span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>children<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token operator">:</span><span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">return</span> code 
<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
代码中的主要逻辑是用genData和 genchildren分别获取data和 children，然后将它们分别拼到字符串中指定的位置，最后把拼好的&quot;_c(tagName，data，children)&quot;返回，这样一个元素节点的代码字符串就生成好了。

function genData(el:ASTElement , state:CodegenState):string {
    let data ='{'
    //key
    if(el.key){
        data+=</span><span class="token template-punctuation string">`</span></span><span class="token literal-property property">key</span><span class="token operator">:</span>$<span class="token punctuation">{</span>el<span class="token punctuation">.</span>key<span class="token punctuation">}</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    }
    if(el.ref){
        data+=</span><span class="token template-punctuation string">`</span></span><span class="token literal-property property">ref</span><span class="token operator">:</span>$<span class="token punctuation">{</span>el<span class="token punctuation">.</span>ref<span class="token punctuation">}</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    }
    if(el.pre){
        data+='pre:true'
    }
    data = data.replace(/,$/,'')+'}'
    return data		//返回属性部分的模板字符串信息
}
    
function genChildren(el, state){
    const children = el.children
    if(children.length){
        return </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">[</span>$<span class="token punctuation">{</span>children<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">c</span><span class="token operator">=&gt;</span><span class="token function">genNode</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        //返回一个数组，children处理子节点，并用,拼接传入数组
    }
}
function genNode(node, state){
    if(node.type === 1){
        return genElement(node, state)//如果子节点仍是元素节点，递归处理
    }
    if(node.type === 3&amp;&amp;node.isComment){//如果是注释节点
        return genComment(node)	
    }else{		//如果是文本节点
        return genText(node)
    }
}
    
function genText(text){
    //判断是否是纯文本节点，是返回expression表达式，否则返回处理后的text纯文本
    return </span><span class="token template-punctuation string">`</span></span><span class="token function">_v</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>text<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">2</span><span class="token operator">?</span>text<span class="token punctuation">.</span>expression<span class="token operator">:</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
}
//使用JSON.stringify的原因 
//而我们希望静态文本是这样的:    &quot;&quot;Hello Berwin&quot; &quot;
所以静态文本需要使用JSON.stringify方法。因为JSON.stringify可以给文本包装一层字符串,例如:
JSON.stringify ( 'Hello')  / &quot; &quot;He1lo&quot;&quot;

//注释节点
//将注释节点内容 JSON.stringify处理返回 _e函数
function genComment(comment){
    return </span><span class="token template-punctuation string">`</span></span><span class="token function">_e</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>`
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h2 id="第四篇"><a href="#第四篇" class="header-anchor">#</a> 第四篇</h2> <h2 id="整体流程"><a href="#整体流程" class="header-anchor">#</a> 整体流程</h2> <h3 id="架构设计"><a href="#架构设计" class="header-anchor">#</a> 架构设计</h3> <p>Vue.js 的整体结构分为三个部分:核心代码、跨平台相关和公用工具函数（这部分是一些辅助函数，不再单独介绍)。同时，其架构是分层的，最底层是一个普通的构造函数，最上层是一个入口，也就是将一个完整的构造函数导出给用户使用。</p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210916150219530.png" alt="image-20210916150219530" style="zoom:80%;"> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210916150637362.png" alt="image-20210916150637362" style="zoom:80%;"> <p>从图12-2可以看到，不同平台有不同的人口，有一些特定于平台的代码会加载到这部分,而底层的核心代码是通用的，可以在任何平台下运行。
这里以构建Web平台下运行的文件为例，如果我们构建的是完整版本，那么会选择 Web平台的人口文件开始构建，这个入口文件最终会导出一个 Vue 构造函数。在导出之前，会向 Vue沟造函数中面添加一些方法，其流程是:先向vue构造函数的prototype属性上添加一些方法,然后向vue构造函数自身添加一些全局API，接着将平台特有的代码导入进来，最后将编译器导出去。</p> <h3 id="总结-6"><a href="#总结-6" class="header-anchor">#</a> 总结</h3> <p>Vue.js在大体上可以分三部分:核心代码、跨平台相关与公用工具函数。核心代码包含原型方法和全局API，它们可以在各个平台下运行，而跨平台相关的部分更多的是渲染相关的功能，不同平台下的渲染API是不同的。以 Web平台为例，Web页面中的渲染操作就是操作 DOM，所以在跨平台的Web环境下对DOM操作的API进行了封装，这个封装主要与虚拟DOM对接<font color="orange">,而虚拟DOM中所使用的各种节点操作其实是调用跨平台层封装的API接口。而 Weex平台对节点的操作与Web平台并不相同。</font></p> <h2 id="实例方法与全局api的实现"><a href="#实例方法与全局api的实现" class="header-anchor">#</a> 实例方法与全局API的实现</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> initMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> '<span class="token punctuation">.</span><span class="token operator">/</span>init&quot;
<span class="token keyword">import</span> <span class="token punctuation">{</span> stateMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./state&quot;</span>
<span class="token keyword">import</span> i renderMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> &quot; <span class="token punctuation">.</span> <span class="token operator">/</span>render'
<span class="token keyword">import</span> <span class="token punctuation">{</span> eventsMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> &quot;<span class="token punctuation">.</span><span class="token operator">/</span> events'
<span class="token keyword">import</span> <span class="token punctuation">{</span> lifecycleMixin <span class="token punctuation">}</span> <span class="token keyword">from</span> '<span class="token punctuation">.</span><span class="token operator">/</span>lifecycle&quot;
<span class="token keyword">import</span> <span class="token punctuation">{</span> warn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../util/index&quot;</span>
<span class="token keyword">function</span> <span class="token function">vue</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env <span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot; production&quot;</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">vue</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">warn</span><span class="token punctuation">(</span> <span class="token string">'vue is a constructor and should be called with the '</span><span class="token keyword">new</span> <span class="token class-name">keyword</span> ' <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token function">initMixin</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span>
<span class="token function">stateMixin</span><span class="token punctuation">(</span>vue<span class="token punctuation">)</span>
<span class="token function">eventsMixin</span><span class="token punctuation">(</span>vue<span class="token punctuation">)</span>
<span class="token function">lifecycleMixin</span><span class="token punctuation">(</span>vue<span class="token punctuation">)</span>
<span class="token function">renderMixin</span><span class="token punctuation">(</span>vue<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> vue

<span class="token comment">// 以initMixin为例，其执行内容为</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">option</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//do something</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//可以看到，当函数initMixin被调用时，会向vue构造函数的prototype属性添加_init方法。执行new Vue()时，会调用_init方法，该方法实现了一系列初始化操作，包括整个生命周期的流程以及响应式系统流程的启动等。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="数据相关的实例方法"><a href="#数据相关的实例方法" class="header-anchor">#</a> 数据相关的实例方法</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>set<span class="token punctuation">,</span> del<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../observer/index'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">stateMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$set <span class="token operator">=</span> <span class="token keyword">set</span>
    vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$<span class="token keyword">delete</span> <span class="token operator">=</span> del
    vue<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">expOrFn，cb，options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//expOrFn侦测对象、cb回调函数，options参数，immediate、deep</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="事件相关的实例方法"><a href="#事件相关的实例方法" class="header-anchor">#</a> 事件相关的实例方法</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">eventsMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$on</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$once</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$off</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$emit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="事件具体实例方法"><a href="#事件具体实例方法" class="header-anchor">#</a> 事件具体实例方法</h4> <h5 id="vm-on-event-callback"><a href="#vm-on-event-callback" class="header-anchor">#</a> vm.$on(event, callback)</h5> <ul><li>{string | Array<string> } event</string></li> <li>{Function} callback</li></ul> <p>用法:<font color="orange">监听当前实例上的自定义事件，事件可以由 vm.$emit触发。回调函数会接收所有传入事件所触发的函数的额外参数。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//示例</span>
vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> hi<span class="token punctuation">)</span>  <span class="token comment">//第一个参数函数名，第二个参数是传入test的参数</span>

<span class="token comment">//vm.$on 内部原理</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$on</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> l<span class="token operator">=</span>event<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当event为数组时，需要遍历数组，递归将事件注册带事件列表 vm_events 上，如果不是数组，就向事件列表直接添加回调</p> <p><code>vm._events</code>是一个对象,用来存储事件。在代码中,我们使用事件名( event )从 vm._events中取出事件列表,如果列表不存在,则使用空数组初始化,然后再将回调函数添加到事件列表中。</p> <p>在执行 <code>new Vue()</code>时，Vue执行 this.init 方法初始化，包括在Vue.js示例上创建event属性
<code>vm._events = Object.create(null)</code></p> <p><font color="orange">执行vm.$on函数其实就是往Vue.js示例的events属性上添加注册函数</font></p> <h5 id="vm-off-event-callback"><a href="#vm-off-event-callback" class="header-anchor">#</a> vm.$off(event, callback)</h5> <ul><li>{string | Array<string> } event</string></li> <li>{Function} callback</li></ul> <p>用：移除自定义事件监听器。</p> <ul><li>如果没有提供参数，则移除所有的事件监听器。</li> <li>如果只提供了事件，则移除该事件所有的监听器。</li> <li>如果同时提供了事件与回调，则只移除这个回调的监听器。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$off</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">//当不存在arguments（参数）的情况移除所有的事件监听器</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">//当event传入数组</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>l<span class="token operator">=</span>event<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> cbs <span class="token operator">=</span> vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span>	<span class="token comment">//如果传入事件没有被监听，直接返回</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>cbs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">//移除该事件的所有监听器</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argument<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果只传了事件名，设置该属性为null</span>
        vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
    <span class="token comment">//如果有事件和回调</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cn<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> cbs <span class="token operator">=</span> vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span>
        <span class="token keyword">let</span> cb
        <span class="token keyword">let</span> i <span class="token operator">=</span> cbs<span class="token punctuation">.</span>length
        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            cb <span class="token operator">=</span> cbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>cb <span class="token operator">===</span> fn <span class="token operator">||</span> cb<span class="token punctuation">.</span>fn <span class="token operator">===</span> fn<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//清除指定回调</span>
                cbs<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h5 id="vm-once"><a href="#vm-once" class="header-anchor">#</a> vm.$once</h5> <p>vm.$once(event, callback)</p> <ul><li>{string | Array<string> } event</string></li> <li>{Function} callback</li></ul> <p>用法：监听一个自定义事件，但是只触发一次，在第一次触发之后移除监听器。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$once</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">function</span> <span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    	vm<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> on</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> argument<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>		
    on<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn
    vm<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> on<span class="token punctuation">)</span>	<span class="token comment">//注册on事件，当执行时删除该事件，手动执行回调函数</span>
    <span class="token keyword">return</span> vm
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// on.fn = fn 的作用</span>
因为在移除监听后器时，需要将用户提供的监听器函数与在列表的函数进行对比，由于on是拦截器，需要加上这段代码来off确认要删除的函数匹配
<span class="token keyword">if</span><span class="token punctuation">(</span>cb <span class="token operator">===</span> fn <span class="token operator">||</span> cb<span class="token punctuation">.</span>fn <span class="token operator">===</span> fn<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="vm-emit"><a href="#vm-emit" class="header-anchor">#</a> vm.$emit</h5> <p>参数</p> <ul><li><code>{string} event</code></li> <li><code>[...args]</code></li></ul> <p>用法：触发当前实例上的事件，附加参数传给监听器回调</p> <p><code>vm. $emit</code> 的作用是触发事件。所有的事件监听器回调函数都会存储在<code>vm._events</code> 中，所以触发事件的实现思路是使用事件名从 <code>vm._events</code>中取出对应的事件监听器回调函数列表，然后依次执行列表中的监听器回调并将参数传递给监听器回调。其代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$emit</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">let</span> cbs <span class="token operator">=</span> vm<span class="token punctuation">.</span>_events<span class="token punctuation">[</span>event<span class="token punctuation">]</span>		<span class="token comment">//获取对应函数</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>cbs<span class="token punctuation">)</span><span class="token punctuation">{</span>		
        <span class="token keyword">const</span> args <span class="token operator">=</span> <span class="token function">toArray</span><span class="token punctuation">(</span>argument<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>		
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> l<span class="token operator">=</span>cbs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">&lt;</span>l<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                cbs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> args<span class="token punctuation">)</span>	<span class="token comment">//循环触发每一个回调函数</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">handlerError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">event handler for &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="生命周期相关的实例方法"><a href="#生命周期相关的实例方法" class="header-anchor">#</a> 生命周期相关的实例方法</h4> <p>与生命周期相关的实例方法有4个，分别是vm .$mount、vm.$forceUpdate、vm.$nextTick和vm.$destroy。其中有两个方法是从<code>lifecycleMixin</code> 中挂载到vue构造函数的 prototype属性上的，分别是<code>vm.$forceUpdate</code>和 <code>vm.$destroy</code>。<code>lifecycleMixin</code>的代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">lifecycleMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$forceUpdata</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">do</span> something<span class="token punctuation">}</span>
	<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destory</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//vm.$nextTick 方法是从 renderMixin 中挂载到vue构造函数的 prototype属性上的。renderMixin的代码如下:</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// vm.$mount 在跨平台的代码中挂载到Vue构造函数的prototype上的</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="vm-forceupdate"><a href="#vm-forceupdate" class="header-anchor">#</a> vm.$forceUpdate</h4> <p><code>vm.$forceUpdate()</code>的作用是迫使<code>Vue.js</code>实例重新渲染。注意<font color="orange">它仅仅影响实例本身以及插人插槽内容的子组件，而不是所有子组件。</font></p> <p>我们只需要执行实例<code>watcher的update</code>方法，就可以让实例重新渲染。Vue.js的每一个实例都有一个 watcher。<font color="orange">当状态发生变化时，会通知到组件级别，然后组件内部使用虚拟DOM进行更详细的重新渲染操作。事实上，组件就是Vue.js实例，所以组件级别的 watcher和Vue.js实例上的 watcher说的是同一个watcher。</font> <font color="orange">手动执行实例watcher的 update方法</font>，就可以使Vue.js实例重新渲染。<code>vm.$forceUpdate</code>的具体实现</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$forceUpdate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>vm._watcher</code>就是Vue.js实例的watcher，每当组件内依赖的数据发生变化时，都会自动触发Vue.js实例中<code>_watcher</code>的update方法。</p> <p>重新渲染的实现原理并不难,Vue.js的自动渲染通过变化侦测来侦测数据，即当数据发生变化时，Vue.js实例重新渲染。而<code>vm.$forceUpdate</code>是<font color="orange">手动通知Vue.js实例重新渲染。</font></p> <h4 id="vm-destory"><a href="#vm-destory" class="header-anchor">#</a> vm.$destory</h4> <p>vm.$destroy 的作用是完全销毁一个实例，它会<font color="orange">清理该实例与其他实例的连接，并解绑其全部指令及监听器</font>，<font color="orange">同时会触发beforeDestroy和 destroyed的钩子函数。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$destory</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> vm <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>vm_isBeingDestoryed<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//用于判断当前Vue实例是正在摧毁</span>
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeDestory'</span><span class="token punctuation">)</span> <span class="token comment">//触发beforeDestory 钩子函数</span>
    vm<span class="token punctuation">.</span>_isBeingDestoryed <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">//清除与父组件的联系</span>
    <span class="token keyword">const</span> parent <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent
    <span class="token keyword">if</span><span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>_isBeingDestoryed <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>vm<span class="token punctuation">.</span>$option<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">remove</span><span class="token punctuation">(</span>parent<span class="token punctuation">.</span>$children<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//上面代码中的判断条件是:如果当前实例有父级，同时父级没有被销毁且不是抽象组件，那么将自己从父级的子级列表中删除，也就是将自己的实例从父级的$children属性中删除。</span>
    
	<span class="token comment">//你可能会有疑问，一个组件可以同时被多个组件引入。也就是说，一个子组件可以同时放在很多父组件下面，那么为什么代码中只从一个父组件的$children列表中移除了子组件?</span>
    
	<span class="token comment">//事实上,子组件在不同父组件中是不同的Vue.js实例,所以一个子组件实例的父级只有一个,销毁操作也只需要从父级的子组件列表中销毁当前这个Vue.js实例。</span>
	
    <span class="token comment">//从watcher删除监听的所有状态的依赖列表中移除watcher</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">)</span><span class="token punctuation">{</span>
        vm<span class="token punctuation">.</span>_watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span>length
    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//执行每一个watcher的teardown方法</span>
        vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token comment">//在vnode树上触发destroy钩子函数解绑指令</span>
    vm<span class="token punctuation">.</span><span class="token function">___patch_</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_vnode<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span>
	<span class="token comment">//触发destroyed钩子函数</span>
	<span class="token function">callHook</span><span class="token punctuation">(</span> vm<span class="token punctuation">,</span> <span class="token string">&quot;destroyed&quot;</span><span class="token punctuation">)</span>	<span class="token comment">//移除所有的事件监听器vm.$off( )</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">arr<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>legnth<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>index<span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p><font color="orange">当执行new vue()时，会执行一系列初始化操作并渲染组件到视图上，其中就包括<code>vm._watcher</code>的处理。</font>从Vue.js2.0开始，变化侦测的粒度调整为中等粒度，<font color="orange">它只会发送通知到组件级别</font>，然后组件使用虚拟DOM进行重新渲染。<font color="orange">组件其实就是Vue.js实例</font>，怎么通知到组件级别呢?事实上，在Vue.js实例上，有一个watcher，也就是<code>vm._watcher</code>，它会监听这个组件中用到的所有状态，即这个组件内用到的所有状态的依赖列表中都会收集到 vm._watcher 中。当这些状态发生变化时，也都会通知vm._watcher，然后这个watcher再调用虚拟DOM进行重新渲染。
因此，在销毁Vue.,js实例的watcher实例所监听的所有状态时，只需要执行vm._watcher.teardown()即可。</p> <h4 id="vm-nexttick"><a href="#vm-nexttick" class="header-anchor">#</a> vm.$nextTick</h4> <p>nextTick接收一个<font color="orange">回调函数作为参数,它的作用是将回调延迟到下次DOM更新周期之后执行。</font>它与全局方法 Vue.nextTick 一样，不同的是<font color="orange">回调的this自动绑定到调用它的实例上</font>。<font color="orange">如果没有提供回调且在支持Promise的环境中，则返回一个Promise。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function-variable function">example</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//修改数据</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'changed'</span>
            <span class="token comment">//DOM还没更新</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//DOM现在更新</span>
                <span class="token comment">// this绑定到当前实例</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在Vue.js中，当状态发生变化时，watcher会得到通知，然后触发虚拟DOM的渲染流程。而<font color="orange">watcher触发渲染这个操作并不是同步的，而是异步的</font>。Vue.js中有一个队列，每当需要渲染时，<font color="pink">会将watcher推送到这个队列中，在下一次事件循环（即退出当前执行栈，在执行微任务时更新）中再让 watcher触发渲染的流程。</font></p> <h5 id="vm-nexttick实际上是将回调加入到微任务队列中"><a href="#vm-nexttick实际上是将回调加入到微任务队列中" class="header-anchor">#</a> <font color="orange">vm.$nextTick实际上是将回调加入到微任务队列中</font></h5> <p>如果使用vm.$nextTick来获取更新后的 DOM，则需要注意顺序的问题。因为不论是更新DOM的回调还是使用vm.$nextTick注册的回调，都是向微任务队列中添加任务，所以<font color="orange">哪个任务先添加到队列中，就先执行哪个任务。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>process.nextTick()中的回调函数执行的优先级要高于setImmediate().这里的原因在于事件循环对观察者的检查是有先后顺序的，process.nextTick()属于idle观察者，setImmediate()属于check观察者。在每一个轮循环检查中，idle观察者先于I/O观察者，I/O观察者先于check观察者。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>更新DOM的回调实际上也是使用 <code>vm.$nextTick</code>来注册到微任务队列中的</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//如果想在vm.$nextTick获取更新后的DOM,需要在更改数据后面使用nextTick,因为修改数据会触发视图更新，会将事件加入到微任务列表，nextTick的回调也会下次视图更新时触发，因此在nextTick获取新DOM应该在更新数据之后</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function-variable function">example</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'change'</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//执行到此DOM已经更新</span>
                <span class="token comment">//DOM已经更新</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><font color="orange">如果先注册nextTick回调，再修改数据，则无法在nextTick获取到最新的DOM，因为nextTick先进入队列，DOM更新后入队列</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//宏任务慢于微任务队列</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//setTimeout属于宏任务</span>
    <span class="token comment">//DOM已经更新	可在此获取到最新的DOM</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token string">'change'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Vue原型上的$nextTick方法只是调用了nextTick方法，具体实现其实在nextTick中。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>nextTick<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nextTick</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="nexttick实现方式"><a href="#nexttick实现方式" class="header-anchor">#</a> nextTick实现方式</h5> <p>由于vm.$nextTick会将回调添加到任务队列中延迟执行，所以在回调执行前，如果反复调用vm.$nextTick，Vue.js并不会反复将回调添加到任务队列中，只会向任务队列中添加一个任务。此外，Vue.,js内部有一个列表用来存储vm.$nextTick 参数中提供的回调。在一轮事件循环中，vm.$nextTick 只会向任务队列添加一个任务，<font color="orange">多次使用vm.$nextTick 只会将回调添加到回调列表中缓存起来</font>。当任务触发时，依次执行列表中的所有回调并清空列表。其代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> callbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>	<span class="token comment">//回调列表数组</span>
<span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token boolean">false</span>		<span class="token comment">//用于标识是否第一次调用nextTick</span>
<span class="token keyword">function</span> <span class="token function">flushCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//用于执行回调函数</span>
    pending <span class="token operator">=</span> <span class="token boolean">false</span>		
    <span class="token keyword">const</span> copies <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    callbacks<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span>copies<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//依次执行列表回调函数</span>
        copies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span>	microTimerFunc
<span class="token keyword">let</span> macroTimerFunc 
<span class="token keyword">let</span> useMacroTask <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token comment">//3种加入到宏队列的方式</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> setImmediate <span class="token operator">!==</span><span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isNative</span><span class="token punctuation">(</span>setImmediate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token function">setImmediate</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> MessageChannel<span class="token operator">!==</span><span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token function">isNative</span><span class="token punctuation">(</span>MessageChannel<span class="token punctuation">)</span><span class="token operator">||</span>MessageChannel<span class="token punctuation">.</span><span class="token function">tostring</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object MessageChannelConstructor]'</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Messagechannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> port <span class="token operator">=</span> channel<span class="token punctuation">.</span>port2
	channel<span class="token punctuation">.</span> port1<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> <span class="token function-variable function">flushCal1backsmacroTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function-variable function">macroTimerFunc</span> <span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>		
        <span class="token function-variable function">setTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//判断是否能调用promise，不能降级为宏任务</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined '</span> <span class="token number">88</span> <span class="token function">isNative</span><span class="token punctuation">(</span> Promise<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function-variable function">microTimerFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
	microTimerFunc <span class="token operator">=</span> macroTimerFunc
<span class="token punctuation">}</span>
<span class="token comment">//包装回调函数，如果执行此函数过程中修改了数据，更新DOM会加入到宏队列中</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">withMacroTask</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> fn<span class="token punctuation">.</span>_withTask <span class="token operator">||</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span><span class="token function-variable function">_withTask</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        useMacroTask <span class="token operator">=</span> <span class="token boolean">true</span>			
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>	<span class="token comment">//如果此回调修改数据，触发了nextTick</span>
        useMacroTask <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resovle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//当不支持Promise时，降级为宏任务</span>
<span class="token function-variable function">microTimeFunc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>	
    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>flushCallbacks<span class="token punctuation">)</span>		<span class="token comment">//往微任务队列加入执行回调函数事件</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token parameter">cb<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//nextTick会代码会执行完，但回调函数会根据代码处理</span>
    <span class="token keyword">let</span> _resoleve
    callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>	<span class="token comment">//将回调存入数组中</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>_resoleve<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//不存在注入一个Promise</span>
            <span class="token function">_resolve</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>pending<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//只需判断加入一次就好，因为后续处理到该微任务会一次执行完</span>
        pending <span class="token operator">=</span> <span class="token boolean">true</span>			<span class="token comment">//判断是否需要往任务队列添加任务</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>useMacroTask<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">macroTimeFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token function">microTimerFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//当没有传入回调函数且支持Promise 返回一个Promise</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>cb <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Promise <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            _resolve <span class="token operator">=</span> resolve
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>	<span class="token comment">//Berwin</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'Berwin'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h4 id="vm-mount"><a href="#vm-mount" class="header-anchor">#</a> vm.$mount</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Hello Vue!'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果在实例化<code>Vue.,js</code>时设置了<code>el</code>选项，会自动把 Vue.js实例挂载到DOM元素上。但理解这个方法却非常重要，因为无论我们在实例化Vue.js时是否设置了el选项，想让Vue.js实例具有关联的DOM元素，只有使用vm .$mount方法这一种途径。</p> <p><code>vue.$mount([elementOrSelector])</code></p> <ul><li><p>参数:{Element | string}[elementorSelector]。</p></li> <li><p><font color="orange">返回值:vm，即实例自身。</font>用法:如果Vue.js实例在实例化时没有收到el选项，则它处于“未挂载”状态，没有关联的DOM元素。我们可以使用vm.$mount手动挂载一个未挂载的实例。如果没有提供elementorSelector参数，模板将被渲染为文档之外的元素，并且必须使用原生DOM的API把它插入文档中。这个方法返回实例自身，因而可以链式调用其他实例方法。</p></li> <li><p>示例:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> myComponent <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'&lt;div&gt;Hello&lt;/div&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//创建并挂载到 #app（会替换#app）</span>
<span class="token keyword">new</span> <span class="token class-name">myComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
<span class="token comment">//创建并挂载到 #app</span>
<span class="token keyword">new</span> <span class="token class-name">myComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">el</span><span class="token operator">:</span><span class="token string">'#app'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//或者，在文档之外渲染并且随后挂载</span>
<span class="token keyword">var</span> component <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span> 'app &quot; <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>component<span class="token punctuation">.</span>$el<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li></ul> <p>Vue.js有很多不同的构建版本。事实上，在不同的构建版本中，vm. $mount的表现都不一样。其差异主要体现在完整版（ vue.js)和只包含运行时版本( vue.runtime.js )之间。</p> <p>完整版和运行版之间的差异在于是否编译器，<font color="pink">在完整版中，会先检查template和el选项是否已经转成渲染函数，没有则编译形成渲染函数，再挂载与渲染</font>；<font color="orange">在运行版，会默认已存在渲染函数，没有则设置一个，并在执行渲染函数时返回一个空的Vnode。在开发环境运行时，会触发警告</font></p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210917223545494.png" alt="image-20210917223545494" style="zoom:80%;"> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> mount <span class="token operator">=</span> <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>$mount
<span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//传参目的是为了获取元素标签</span>
    el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> <span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options	<span class="token comment">//获取vue实例上的options属性</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果不存在渲染函数</span>
        <span class="token keyword">let</span> template <span class="token operator">=</span> options<span class="token punctuation">.</span>template	<span class="token comment">//获取模板</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果存在模板</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> template <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果以#开头，需通过ID找模板</span>
                    template <span class="token operator">=</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//判断是否是DOM元素</span>
                template <span class="token operator">=</span> template<span class="token punctuation">.</span>innerHTML	
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>			<span class="token comment">//如果template既不是选项又不是字符串，发出警告</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'invalid template option:'</span> <span class="token operator">+</span>template<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果不存在模板</span>
            template <span class="token operator">=</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>	<span class="token comment">//获取对应el元素</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取到模板后，处理编译相关逻辑</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>render<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span>
            options<span class="token punctuation">.</span>render <span class="token operator">=</span> render                                        
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">mount</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>	el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>  
<span class="token comment">//获取DOM元素</span>
<span class="token keyword">function</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> el <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果是字符串，去获取DOM元素，</span>
        <span class="token keyword">const</span> selected  <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>selected<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//获取不到返回空div标签</span>
            <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> selected		
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>		<span class="token comment">//如果不是字符串则认为是一个元素标签</span>
        <span class="token keyword">return</span> el
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//获取el提供的模板</span>
<span class="token keyword">function</span> <span class="token function">getOuterHTML</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//获取HTML模板，没有创建div标签</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>outerHTML<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token keyword">return</span> outerHTML<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
        container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> container<span class="token punctuation">.</span>innerHTML
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">idToTemplate</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token function">query</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>	<span class="token comment">//根据el返回对应的模板</span>
    <span class="token keyword">return</span> el <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span>innerHTML	<span class="token comment">//innerHTML为el的子元素内容</span>
<span class="token punctuation">}</span>
        
<span class="token keyword">function</span> <span class="token function">compileToFunctions</span><span class="token punctuation">(</span><span class="token parameter">template<span class="token punctuation">,</span> options<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token comment">//将options混合到空对象中</span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> options<span class="token punctuation">.</span>delimiters<span class="token operator">?</span><span class="token function">String</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>delimiters<span class="token punctuation">)</span><span class="token operator">+</span>template<span class="token operator">:</span>template
    <span class="token keyword">if</span><span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//检查缓存是否存在编译后的的模板，</span>
        <span class="token keyword">return</span> cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span>	<span class="token comment">//存在直接返回编译后的模板</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//不存在 </span>
    <span class="token keyword">const</span> compiled <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>template<span class="token punctuation">,</span> options<span class="token punctuation">)</span>	<span class="token comment">//编译</span>
    <span class="token comment">//将代码字符串转换为函数</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    res<span class="token punctuation">.</span>render  <span class="token operator">=</span> <span class="token function">createFunction</span><span class="token punctuation">(</span>compiled<span class="token punctuation">.</span>render<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>cache<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">)</span>	<span class="token comment">//缓存并返回编译后的模板</span>
<span class="token punctuation">}</span>
<span class="token comment">//code为函数字符串  如'console.log('aa')'</span>
<span class="token keyword">const</span> <span class="token function-variable function">temp</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">createFunction</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token function">temp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// aa</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h5 id="只包含运行版本的vm-mount"><a href="#只包含运行版本的vm-mount" class="header-anchor">#</a> 只包含运行版本的vm.$mount</h5> <p>无需进行模板编译，默认存在渲染函数，不存在则返回一个注册的虚拟节点</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$mount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    el <span class="token operator">=</span> el <span class="token operator">&amp;&amp;</span> inBrower<span class="token operator">?</span><span class="token function">query</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token operator">:</span><span class="token keyword">undefined</span>	
    <span class="token keyword">return</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> el<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">mountComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//不存在渲染函数</span>
        vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render <span class="token operator">=</span> createEmptyVnode	<span class="token comment">//可生成虚拟节点的渲染函数</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//在开发环境发出警告 }</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 挂载实例前触发生命周期函数</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeMount'</span><span class="token punctuation">)</span>
    <span class="token comment">// 挂载</span>
    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> <span class="token comment">//当vm有状态变化，都会触发第二个参数，不断</span>
        vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>noop	<span class="token comment">//执行update 挂载更新视图</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// vm._update 先执行render用于生成新的虚拟节点树，再对比更新DOM节点</span>
    <span class="token comment">//触发生命周期函数 mounted</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'mounted'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> vm
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="全局api的实现原理"><a href="#全局api的实现原理" class="header-anchor">#</a> 全局API的实现原理</h3> <h4 id="vue-extend"><a href="#vue-extend" class="header-anchor">#</a> Vue.extend</h4> <ul><li>参数：<code>{Object} options</code>		options要求是一个vue实例对象</li> <li>用法：使用Vue构造器创建一个子类，参数是包含组件选项的对象</li></ul> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>mount-point<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
//创建构造器
Var profile = Vue.extend({
	template:'<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>',
	data:function(){
		return{
			name:'jacklove'
		}
	}
})
//创建Profile实例挂载到一个元素上
new Profile().$mount(&quot;#mount-point&quot;)
//输出 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>jacklove<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h5 id="实现原理-2"><a href="#实现原理-2" class="header-anchor">#</a> 实现原理</h5> <p>全局API和实例方法不同，后者是在vue 的原型上挂载方法，也就是在Vue.prototype 上挂载方法，而前者是直接在vue 上挂载方法。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> cid <span class="token operator">=</span> <span class="token number">1</span>	
Vue<span class="token punctuation">.</span><span class="token function-variable function">extend</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">extendOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    extendOptions <span class="token operator">=</span> extendOptions <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>	<span class="token comment">//获取实例对象</span>
    <span class="token keyword">const</span> Super <span class="token operator">=</span> <span class="token keyword">this</span>		<span class="token comment">//获取父亲实例</span>
    <span class="token keyword">const</span> SuperId <span class="token operator">=</span> Super<span class="token punctuation">.</span>cid	<span class="token comment">//获取自己的ID，cid</span>
    <span class="token keyword">const</span> cachedCtors <span class="token operator">=</span> extendoptions<span class="token punctuation">.</span>_Ctor <span class="token function">ll</span> <span class="token punctuation">(</span>extend0ptions<span class="token punctuation">.</span>_Ctor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> cachedCtors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>		
    	<span class="token keyword">return</span> cachedCtors<span class="token punctuation">[</span>superId<span class="token punctuation">]</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> extend0ptions<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token keyword">super</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>name	<span class="token comment">//检查name选项</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&quot; production &quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[ a-zA-Z][\w-]*$</span><span class="token regex-delimiter">/</span></span> <span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">Sub</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Vuecomponent</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Super</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token comment">//子原型指向父原型</span>
    <span class="token class-name">Sub</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>constructor <span class="token operator">=</span> Sub			<span class="token comment">//子构造函数等于其本身</span>
    <span class="token comment">//让子类继承Vue能力</span>
    Sub<span class="token punctuation">.</span>cid <span class="token operator">=</span> cid <span class="token operator">++</span>					   <span class="token comment">//将cid加一供下一个使用</span>
    Sub<span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>Super<span class="token punctuation">.</span>options<span class="token punctuation">,</span> extendOptions<span class="token punctuation">)</span>
    <span class="token comment">//合并父options和参数中的Options选项 </span>
    Sub<span class="token punctuation">[</span><span class="token string">'super'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Super 	<span class="token comment">//将父属性保存到子类中</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">initProps</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>computed<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">initComputed</span><span class="token punctuation">(</span>Sub<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    Sub<span class="token punctuation">.</span>extend <span class="token operator">=</span> Super<span class="token punctuation">.</span>extend
    Sub<span class="token punctuation">.</span>mixin <span class="token operator">=</span> Super<span class="token punctuation">.</span>mixin
    Sub<span class="token punctuation">.</span>use <span class="token operator">=</span> Super<span class="token punctuation">.</span>use
    <span class="token constant">ASSET_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">,</span> <span class="token string">'directive'</span><span class="token punctuation">,</span> <span class="token string">'filter'</span><span class="token punctuation">]</span>
    <span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        Sub<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> Super<span class="token punctuation">[</span>type<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">{</span>
        Sub<span class="token punctuation">.</span>options<span class="token punctuation">.</span>component<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> Sub
    <span class="token punctuation">}</span>
    Sub<span class="token punctuation">.</span>superOptions <span class="token operator">=</span> Super<span class="token punctuation">.</span>options
    Sub<span class="token punctuation">.</span>extendOptions <span class="token operator">=</span> extendOptions
    Sub<span class="token punctuation">.</span>sealedOptions <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Sun<span class="token punctuation">.</span>options<span class="token punctuation">)</span>
    <span class="token comment">//缓存构造函数</span>
    cachedctors<span class="token punctuation">[</span>SuperId<span class="token punctuation">]</span> <span class="token operator">=</span> Sub	<span class="token comment">//将使用父ID将子类存进缓存，再次调用可直接取出	</span>
    <span class="token keyword">return</span> Sub	<span class="token comment">//返回的是继承Vue的子类实例</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p><font color="orange">创建一个Sub继承父级extend、mixin、use、component、directive、filter属性，同时增加superOptions、extendOptions和sealedOptions属性。</font></p> <h4 id="vue-nexttick"><a href="#vue-nexttick" class="header-anchor">#</a> Vue.nextTick</h4> <p>原理同<code>Vue.$nextTick</code>,在下次DOM更新循环结束后执行延迟回调，修改数据之后立即调用这个方法获取更新后的DOM。
<code>import {nextTick} from '../util/index'</code> <code>Vue.nextTick = nextTick</code></p> <h4 id="vue-set"><a href="#vue-set" class="header-anchor">#</a> Vue.set</h4> <p><code>Vue.set(target,key,value)</code>,设置一个对象的属性，确保其是响应式的</p> <p><code>import {set} from '../observer/index'</code> <code>Vue.set= set</code></p> <h4 id="vue-directive"><a href="#vue-directive" class="header-anchor">#</a> Vue.directive</h4> <p><code>用法：Vue.directive(id, [defination])</code> <code>{Function | Object} [defination]</code></p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>Vue.directive('my-directive', {
    bind:function(){},
    inserted:function(){},
    update:function(){},
    componentUpdated:function(){},
    unbind:function(){}
})
// 注册 指令函数
Vue.directiv('my-directive',function(){
    //这里将会被 bind 和 update 调用
})
Var myDirective = Vue.dircetive('my-directive')

//注册后如下使用
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-my-directive</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//用于保存指令的位置</span>
vue<span class="token punctuation">.</span>options <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">&quot;directives&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
vue<span class="token punctuation">.</span><span class="token function-variable function">directive</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> definition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//如果没有defination 说明只是获取直接返回</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token punctuation">[</span><span class="token string">&quot;directives&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//如果传入函数默认监听 bind、update</span>
			definition <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> definition，update<span class="token operator">:</span> definition <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span> &quot; directives '<span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definition<span class="token punctuation">]</span>
         <span class="token keyword">return</span> definition
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="vue-filter过滤器"><a href="#vue-filter过滤器" class="header-anchor">#</a> Vue.filter	过滤器</h4> <p>注册、获取全局过滤器</p> <p><code>Vue.fiter(id, [defination])</code></p> <p>参数</p> <ul><li><code>{String} id</code></li> <li><code>{Function | Object } [defination]</code></li></ul> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>Vue.options['filter'] = Object.create(null)
Vue.filter = function(id, defination){
    if(!defination){
        return this.options['filter'][id]
    }else{
        this.options['filter'][id] = defination
        return defination
    }
}
//用法
Vue.filter('my-filter', function(value){})
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>{{ data | my-filter}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-bind:</span>&quot;rawId</span> <span class="token attr-name">|</span> <span class="token attr-name">my-filter&quot;</span><span class="token punctuation">&gt;</span></span>{{data}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><font color="pink">类似自定义指令</font></p> <h4 id="vue-componente"><a href="#vue-componente" class="header-anchor">#</a> Vue.componente</h4> <p><font color="orange">注册、获取全局组件</font></p> <p><code>Vue.component(id, [defination])</code></p> <p>参数</p> <ul><li><code>{string} id</code></li> <li><code>{Function | Object} [defination]</code></li></ul> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;具体用法&lt;--&gt;</span>
var myComponent = Vue.component('my-component',Vue.extend({...}))
var myComponent = Vue.component('my-component',{...}) //自动调用Vue.extend处理参数2
var tempComponent = Vue.component('my-component') //返回名为my-component组件
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&gt;</span>具体实现<span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
Vue<span class="token punctuation">.</span><span class="token function-variable function">copmponent</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> defination</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>defination<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>defination<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果defination是对象</span>
            <span class="token comment">//如果defination 有定义组件名</span>
            defination<span class="token punctuation">.</span>name <span class="token operator">=</span> defination<span class="token punctuation">.</span>name <span class="token operator">||</span> id
            defination <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>defination<span class="token punctuation">)</span>	<span class="token comment">//调用extend生成子类</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> defination
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span><span class="token string">'component'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
        <span class="token comment">//返回实例化组件</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><font color="orange">类似自定义指令</font></p> <h4 id="vue-directive、vue-filter、vue-component"><a href="#vue-directive、vue-filter、vue-component" class="header-anchor">#</a> Vue.directive、Vue.filter、Vue.component</h4> <p><font color="pink">实现方法类似可写在同一个实现方法内</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>vue<span class="token punctuation">.</span>options <span class="token operator">-</span> object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token comment">//ASSET_TYPES = [ ' component ' , &quot;directive ' , 'filter']</span>
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	vue<span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span> <span class="token operator">=</span> object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>	
<span class="token constant">ASSET_TYPES</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">type</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    Vue<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span>definition</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'component'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPlainobject</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                definition<span class="token punctuation">.</span>name <span class="token operator">=</span> definition<span class="token punctuation">.</span>name <span class="token operator">||</span> id
                definition <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'directive'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> definition <span class="token operator">===</span> <span class="token string">'function '</span><span class="token punctuation">)</span> 
            <span class="token punctuation">{</span>
                definition <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">bind</span><span class="token operator">:</span> definition，update<span class="token operator">:</span> definition <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">[</span>type <span class="token operator">+</span> <span class="token string">'s '</span><span class="token punctuation">]</span><span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> definitionreturn definition
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//首先在vue实例上的options上注册相关API方法，被调用时，没有传入defination，返回对应的API方法，有的话，如果是filter直接存储defination并返回、对于directive需要默认监听bind和update、对于component还要返判断defination是否是对象是的话存储name或者ID，并调用extend实例化并且返回</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="vue-use"><a href="#vue-use" class="header-anchor">#</a> Vue.use</h4> <p><code>Vue.use(plugin)</code></p> <p>参数</p> <ul><li><code>{Object | Function } plugin</code></li> <li>用法:安装 Vue.js插件。<font color="orange">如果插件是一个对象，必须提供 install方法。</font><font color="orange">如果插件是一个函数，它会被作为install方法。调用install方法时，会将 vue 作为参数传入。</font>install方法被同一个插件多次调用时，插件也只会被安装一次。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function-variable function">use</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> installedPlugins <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_installedPlugins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>installedPlugins<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>					<span class="token comment">//如果已经存在直接返回，确保不重复注册</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span>  <span class="token function">toArray</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//截去数组的第一个元素</span>
    args<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>				   <span class="token comment">//将vue元素移到数组最前面</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin<span class="token punctuation">.</span>install <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        plugin<span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token comment">//存在install方法</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> plugin <span class="token operator">===</span> <span class="token string">' function'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>	<span class="token comment">//plugin直接作为instakk调用</span>
    <span class="token punctuation">}</span>
    installedPlugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="vue-mixin"><a href="#vue-mixin" class="header-anchor">#</a> Vue.mixin</h4> <p><code>Vue.mixin(mixin)</code></p> <p>参数</p> <ul><li><p><code>{Object } mixin</code></p></li> <li><p>用法：<font color="pink">全局注册一个混入( mixin )，影响注册之后创建的每个Vue.js实例。</font>插件作者可以使用混入向组件注入自定义行为（例如:监听生命周期钩子）。该方法的代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Vue<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">created</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> myOption <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">.</span>myOption
        <span class="token keyword">if</span><span class="token punctuation">(</span>myOption<span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myOption<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">myOption</span><span class="token operator">:</span><span class="token string">'Hello'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 当全局混入上诉的mixin后，当vue实例的$options含myOption属性</span>
<span class="token comment">// 执行 created 的方法</span>
<span class="token comment">// =&gt; &quot;Hello&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li> <li><p><font color="orange">实现方法</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>mergeOptions<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../util/index'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    Vue<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">mixin</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> mixin<span class="token punctuation">)</span>
        <span class="token comment">//将用户传入的mixin和Vue上的options混合成一个新对象</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul> <h4 id="vue-compile"><a href="#vue-compile" class="header-anchor">#</a> Vue.compile</h4> <p><code>Vue.compile(template)</code></p> <ul><li><p>参数：<code>{string} template</code></p></li> <li><p>用法:编译模板字符串并<font color="orange">返回包含渲染函数的对象</font>。只在完整版中才有效。其代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> res <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'&lt;div&gt;&lt;span&gt;{{msg}}&lt;/span&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">'hello'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">render</span><span class="token operator">:</span> res<span class="token punctuation">.</span>render
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Vue<span class="token punctuation">.</span>compile <span class="token operator">=</span> compileToFunctions
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>Vue.compile 只保存于完整版，因为只有完整版包含编辑器</p></li></ul> <h4 id="vue-version"><a href="#vue-version" class="header-anchor">#</a> Vue.version</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> version <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>Vue<span class="token punctuation">.</span>version<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token comment">//根据 . 分割字符串成数组返回第一个 并强制转为 数组 可获取版本号</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>version <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Vue.js v2.x.x</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>version <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// Vue.js v1.x.x</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span> 不支持的vue版本 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><font color="pink">Vue.version 是一个属性。在构建文件的配置中定义 <code>__VERTSION__</code> 常量，使用rollup-plugin-replace插件在构建中将代码的常量 <code>__VERSION__</code>替换成 package.json 文件中的版本号</font></p> <h4 id="总结-7"><a href="#总结-7" class="header-anchor">#</a> 总结</h4> <p>Vue.js的实例方法和全局API的区别在于：<font color="orange">实例方法是Vue.prototype上的方法，全局API是Vue.js上的方法</font></p> <p>实例方法又分为数据、事件和生命周期这三个类型。</p> <h2 id="某些方法源码"><a href="#某些方法源码" class="header-anchor">#</a> 某些方法源码</h2> <h3 id="toarray"><a href="#toarray" class="header-anchor">#</a> <code>toArray</code></h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">toArray</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">list</span><span class="token operator">:</span> any<span class="token punctuation">,</span> start<span class="token operator">?</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  start <span class="token operator">=</span> start <span class="token operator">||</span> <span class="token number">0</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> list<span class="token punctuation">.</span>length <span class="token operator">-</span> start	<span class="token comment">//从第二份参数开始截取数组并返回</span>
  <span class="token keyword">const</span> <span class="token literal-property property">ret</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ret<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">[</span>i <span class="token operator">+</span> start<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> ret
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h2> <h3 id="_14-1"><a href="#_14-1" class="header-anchor">#</a> 14.1</h3> <p>生命周期分为4个阶段：<font color="orange">初始化阶段、模板编译阶段、挂载阶段、卸载阶段</font></p> <h4 id="初始化阶段"><a href="#初始化阶段" class="header-anchor">#</a> 初始化阶段</h4> <p><code>new Vue()到 created之间的阶段叫初始化阶段</code></p> <p>这个阶段的主要目的是在Vue.js实例上<font color="orange">初始化一些属性、事件以及响应式数据</font>，如 props,methods、 data、computed 、watch、provide和 inject等。</p> <h4 id="模板编译阶段"><a href="#模板编译阶段" class="header-anchor">#</a> 模板编译阶段</h4> <p>created 钩子函数和beforeMount 钩子函数之间的阶段是模板编译阶段
这个阶段目的是将模板编译为渲染函数
<font color="orange">当使用vue-loader或vueify 时，*.vue文件内部的模板会在构建时预编译成JavaScript，所以最终打好的包里是不需要编译器的，用运行时版本即可。</font>由于模板这时已经预编译成了渲染函数，所以在生命周期中并不存在模板编译阶段，<font color="orange">运行板中初始化阶段的下一个生命周期直接是挂载阶段。</font></p> <h4 id="挂载阶段"><a href="#挂载阶段" class="header-anchor">#</a> 挂载阶段</h4> <p><code>beforeMount</code>钩子函数到<code>mounted</code>钩子函数之间是挂载阶段。</p> <p>在这个阶段，Vue.js 会将其实例挂载到DOM元素上，通俗地讲，<font color="orange">就是将模板渲染到指定的DOM元素中。在挂载的过程中，Vue.js 会开启watcher来持续追踪依赖的变化。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span> 
	vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在已挂载状态下，Vue.js仍会持续追踪状态的变化。当数据（状态）发生变化时，watcher会通知虚拟DOM重新渲染视图，并且会在渲染视图前触发beforeUpdate钩子函数，渲染完毕后触发updated钩子函数。</p> <h4 id="卸载阶段"><a href="#卸载阶段" class="header-anchor">#</a> 卸载阶段</h4> <p>调用 <code>vm.$destory</code> 方法后，Vue.js生命周期进入卸载阶段，<font color="orange">首先将自身实例从父组件删除，取消自身实例上的所有追踪依赖并移除事件监听器</font></p> <h3 id="从源码角度了解生命周期"><a href="#从源码角度了解生命周期" class="header-anchor">#</a> 从源码角度了解生命周期</h3> <p><font color="orange">当new Vue()执行后，触发的一系列初始化流程都在_init方法中启动的</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">Vue</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//在非生产环境下且没有使用 new 关键字</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'发出警告'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Vue
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li><p><code>.init 方法的定义</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 通过initMixin将_init 挂载到vue实例上</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>initMixin<span class="token punctuation">}</span> <span class="token string">'../util/index'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initMixin</span><span class="token punctuation">(</span><span class="token parameter">Vue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p><code>.init方法的内部原理</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>options<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>vm
        <span class="token punctuation">)</span> <span class="token comment">//合并选项对象</span>
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">&quot;beforeCreate&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">//在data/props前初始化</span>
    <span class="token function">injectinitstate</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span> vm<span class="token punctuation">)</span> <span class="token comment">//在data/props后初始化</span>
    <span class="token function">providecallHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token string">&quot;created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token comment">//如果用户在实例化Vue.js时传递了el选项，则自动开启模板编译阶段与挂载阶段</span>
    <span class="token comment">//如果没有传递el选项，则不进入下一个生命周期流程</span>
	<span class="token comment">//用户需要执行vm. $mount方法，手动开启模板编译阶段与挂载阶段</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span> <span class="token function">$mount</span><span class="token punctuation">(</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>resolveConstructorOptions</code> 获取当前实例构造函数的options和所有父级构造函数的options</p> <p>初始化过程中，首先初始化事件与属性，触发生命周期钩子函数<code>beforeCreate</code>,再初始化injected，初始化状态（包括props、data、computed、watch）、初始化provide，触发created，最后判断是否存在el，是调用$mount挂载。
<img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210922234141186.png" alt="image-20210922234141186" style="zoom:80%;"></p></li> <li><p><font color="orange"><code>callHook</code>函数内部原理</font> <font color="skyblue">首先,我们需要理解callHook所实现的功能。callHook的作用是触发用户设置的生命周期钩子，而用户设置的生命周期钩子会在执行new vue()时通过参数传递给Vue.js。也就是说，可以在Vue.js 的构造函数中通过options参数得到用户设置的生命周期钩子。</font> <font color="oran">用户传入的options参数最终会与构造函数的options 属性合并生成新的 options并赋值到vm.$options属性中，所以我们可以通过vm.$options得到用户设置的生命周期函数。例如:通过vm.$options.created得到用户设置的created钩子函数。</font> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210922234504189.png" alt="image-20210922234504189" style="zoom:80%;">
例如 <code>console.log(vm.$options.created) //fn</code></p> <p>将钩子函数转化成数组的原理：Vue.mixin方法会将选项写入Vue.options 中，因此它会影响之后创建的所有Vue.js实例，而Vue.js在初始化时会将构造函数中的options和用户传入的options选项合并成一个新的选项并赋值给vm .$options,所以这里会发生一个现象:<code>Vue.mixin</code>和用户在实例化<code>Vue.js</code>时，如果设置了同一个生命周期钩子，那么在触发生命周期时，需要同时触发这两个函数。而转换成数组后，可以在同一个生命周期钩子列表中保存多个生命周期钩子。
举个例子:使用<code>Vue.mixin</code>设置生命周期钩子<code>mounted</code> 之后，在执行new Vue()时，会在参数中也设置一个生命周期钩子mounted，这时<code>vm.$options.mounted</code>是一个数组，里面包含两个生命周期钩子。
用户实例化和Vue.mixin如果设置了同一个钩子函数，需要触发同一个钩子函数数组，里面包含两个生命周期函数</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//实现代码'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">callHook</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> hook</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//从对应vue实例获取$options的对应钩子函数数组</span>
    <span class="token keyword">const</span> handlers <span class="token operator">=</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">[</span>hook<span class="token punctuation">]</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>handlers<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> j<span class="token operator">=</span>handlers<span class="token punctuation">.</span>length <span class="token punctuation">;</span>i<span class="token operator">&lt;</span>j<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span> <span class="token comment">//依次执行</span>
                handlers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">handlerError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
这里使用<span class="token keyword">try</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>catch语句捕获钩子函数内发生的错误，并使用handleError处理错误。handleError会依次执行父组件的errorCaptured钩子函数与全局的config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">,</span>这也是为什么生命周期钩子errorCaptured可以捕获子孙组件的错误。关于handleError与生命周期钩子errorCaptured，我们会在随后的内容中详细介绍。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ol> <h3 id="errorcaptured与错误处理"><a href="#errorcaptured与错误处理" class="header-anchor">#</a> errorCaptured与错误处理</h3> <p>errorCapture钩子函数的作用是捕获来自子孙组件的错误，接收三个参数：错误对象、发生错误的组件实例、以及一个包含错误来源信息字符串。然后此钩子函数返回false阻止错误向上传播</p> <p>传播规则如下</p> <ul><li>默认情况下，如果<u><font color="orange">全局的config.errorHandler被定义，那么所有的错误都会发送给它，这样这些错误可以在单个位置报告给分析服务。</font></u></li> <li>如果一个组件继承的链路或其父级从属链路中存在多个errorCaptured钩子，则它们将会被相同的错误逐个唤起。</li> <li>如果errorCaptured钩子函数自身抛出了一个错误，则这个新错误和原本被捕获的错误都会发送给全局的config.errorHandler。</li> <li><font color="orange">一个errorCaptured钩子函数能够返回false来阻止错误继续向上传播。这本质上是说“这个错误已经被搞定，应该被忽略”。它会阻止其他被这个错误唤起的errorCaptured钩子函数和全局的config.errorHandler。</font></li></ul> <p><code>errorCaptured</code>会捕获所有用户代码错误并用<code>handleError</code>处理错误。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//错误对象，错误实例、错误钩子字符串信息</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//发生错误vue实例组件</span>
         <span class="token keyword">let</span> cur <span class="token operator">=</span> vm		
         <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cur<span class="token operator">=</span>cur<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//结束条件是不存在父组件</span>
             <span class="token keyword">const</span> hooks <span class="token operator">=</span> cur<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>errorCaptured	
             <span class="token keyword">if</span><span class="token punctuation">(</span>hooks<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//调用所有errorCaptured钩子函数数组上的错误处理函数</span>
                 <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">&lt;</span>hooks<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                     <span class="token keyword">try</span><span class="token punctuation">{</span>
                         <span class="token keyword">const</span> capture <span class="token operator">=</span> hooks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span>err<span class="token punctuation">,</span>vm<span class="token punctuation">,</span>info<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span>
                         <span class="token keyword">if</span><span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token comment">//退出整个函数</span>
                         <span class="token comment">//阻止错误向上传播</span>
                     <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                         <span class="token function">globalHandlerError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token string">'errorCaptured hook'</span><span class="token punctuation">)</span>
                     <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token comment">//通知全局错误处理函数</span>
     <span class="token function">globalHandlError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">globalHandlerError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>errorHandler<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果全局错误处理函数存在</span>
         <span class="token keyword">try</span><span class="token punctuation">{</span>
             <span class="token comment">//调用全局错误对象</span>
             <span class="token keyword">return</span> config<span class="token punctuation">.</span><span class="token function">errorHandler</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span>
         <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token function">logError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>	<span class="token comment">//如果全局错误处理函数也出错，打印错误信息</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
    <span class="token function">logError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>		<span class="token comment">//打印传入全局处理函数的错误信息</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">logError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>	<span class="token comment">//将错误信息输出到控制台：</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="初始化实例属性"><a href="#初始化实例属性" class="header-anchor">#</a> 初始化实例属性</h3> <p>在Vue.js 的整个生命周期中，初始化实例属性是第一步。需要实例化的属性既有Vue.js内部需要用到的属性（例如vm._watcher )，也有提供给外部使用的属性（例如vm.$parent )。</p> <p><font color="orange">Vue.js通过initLifecycle函数向实例中挂载属性，该函数接收Vue.js实例作为参数。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initLifecycle</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
    <span class="token comment">//找出第一个非抽象父类</span>
    <span class="token keyword">let</span> parent <span class="token operator">=</span> options<span class="token punctuation">.</span>parent
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>options<span class="token punctuation">.</span>abstract<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>parent $options<span class="token punctuation">.</span>abstract <span class="token operator">&amp;&amp;</span> parent<span class="token punctuation">.</span>$parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>$parent                                                       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    parent<span class="token punctuation">.</span>$children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token comment">//将当前vue加入到第一个非抽象类父组件的children</span>
    vm<span class="token punctuation">.</span>$parent <span class="token operator">=</span> parent
    vm<span class="token punctuation">.</span>$root <span class="token operator">=</span> parent <span class="token operator">?</span> parent<span class="token punctuation">.</span> $root <span class="token operator">:</span> vm
    <span class="token comment">//如果当前组件不存在parent,根组件为自己，否则为其父组件的组件，父组件的根组件也其父组件的根组件，无线套娃，直到最后一个也就是根组件</span>
    vm<span class="token punctuation">.</span>$children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    vm<span class="token punctuation">.</span>$refs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">null</span>
    vm<span class="token punctuation">.</span>_isDestroyed <span class="token operator">=</span> <span class="token boolean">false</span>
    vm<span class="token punctuation">.</span>_isBeingDestroyed <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="初始化事件"><a href="#初始化事件" class="header-anchor">#</a> 初始化事件</h3> <p><font color="orange">指在父组件模板中使用v-on监听子组件内触发事件，如果不存在父组件，就不用初始事件。本组件的父组件在执行渲染函数时会判断标签是模板组件还是一个标签，如果是模板组件会将其实例化并传参，参数就包括监听事件，存储在子组件的 <code>vm.$options._parentListeners</code>,所谓的初始化事件，就是初始化父组件传过来的监听事件</font></p> <p><font color="orange">初始化事件是指将父组件在模板中使用的v-on注册的事件添加到子组件的事件系统</font>(Vue.js的事件系统）中。</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>counter-event-example<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ total }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button-counter</span> <span class="token attr-name"><span class="token namespace">v-on:</span>increment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>incrementTotal<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button-counter</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button-counter</span> <span class="token attr-name">v-on</span> <span class="token attr-name">:increment</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>incrementTotal<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>&lt;/ button-counter&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!--</span><span class="token punctuation">&gt;</span></span>第二个参数自动调用Vue.extend&lt;&gt;
vue. component( &quot; button-counter ', {
    template: '<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>incrementCounter<span class="token punctuation">&quot;</span></span><span class="token attr-name">&quot;</span><span class="token punctuation">&gt;</span></span>{{ counter }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>' ,
    data: function () {
        return {
            counter: 0
        }
    },
    methods : {
        incrementcounter: function () {
        this.counter += 1
        this.$emit( &quot;increment &quot;)
        },
    })
    new Vue({
    el: &quot;#counter-event-example&quot; ,
    data: {
    	total: e
    },
    methods : {
        incrementTotal: function () {
            this.total += 1
        }
    }
})

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p><font color="orange">如果v-on写在组件标签上，那么这个事件会注册到子组件Vue.js事件系统中;如果是写在平台标签上，例如div，那么事件会被注册到浏览器事件中。</font>
我们会发现，子组件在初始化时，也就是初始化Vue.js实例时，有可能会接收父组件向子组件注册的事件。而<u><font color="pink">子组件自身在模板中注册的事件，只有在渲染的时候才会根据虚拟DOM的对比结果来确定是注册事件还是解绑事件。</font></u>(不使用注册模板的浏览器事件原因)
<font color="orange">所以在实例初始化阶段<u>，被初始化的事件指的是父组件在模板中使用v-on 监听子组件内触发的事件。</u></font></p> <p><code>Vue.js</code>通过initEvents函数来初始化事件相关逻辑</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initEvents</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_events <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token comment">//初始化父组件添加的事件</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_parentListeners
    <span class="token keyword">if</span><span class="token punctuation">(</span>listeners<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> listeners<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>所有使用 <code>vm.$on</code>注册的事件都会保存到<code>vm._events</code>属性中。</p> <p><font color="orange">在模板编译阶段，<u>当模板解析到组件标签时，会实例化子组件，同时将标签上注册的事件解析成<code>object</code>并通过参数传递给子组件。</u>所以当子组件被实例化时，可以在参数中获取父组件向自己注册的事件，<u>这些事件最终会被保存在<code>vm. $options._parentListeners</code> 中</u>。</font></p> <p>上述例子解析到<code>vm.$options.parentListeners</code>的对象是 <code>{increment;function(){}}</code>,<code>updateComponentListeners</code>方法将父组件的事件注册到子组件实例中</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//updateComponentListeners 源码如下</span>
<span class="token keyword">let</span> target
<span class="token comment">//用于新增事件</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> once</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>once<span class="token punctuation">)</span><span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">$once</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        target<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//用于移除事件</span>
<span class="token keyword">function</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateComponentListeners</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> listeners<span class="token punctuation">,</span> oldListeners</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment">//oldListeners 可选参数</span>
    <span class="token comment">// 传入子组件的新 listeners</span>
    <span class="token comment">//oldListeners当前vm的._parentListeners</span>
    target <span class="token operator">=</span> vm
    <span class="token function">updateListeners</span><span class="token punctuation">(</span>listeners<span class="token punctuation">,</span> oldListeners<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> add<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateListeners</span><span class="token punctuation">(</span><span class="token parameter">on<span class="token punctuation">,</span> oldOn<span class="token punctuation">,</span> add<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> name<span class="token punctuation">,</span>cur<span class="token punctuation">,</span> old<span class="token punctuation">,</span> event
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> on<span class="token punctuation">)</span> <span class="token punctuation">{</span>				<span class="token comment">// on 最新注册事件列表</span>
        cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span>	
        old <span class="token operator">=</span> oldOn<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
        event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENv <span class="token operator">!==</span> ' production’ <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">isundef</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>fns<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            	cur <span class="token operator">=</span> on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createFnInvoker</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> event<span class="token punctuation">.</span>once<span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">,</span> event<span class="token punctuation">.</span>passive<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token operator">!==</span> old<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                old<span class="token punctuation">.</span>fns <span class="token operator">=</span> cur
                on<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> old
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>name <span class="token keyword">in</span> oldon<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>on<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            event <span class="token operator">=</span> <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            <span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">,</span> oldon<span class="token punctuation">[</span> name<span class="token punctuation">]</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>capture<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//Vue.js 的模板中支持事件修饰符，例如 capture、once和 passive等，如果我们在模板中注册事件时使用了事件修饰符,那么在模板编译阶段解析标签上的属性时，会将这些修饰符改成对应的符号加在事件名的前面，例如&lt;child v-on:increment. once=&quot;a&quot;'&gt;&lt;/child&gt;。此时vm .$options.parentListeners是下面的样子:</span>
<span class="token comment">//vm.$options._parentsListeners {~increment:function(){}  }</span>
<span class="token comment">// charAt 返回索引处的字符</span>
<span class="token keyword">const</span> <span class="token function-variable function">normalizeEvent</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> passive <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'&amp;'</span>
    name <span class="token operator">=</span> passive <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">:</span>name <span class="token comment">//如果有修饰符，从第二个字符开始截取</span>
    <span class="token keyword">const</span> once <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'~'</span>
    name <span class="token operator">=</span>once<span class="token operator">?</span>name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>name
    <span class="token keyword">const</span> capture <span class="token operator">=</span>name<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'!'</span>
    name <span class="token operator">=</span> capture <span class="token operator">?</span> name<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">:</span>name
    <span class="token keyword">return</span> <span class="token punctuation">{</span>name<span class="token punctuation">,</span> once<span class="token punctuation">,</span> capture<span class="token punctuation">,</span> passive<span class="token punctuation">}</span>
    <span class="token comment">// name为除去修改符的函数，once、capture、passive 为是否符合对应的布尔值 </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h3 id="初始化-inject"><a href="#初始化-inject" class="header-anchor">#</a> 初始化 <code>inject</code></h3> <h4 id="provide和inject使用方式"><a href="#provide和inject使用方式" class="header-anchor">#</a> provide和inject使用方式</h4> <p>​	<code>inject和 provide</code>选项需要一起使用，它们允许祖先组件向其所有子孙后代注入依赖，并在其上下游关系成立的时间里始终生效(不论组件层次有多深)。</p> <p>​	<code>provide</code>选项应该是一个对象或返回一个对象的函数。该对象包含可注入其子孙的属性，你可以使用ES2015 symbol作为key，但是这只在原生支持symbol和Reflect.ownKeys 的环境下可工作。</p> <p>​	<code>inject</code>选项应该是一个字符串数组或对象，其中对象的 key是本地的绑定名，value是一个key(字符串或Symbol）或对象，用来在可用的注入内容中搜索。</p> <p>​	inject对象包含以下两个属性</p> <ul><li>name：它是在可用的注入内容中用来搜索的key(字符串或Symbol ) 。</li> <li>default：它是在降级情况下使用的value。</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> Provider <span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token literal-property property">provide</span> <span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">foo</span><span class="token operator">:</span><span class="token string">'bar'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> Child <span class="token operator">=</span> <span class="token punctuation">{</span>
    inject：<span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token punctuation">)</span>	<span class="token comment">//=&gt;'bar'</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
如果使用<span class="token constant">ES2015</span> Symbol作为key，则 provide函数和inject对象如下所示<span class="token operator">:</span>
<span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Provider <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token function">provide</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">{</span>
			<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'foo'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">inject</span><span class="token operator">:</span> <span class="token punctuation">{</span>s<span class="token punctuation">}</span><span class="token punctuation">,</span>		<span class="token comment">//symbol 的inject是以对象形式声名</span>
    <span class="token comment">// ....</span>
<span class="token punctuation">}</span>
<span class="token comment">//修改注入对象默认值</span>
<span class="token keyword">const</span> Child <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">inject</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">foo</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token keyword">default</span><span class="token operator">:</span><span class="token string">'foo'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 可以为注入对象声名来源重命名并使用from声明来源</span>
<span class="token keyword">const</span> Child <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在data中通过 this.foo 引用，默认值为foo，来源于祖先组件中provider的bar</span>
    <span class="token literal-property property">inject</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">foo</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token literal-property property">from</span><span class="token operator">:</span><span class="token string">'bar'</span><span class="token punctuation">,</span>
            <span class="token keyword">default</span><span class="token operator">:</span><span class="token string">'foo'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p><font color="orange">inject 在 data/props 之前初始化，而provide在data/props 后面初始化。这样做的目的是让用户可以在data/props 中使用inject所注入的内容。也就是说,可以让data/props依赖inject,所以需要将初始化inject放在初始化data/props的前面。</font></p> <h5 id="初始化-inject-2"><a href="#初始化-inject-2" class="header-anchor">#</a> 初始化 inject</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initInjections</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">resolveInject</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>inject<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">{</span>
        observeState<span class="token punctuation">.</span>shouldCovert <span class="token operator">=</span> <span class="token boolean">false</span>		
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">defineReactive</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        observeState<span class="token punctuation">.</span>shouldCovert <span class="token operator">=</span> <span class="token boolean">false</span>		
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//observeState.shouldCovert 其作用是通知 defineReactive函数不要将内容转换成响应式。其原理也很简单，在将值转换成响应式之前，判断observerState.shouldconvert属性即可，这里不再详细介绍。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveInject</span><span class="token punctuation">(</span><span class="token parameter">inject<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> result  <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> keys <span class="token operator">=</span> hasSymbol		<span class="token comment">//判断是否存在symbol环境</span>
        <span class="token operator">?</span> Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>inject<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">.</span>emumerable
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>inject<span class="token punctuation">)</span>
        <span class="token comment">//如果浏览器原生支持symbol，那么使用Reflect.ownKeys读取出 inject的所有key;如果浏览器原生不支持Symbol，那么使用object.keys获取key。其区别是Reflect.ownKeys可以读取 Symbol类型的属性，而 object.keys读不出来。由于通过Reflect.ownKeys读出的 key包括不可枚举的属性，所以代码中需要使用filter将不可枚举的属性过滤掉。</span>
        <span class="token comment">//  keys为inject的所有可枚举属性</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>			<span class="token comment">//循环寻找每个属性</span>
            <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">const</span> provideKey <span class="token operator">=</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>from	   <span class="token comment">//获取祖先组件</span>
            <span class="token keyword">let</span> source <span class="token operator">=</span> vm			<span class="token comment">//获取当前vue实例</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">{</span>			<span class="token comment">//循环寻找某个属性的祖先组件</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span>_provided <span class="token operator">&amp;&amp;</span> provideKey <span class="token keyword">in</span> source<span class="token punctuation">.</span>_provided<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">=</span>source<span class="token punctuation">.</span>_provided<span class="token punctuation">[</span>provideKey<span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
                source <span class="token operator">=</span> source<span class="token punctuation">.</span>$parent
            <span class="token punctuation">}</span>
            <span class="token comment">// 如果存在source，为目的祖先组件</span>
            <span class="token comment">// 不存在查看有无默认值</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>source<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'default'</span> <span class="token keyword">in</span> inject<span class="token punctuation">[</span>ket<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">const</span> provideDefault <span class="token operator">=</span> inject<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span>default
                    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> provideDefault <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span>			 <span class="token function">provideDefault</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token operator">:</span>provideDefault                 
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span> <span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result	<span class="token comment">// result 为所有inject对象值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h3 id="初始化状态"><a href="#初始化状态" class="header-anchor">#</a> 初始化状态</h3> <p>当我们使用Vue.,js开发应用时，经常会使用一些状态，例如 props、methods、data、computed和 watch。在Vue.,js内部，这些状态在使用之前需要进行初始化。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// initState函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ininState</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_watchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> opts <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span> <span class="token function">initProps</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>props<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token function">ininMethods</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>methods<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">initData</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">observe</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>computed<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> natvieWatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">initWatch</span>
        <span class="token punctuation">(</span>vm<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ol><li>首先增加一个属性<code>_watcher</code>,用来保存当前组件的所有watcher实例，无论是使用vm.$watcher 或者是watch选项添加的watcher实例</li> <li>判断是否存在props属性，存在的话调用<code>initProps</code>初始化</li> <li>判断是否存在methods，初始化</li> <li>判断是否存在data属性，存在初始化，不存在调用observe（将数据转化成响应式的）观察空对象</li> <li>判断computed初始化</li> <li>判断是否存在watch属性并初始化</li></ol> <p><font color="orange">用户实例化Vue.js 时，调用了哪些状态，才需初始化那些状态</font></p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210924221654148.png" alt="image-20210924221654148" style="zoom:80%;"> <h4 id="初始化props"><a href="#初始化props" class="header-anchor">#</a> 初始化props</h4> <p>事实上，Vue.js中的所有组件都是Vue.js实例，组件在进行模板解析时，会将标签上的属性解析成数据，最终生成渲染函数。而<font color="orange">渲染函数被执行时，会生成真实的DOM节点并渲染到视图中。但是这里面有一个细节，如果某个节点是组件节点</font>，也就是说模板中的、某个标签的名字是组件名，那么在<font color="orange">虚拟DOM渲染的过程中会将子组件实例化</font>，这会将<font color="orange">模板解析时从标签属性上解析出的数据当作参数传递给子组件,其中就包含props 数据。</font></p> <p><font color="pink">数组格式的props将被格式化为对象格式</font></p> <h5 id="规格化props-获取props属性名并存在options-props里面"><a href="#规格化props-获取props属性名并存在options-props里面" class="header-anchor">#</a> 规格化props（获取props属性名并存在options.props里面）</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">normalizeProps</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> options<span class="token punctuation">.</span>props
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> res<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> val<span class="token punctuation">,</span> name
    <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i <span class="token operator">=</span> props<span class="token punctuation">.</span>length
        <span class="token comment">//props: ['title', 'likes', 'isPublished', 'commentIds', 'author']   </span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> <span class="token operator">=</span> props<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                name <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>	<span class="token comment">//将名称小驼峰化</span>
                res<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">}</span>
                <span class="token comment">//res:{ propsA:{}  }</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">warn</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token comment">//将Array类型的转为 Object</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//props: {</span>
        <span class="token comment">//  title: String,</span>
        <span class="token comment">//  likes: Number,</span>
        <span class="token comment">//  isPublished: Boolean,</span>
        <span class="token comment">//  commentIds: Array,</span>
        <span class="token comment">//  author: Object,</span>
        <span class="token comment">//  callback: Function,</span>
        <span class="token comment">//  contactsPromise: Promise // or any other constructor</span>
        <span class="token comment">// }</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> props<span class="token punctuation">)</span><span class="token punctuation">{</span>
            val <span class="token operator">=</span> props<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            name <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">?</span>val<span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span>val<span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    options<span class="token punctuation">.</span>props <span class="token operator">=</span> res	
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'userName'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">propA</span><span class="token operator">:</span>Number
    <span class="token literal-property property">propB</span><span class="token operator">:</span><span class="token punctuation">[</span>String<span class="token punctuation">,</span> Number<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">propC</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span>String<span class="token punctuation">,</span>
        <span class="token literal-property property">required</span><span class="token operator">:</span><span class="token boolean">true</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h5 id="初始化props-获取props属性值"><a href="#初始化props-获取props属性值" class="header-anchor">#</a> 初始化props（获取props属性值）</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initProps</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> propsOptions</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> propsData <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>propsData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">//存储props选项值</span>
   <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>_props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  	<span class="token comment">// 缓存props的key</span>
   <span class="token keyword">const</span> keys <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>_propKeys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token keyword">const</span> isRoot <span class="token operator">=</span> vm<span class="token punctuation">.</span>$parent		<span class="token comment">//判断当前vue实例是否为根组件</span>
   <span class="token comment">// root 实例    </span>
   <span class="token comment">//root 实例的props属性应该被转换成响应式数据</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">toggleobserving</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>		<span class="token comment">//如果不是root实例不用响应侦测</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">const</span> key <span class="token keyword">in</span> propsoptions<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//propsOptions规格后的props选项</span>
       keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token comment">//将props选项key存入vm.$options._propKey中，因为其和key</span>
       <span class="token comment">//指向同一块内存地址</span>
       <span class="token keyword">const</span> value <span class="token operator">=</span><span class="token function">validateProp</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>propsoptions<span class="token punctuation">,</span>propsData<span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
       <span class="token comment">//validateProp 获取props选项值</span>
       <span class="token function">defineReactive</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
       <span class="token comment">// 将props选项值添加的vm._props数组上</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">proxy</span> <span class="token punctuation">(</span>vm<span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_props</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">,</span> key<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token function">toggleobserving</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取props选项值</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">validateProp</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> propOptions<span class="token punctuation">,</span> propData<span class="token punctuation">,</span> vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">const</span> prop <span class="token operator">=</span> propOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
   <span class="token keyword">const</span> absent <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>propData<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token comment">//标识是否不存在参数的props选项</span>
   <span class="token keyword">let</span> value <span class="token operator">=</span> propData<span class="token punctuation">[</span>key<span class="token punctuation">]</span>			 <span class="token comment">//value为props选项具体值</span>
   <span class="token comment">// 处理布尔类型的props</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isType</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">,</span>prop<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token comment">//如果是布尔类型</span>
       <span class="token comment">// 如果存在该props选项没有默认值且父组件也没有提供</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>absent <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>prop<span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           value <span class="token operator">=</span> <span class="token boolean">false</span>		<span class="token comment">// value值为false</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isType</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> prop<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token string">''</span><span class="token operator">||</span>value <span class="token operator">===</span> <span class="token function">hashenate</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token comment">// &lt;child name&gt;&lt;/child&gt;   父组件只提供了key</span>
           <span class="token comment">// &lt;child name=&quot;name&quot;&gt;&lt;/child&gt;	key值等于value值</span>
           <span class="token comment">// &lt;child userName=&quot;user-name&quot;&gt;&lt;/child&gt;</span>
           <span class="token comment">// hashenate(key)会将key转为 xx-xx 格式</span>
           value <span class="token operator">=</span> <span class="token boolean">true</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//如果value不是布尔类型值且父组件没有提供value值，检查是否存在默认值</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       value <span class="token operator">=</span> <span class="token function">getPropDefaultvalue</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>prop<span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token comment">//获取props默认值</span>
       <span class="token comment">//将默认值设为响应式</span>
       <span class="token keyword">const</span> prevShouldConvert <span class="token operator">=</span> observerState<span class="token punctuation">.</span>shouldConvert
       observerState<span class="token punctuation">.</span>shouldconvert <span class="token operator">=</span> <span class="token boolean">true</span>
       <span class="token function">observe</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
       observerState<span class="token punctuation">.</span>shouldConvert <span class="token operator">=</span> prevShouldConvert
   <span class="token punctuation">}</span>
   <span class="token comment">//判断当前运行环境是否是生产环境，如果不是，会调用assertProp来断言prop是否有效:</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span> <span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> &quot; production '<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">assertProp</span><span class="token punctuation">(</span> prop <span class="token punctuation">,</span> key <span class="token punctuation">,</span> value<span class="token punctuation">,</span> vm<span class="token punctuation">,</span>absent<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> value
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">assertProp</span><span class="token punctuation">(</span><span class="token parameter">prop<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> absent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//prop目标key规格化对象</span>
   <span class="token comment">//key名</span>
   <span class="token comment">//key值</span>
   <span class="token comment">//vm实例	absent不存在对应的key值 为true</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>required <span class="token operator">&amp;&amp;</span> absent<span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Missing required prop:&quot;'</span><span class="token operator">+</span>name<span class="token operator">+</span><span class="token string">'&quot;'</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
   <span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>prop<span class="token punctuation">.</span>required<span class="token punctuation">)</span><span class="token punctuation">{</span> 
   	<span class="token comment">// 使用了双等号，不管value是null或undefined都为true</span>
       <span class="token keyword">return</span> 
   <span class="token punctuation">}</span>
   <span class="token comment">// 获取目标props对象数据类型</span>
   <span class="token keyword">let</span> type <span class="token operator">=</span> prop<span class="token punctuation">.</span>type
   <span class="token comment">//如果用户有设置type则valid默认为false，否则为true</span>
   <span class="token keyword">let</span> valid  <span class="token operator">=</span><span class="token operator">!</span>type <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token boolean">true</span>
   <span class="token keyword">const</span> expectedTypes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//用于保存用户提供的数据类型</span>
   <span class="token keyword">if</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//如果用户设置了type</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//如果type不是数组</span>
           type <span class="token operator">=</span> <span class="token punctuation">[</span>type<span class="token punctuation">]</span>		    <span class="token comment">//将type转换成数组</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>type<span class="token punctuation">.</span>length<span class="token operator">&amp;&amp;</span><span class="token operator">!</span>valid <span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">const</span> assertedType <span class="token operator">=</span> <span class="token function">asserType</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> type<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
           <span class="token comment">//asserType返回数据类型和是否校验成功</span>
           expectedTypes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>assertedType<span class="token punctuation">.</span>expectedType <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">)</span>
           valid <span class="token operator">=</span> assertedType<span class="token punctuation">.</span>valid
       <span class="token punctuation">}</span>
       <span class="token comment">//结束循环后valid为是否校验成功，在expectedTypes存储支持的数据类型</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//校验不成功，发出警告</span>
       <span class="token function">warn</span><span class="token punctuation">(</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid prop: type check failed for prop &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; .</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Expected </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>expectedTypes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> capitalize<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span> <span class="token string">' , '</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">+</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> got $<span class="token punctuation">{</span><span class="token function">toRawType</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
vm
   	<span class="token keyword">return</span>
   <span class="token punctuation">}</span>
   <span class="token comment">//如果类型检查不通过，不会触发用户自定义的校验规则</span>
   <span class="token comment">//用户自定义的校验规则</span>
   <span class="token keyword">const</span> validator <span class="token operator">=</span> prop<span class="token punctuation">.</span>validator
   <span class="token comment">//不通过发出警告</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>validator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">validator</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">warn</span><span class="token punctuation">(</span>
<span class="token string">'Invalid prop: custom validator check failed for prop &quot;'</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'&quot;. '</span><span class="token punctuation">,</span>vm
   <span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><h3 id="初始化methods"><a href="#初始化methods" class="header-anchor">#</a> 初始化methods</h3> <p><font color="orange">循环选项的methods对象，并将属性依次挂载到vm上即可</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initMethods</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> methods</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> methods<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//只有方法名，没有具体值</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">....</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断方法名和props名字是否重复</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//如果methods方法名在vm存在同名的 且 methods方法名以$ 或者_开头</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>	<span class="token comment">//发出警告</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    vm<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span><span class="token keyword">null</span><span class="token operator">?</span>noop<span class="token operator">:</span><span class="token function">bind</span><span class="token punctuation">(</span>methods<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
    <span class="token comment">//不存在 将noop赋值到vm的该methods上，否则改变方法的绑定对象，可以vm.方法名调用</span>
    <span class="token comment">//bind(methods[key], vm) 返回一个新函数，即vm上调用这个新函数时，vm实例本身即为methods方法执行的this执行，参数为vm实例本身</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="初始化data"><a href="#初始化data" class="header-anchor">#</a> 初始化data</h3> <p><font color="orange">data中的数据最终会保存到<code>vm._data</code>中</font>，<font color="pink">然后在vm上配置一</font>个代理，通过vm.x访问到vm._data.x的属性，需要<font color="pink">调用observe将数据转换为响应式</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//需要增加些判断data的使用条件</span>
<span class="token keyword">function</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token operator">&amp;</span>options<span class="token punctuation">.</span>data
    data <span class="token operator">=</span> vm<span class="token punctuation">.</span>_data <span class="token operator">=</span> <span class="token keyword">typeof</span> data <span class="token operator">===</span> <span class="token string">'function'</span><span class="token operator">?</span><span class="token function">getData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token operator">:</span>data<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span>	
    <span class="token comment">//判断data是否是函数，是获取数据，</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//判断data是否是静态对象</span>
        data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token operator">&amp;&amp;</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'告知data应该返回一个对象'</span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将data代理到Vue.js示例上</span>
    <span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>	<span class="token comment">//获取data返回对象的所有属性</span>
    <span class="token keyword">const</span> props <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props
    <span class="token keyword">const</span> methods <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>methods
    <span class="token keyword">let</span> i <span class="token operator">=</span> keys<span class="token punctuation">.</span>length
    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token operator">!==</span><span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//在methods存在同名</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>methods <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>methods<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'....'</span><span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>props <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token punctuation">;</span><span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">warn</span><span class="token punctuation">(</span>
            	<span class="token string">'属性名已在props中声明'</span><span class="token punctuation">,</span> vm
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isReserved</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>       
    <span class="token punctuation">}</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/*asRootData*/</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> sharedPropertyDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>
    <span class="token literal-property property">set</span><span class="token operator">:</span> noop
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">proxy</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> sourceKey<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxyGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">proxySetter</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">[</span>sourceKey<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
	Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sharedProperty<span class="token punctuation">.</span>Definition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="初始化computed"><a href="#初始化computed" class="header-anchor">#</a> 初始化computed</h3> <p>computed是定义在vm上的一个特殊的<code>getter</code>方法，在vm上定义getter方法时，get并不是用户提供的函数，而是Vue.js内部的一个代理函数。在代理函数中可以结合watcher实现缓存与收集依赖等功能。</p> <p>计算属性的结果会被缓存，只有在计算属性依赖的响应式数据变化或者计算属性的返回值变化才会重新计算</p> <p>当<font color="orange">计算属性中的内容发生变化后</font>，计算属性的 watcher与组件的 watcher都会得到通知。计算属性的watcher 会将自己的dirty属性设置为true，当下一次读取计算属性时，就会重新计算一次值。然后组件的 watcher也会得到通知，从而执行render函数进行重新渲染的操作。由于要重新执行render函数，所以会重新读取计算属性的值，这时候计算属性的 watcher已经把自己的dirty属性设置为true，所以会重新计算一次计算属性的值，用于本次渲染。（<font color="orange">即计算属性会通过watcher来观察它所用到的所有属性的变化,当这些属性发生变化时，计算属性会将自身的 watcher的dirty属性设置为true，说明自身的返回值变了。</font>）</p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210926102823708.png" alt="image-20210926102823708" style="zoom:80%;"> <p>当计算属性所依赖的值变化时，会通知计算属性的<code>watcher</code>和组件模板的<code>watcher</code>，而计算属性会将自身的dirty置为true，模板会去读取计算属性，计算属性重新读取数据计算返回结果给模板进行视图更新。</p> <p><font color="orange">在定义计算属性时，需要判断userDef的类型是函数还是对象。如果是函数，则将函数理解为getter函数。如果是对象,则将对象的get方法作为getter方法, set方法作为setter方法。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token literal-property property">computed</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token comment">//函数</span>
    <span class="token function-variable function">aDouble</span><span class="token operator">:</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token operator">*</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//对象</span>
    <span class="token literal-property property">aplus</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token operator">+</span><span class="token number">1</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">set</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 具体实现</span>
<span class="token keyword">const</span> computedWatchOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">lazy</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">initComputed</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> computed</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token keyword">const</span> watchers <span class="token operator">=</span> vm<span class="token punctuation">.</span>_computedWatchers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
     <span class="token comment">// 计算属性在SSR环境（服务端渲染）中，只是一个普通的getter方法</span>
     <span class="token keyword">const</span> isSSR <span class="token operator">=</span> <span class="token function">isServerRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> computed<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">const</span> userDef <span class="token operator">=</span> computed<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
         <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> userDef <span class="token operator">:</span>userDef<span class="token punctuation">.</span>get
         <span class="token comment">//执行getter会返回计算属性结果</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span><span class="token string">'prodution'</span> <span class="token operator">&amp;&amp;</span> getter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'目标key不在生产环境下且不存在getter函数'</span><span class="token punctuation">,</span>vm<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token comment">//在不是服务端渲染的情况下</span>
         <span class="token comment">// 每个 computed 都创建一个 watcher</span>
         <span class="token comment">// watcher 用来存储计算值，判断是否需要重新计算</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isSSR<span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//当getter返回值发生变化，会将this.dirty置为true，计算属性会去重新获取计算结果，并将this,dirty置为false，随后通知相关依赖</span>
             watchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>
             vm<span class="token punctuation">,</span>
             getter<span class="token operator">||</span> noop<span class="token punctuation">,</span>
             noop<span class="token punctuation">,</span>
             computedWatcherOptions<span class="token punctuation">)</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>key <span class="token keyword">in</span> vm<span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token function">defineComputed</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> userDef<span class="token punctuation">)</span>
             <span class="token comment">//在vm上直接添加compuetd的代理函数</span>
         <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> production<span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$data<span class="token punctuation">)</span><span class="token punctuation">{</span>
                 <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'key已经在data中定义'</span><span class="token punctuation">)</span>
             <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>props <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">)</span><span class="token punctuation">{</span>
                 <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'key 已经在props中定义'</span><span class="token punctuation">)</span>
             <span class="token punctuation">}</span>		<span class="token comment">//只有data和props同名才会报错</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> sharedPropertyDefinition <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">get</span><span class="token operator">:</span> noop<span class="token punctuation">,</span>	<span class="token comment">//noop为空函数</span>
    <span class="token literal-property property">set</span><span class="token operator">:</span> noop
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">defineComputed</span> <span class="token punctuation">(</span><span class="token parameter">target，key<span class="token punctuation">,</span>userDef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//本函数目的是为了将computed的每一个属性加入到vm上</span>
    <span class="token keyword">const</span> shouldCache <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isserverRendering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//服务端渲染无需缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> userDef <span class="token operator">===</span> <span class="token string">&quot;function &quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//createComputedGetter将对象设为响应式，即在watcher内获取新数据并通知依赖，返回最新值，在服务端渲染下直接调用用户定义的</span>
    <span class="token comment">// 获取函数就行</span>
	sharedPropertyDefinition<span class="token punctuation">.</span>get <span class="token operator">=</span> shouldCache<span class="token operator">?</span> 
        <span class="token function">createComputedGetter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">:</span> userDef
	sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">=</span> noop
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	sharedPropertyDefinition<span class="token punctuation">.</span>get <span class="token operator">=</span> userDef<span class="token punctuation">.</span>get<span class="token operator">?</span>
        shouldcache <span class="token operator">&amp;&amp;</span> userDef<span class="token punctuation">.</span>cache <span class="token operator">!==</span> <span class="token boolean">false</span>
        <span class="token operator">?</span> <span class="token function">createcomputedGetter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token operator">:</span> userDef<span class="token punctuation">.</span>get
        <span class="token operator">:</span> noop
        sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">=</span> userDef<span class="token punctuation">.</span>set<span class="token operator">?</span> userDef<span class="token punctuation">.</span>set
        <span class="token operator">:</span> noop
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">' production'</span> <span class="token operator">&amp;&amp;</span>
        sharedPropertyDefinition<span class="token punctuation">.</span>set <span class="token operator">===</span> noop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sharedPropertyDefinition<span class="token punctuation">.</span><span class="token function-variable function">set</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'key被定义但没有set函数'</span> <span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token comment">//compuetd的目标key是一个对象</span>
	<span class="token punctuation">}</span><span class="token punctuation">}</span>
	object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target，key<span class="token punctuation">,</span>sharedPropertyDefinition<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 将computed对象设为响应式，此函数并不生成watcher，而是引用initComputed中事先生成的watcher</span>
<span class="token keyword">function</span> <span class="token function">createComputedGetter</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">computedGetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedwatchers <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedwatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token comment">//获取 computed对象的key</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>	
            <span class="token keyword">if</span> <span class="token punctuation">(</span> watcher<span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//dirty判断是否需要重新计算</span>
                watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//某个地方引用了本computed触发了此函数，将依赖收集</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>		<span class="token comment">//将读取计算属性的watcher添加到computed所依赖的数据的依赖列表中</span>
                watcher<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">//假设C是本computed，D引用了C，C引用了A、B，此行代码会将D引用C的watcher，添加到</span>
                <span class="token comment">//A和B的dep依赖列表中，以便其A或B更新是同时通知D                      </span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> watcher<span class="token punctuation">.</span>value	<span class="token comment">//返回计算属性值</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">watcher</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>expOrFn<span class="token punctuation">,</span>cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//没有传option默认为false	</span>
        <span class="token comment">//隐藏无关代码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy
            <span class="token operator">?</span> <span class="token keyword">undefined</span>
            <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">.</span>length		<span class="token comment">//      C依赖D（计算属性）   D依赖A和B</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>			  <span class="token comment">//C每次引用某个数据，便会生成一个watcher，此wathcer会加入到那个数据的dep实例，而这个实例，也会加入到watcer的deps中</span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span>deps<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//每个watcher的deps里存储的是：收集我的，全部属性，的dep实例</span>
            <span class="token comment">//依赖计算属性的watcher会加入到 计算属性所有依赖的dep中，因为当前的window.target 指向依赖计算属性的watcher</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> 
          <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br></div></div><p><font color="orange">当computed的结果引用了哪些数据，相应数据便会将computed引用的依赖加入到其依赖表，并在数据更新是通知computed，将<code>dirty</code>置为<code>true</code></font></p> <h4 id="解决计算属性结果没有改变但仍重新渲染的问题"><a href="#解决计算属性结果没有改变但仍重新渲染的问题" class="header-anchor">#</a> 解决计算属性结果没有改变但仍重新渲染的问题</h4> <p>解决思路是数据更新是只通知计算属性，不再同时通知计算属性和模板，计算属性发现数据是否变化再通知模板。</p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210926160546896.png" alt="image-20210926160546896" style="zoom:80%;"> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createComputedGetter</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> computedGetter <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_computedwatchers <span class="token operator">&amp;&amp;</span><span class="token keyword">this</span><span class="token punctuation">.</span>_computedwatchers<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            watcher<span class="token punctuation">.</span><span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//将使用此计算属性的依赖加入列表</span>
            <span class="token keyword">return</span> watcher<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 返回计算属性结果</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 新的wathcher</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token keyword">class</span> <span class="token class-name">Watcher</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> c<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>computed
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>computed <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>computed
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">//生成一个计算属性watcher的依赖列表</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>computed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span>subs<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>	<span class="token comment">//如果wathcer的dep为空</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">true</span>			    
        	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAndInvoke</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">getAndInvoke</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
            value <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">||</span>
            <span class="token function">isobject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>deep
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> oldvalue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">-</span> value
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token function">falseif</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">this</span><span class="token punctuation">.</span>user</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
        		<span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span>value<span class="token punctuation">,</span>oldvalue<span class="token punctuation">)</span>	<span class="token comment">//通知依赖更新</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>， <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span>'callback <span class="token keyword">for</span> watcher <span class="token string">&quot;${this.expression}&quot;</span>`<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">cb</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">,</span>value<span class="token punctuation">,</span>oldvalue<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token function">evaluate</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
    <span class="token punctuation">}</span>
    <span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dep <span class="token operator">&amp;&amp;</span> Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token comment">//将引用计算属性的watcher加入到 computed计算属性自己的依赖列表，即计算属性的依赖数据改变后，不会通知引用计算属性的状态，只会通知计算属性一个</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><h3 id="初始化watch"><a href="#初始化watch" class="header-anchor">#</a> 初始化watch</h3> <p>初始化状态的最后一步是初始化watch。在initstate函数的最后，有这样一行代码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span> opts<span class="token punctuation">.</span>watch <span class="token operator">&amp;&amp;</span> opts<span class="token punctuation">.</span>watch <span class="token operator">!==</span> nativewatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">initwatch</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span>opts<span class="token punctuation">.</span>watch<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><font color="orange">只有用户设置了<code>watch</code>选项且<code>watch</code>选项不等于原生watch时，才初始化<code>watch</code></font></p> <p>之所以使用这样的语句( <code>opts.watch !== nativewatch</code>)判断，是因为Firefox浏览器中的object.prototype 上有一个 watch 方法。当用户没有设置watch时，在 Firefox浏览器下的opts.watch将是object.prototype.watch函数，所以通过这样的语句可以避免这种问题。</p> <ul><li><p>类型：<code>{[key:string]:string|Function|Object|Array}</code></p></li> <li><p>介绍：一个对象，其中键是需要观察的表达式，值是对应的回调函数，也可以是方法名或者包含选项的对象。<font color="orange">Vue.js实例将会在实例化时调用<code>vm.$watch()</code>遍历watch对象的每一个属性。</font></p></li> <li><p>示例</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">watch</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token function-variable function">a</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot; new: %s, old: %s &quot;</span> <span class="token punctuation">,</span> val<span class="token punctuation">,</span> oldval<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">b</span><span class="token operator">:</span><span class="token string">'someMethod'</span><span class="token punctuation">,</span>
        <span class="token comment">// 深度</span>
        <span class="token literal-property property">c</span><span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token function-variable function">handler</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/**/</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">deep</span><span class="token operator">:</span><span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">//该回调将会在侦听开始之后被立即调用</span>
        <span class="token literal-property property">d</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
             <span class="token literal-property property">immediate</span><span class="token operator">:</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>，
		<span class="token literal-property property">e</span><span class="token operator">:</span> <span class="token punctuation">[</span>
			<span class="token keyword">function</span> <span class="token function">handle1</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ... */</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
             <span class="token keyword">function</span> <span class="token function">handle2</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldvai</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">/* ...*/</span><span class="token punctuation">}</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token comment">//watch vm.e.f's value: {g: 5}</span>
         <span class="token string-property property">'e.f'</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> oldval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/*... */</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
vm<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span>	<span class="token comment">//=&gt; new:2, old: 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div></li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">initWatch</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> watch</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> watch<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> handler <span class="token operator">=</span> watch<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token comment">// 遍历用户定于的所有watch</span>
        <span class="token comment">//如果某个watch是数组</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>handler<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//循环创建Watcher</span>
                <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
		   <span class="token comment">//普通对象或函数、字符串直接调用创建</span>
            <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> key<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">createWatcher</span><span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// handler是一个对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">isPlainobject</span><span class="token punctuation">(</span> handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        options <span class="token operator">=</span> handler		    <span class="token comment">//option 等于整个handler</span>
        handler <span class="token operator">=</span> handler<span class="token punctuation">.</span>handler	<span class="token comment">//handler等于对象上的handler</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">&quot;string &quot;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        handler <span class="token operator">=</span> vm<span class="token punctuation">[</span>handler<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vm<span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">,</span>handler<span class="token punctuation">,</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>遍历用户定义的watch的每一个属性，如果数组循环遍历，否则单个处理，根据类型的不同为每一个对象、字符串、函数调用<code>vm.$watch</code></p> <h3 id="初始化provide"><a href="#初始化provide" class="header-anchor">#</a> 初始化provide</h3> <p><font color="orange">	provide<u>选项应该是一个对象或者是返回一个对象的函数</u>。该对象包含可注入其子孙的属性。在该对象中，你可以使用 ES2015 Symbol作为 key，但是它只在原生支持Symbol和Reflect.ownKeys的环境下工作。</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">initProvide</span><span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> provide  <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>provide
    <span class="token comment">//获取当前vue示例上的provide</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>provide<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//这里首先判断provide的类型是否是函数,如果是,则执行函数,将返回值赋值给vm._provided,否则直接将变量provide赋值给vm._provided。</span>
        vm<span class="token punctuation">.</span>_provided <span class="token operator">=</span> <span class="token keyword">typeof</span> provide <span class="token operator">===</span> <span class="token string">'function'</span>
        	<span class="token operator">?</span><span class="token function">provide</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
        	<span class="token operator">:</span>provide
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="总结-8"><a href="#总结-8" class="header-anchor">#</a> 总结</h3> <p>​	本章详细介绍了<code>new Vue()</code>被执行时Vue.js 的背后发生了什么。</p> <p>​	Vue.js的整体生命周期可以分为4个阶段:<font color="orange">初始化阶段、模板编译阶段、挂载阶段和卸载阶段</font>。<font color="pink">初始化阶段结束后，会触发created 钩子函数</font>。<font color="orange">在 created钩子函数与beforeMount钩子函数之间的这个阶段是模板编译阶段</font>，这个阶段在不同的构建版本中不一定存在。挂载阶段在beforeMount钩子函数与<code>mounted</code>期间。<font color="orange">挂载完毕后，<code>Vue.js</code>处于已挂载阶段。已挂载阶段会持续追踪状态的变化，当数据（状态）发生变化时，watcher会通知虚拟DOM重新渲染视图。在渲染视图前触发beforeUpdate钩子函数，渲染完毕后触发updated钩子函数</font>。当vm.$destroy被调用时，组件进入卸载阶段。卸载前会触发<code>beforeDestroy</code>钩子函数，卸载后会触发destroyed钩子函数。</p> <p>​	new Vue()被执行后，Vue.js进入初始化阶段，<font color="orange">然后选择性进入模板编译与挂载阶段</font>。</p> <p>​	在初始化阶段，会分别初始化实例属性（<code>$options、$root、$parent</code>等）、事件（模板上绑定的事件，传给子组件的事件）、<code>provide/inject</code> 以及状态等，其中状态又包含 <code>props、methods、 data、computed 与 watch。</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_init</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>options<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>vm
        <span class="token punctuation">)</span> <span class="token comment">//合并选项对象</span>
    <span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化生命周期</span>
    <span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化事件	  指在父组件模板中使用v-on监听子组件内触发事件		</span>
    <span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化渲染</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>		<span class="token comment">//初始化阶段完成，触发钩子函数</span>
    <span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化Inject  在data/props前初始化</span>
    <span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化状态  props、methods、 data、computed、watch	</span>
    <span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// 初始化Provide    //在data/props后初始化</span>
    <span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
    
	<span class="token comment">//如果用户在实例化Vue.js时传递了el选项，则自动开启模板编译阶段与挂载阶段</span>
    <span class="token comment">//如果没有传递el选项，则不进入下一个生命周期流程</span>
	<span class="token comment">//用户需要执行vm. $mount方法，手动开启模板编译阶段与挂载阶段</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span> <span class="token function">$mount</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h2 id="指令的奥秘"><a href="#指令的奥秘" class="header-anchor">#</a> 指令的奥秘</h2> <h3 id="什么是指令"><a href="#什么是指令" class="header-anchor">#</a> 什么是指令</h3> <p>​	指令( directive)是Vue.js提供的带有v-前缀的特殊特性。指令属性的值预期是单个JavaScript表达式。指令的职责是，当表达式的值改变时，将其产生的连带影响响应式地作用于DOM。</p> <h3 id="指令的原理"><a href="#指令的原理" class="header-anchor">#</a> 指令的原理</h3> <p>​	<font color="orange">在模板解析阶段，我们在将指令解析到AST</font>，然后<font color="orange">使用AST生成代码字符串的过程中实现某些内置指令的功能，最后在虚拟DOM渲染的过程中触发自定义指令的钩子函数使指令生效。</font></p> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210928160909839.png" alt="image-20210928160909839" style="zoom:80%;"> <p>​	<code>directives</code>数据会传递到<code>Vnode</code>中，可以通过<code>vnode.data.directives</code> 获取一个节点的指令。</p> <p>​		最后，当虚拟DOM进行修补时，会根据节点的对比结果触发一些钩子函数。更新指令的程序会监听<code>create , update和destroy</code>（<font color="orange">操作节</font>点）钩子函数,并在这三个钩子函数触发时对VNode和oldVNode进行对比，最终根据对比结果触发指令的钩子函数。(使用自定义指令时，可以监听5种钩子函数:<code>bind、inserted、update、 componentUpdated与unbind</code>)指令的钩子函数被触发后，就说明指令生效了。</p> <h4 id="v-if指令的原理"><a href="#v-if指令的原理" class="header-anchor">#</a> <code>v-if</code>指令的原理</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>has<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>if<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-else</span><span class="token punctuation">&gt;</span></span>else<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;代码字符串&lt;--&gt;</span>
(has)?_c( 'li',[_v(&quot;if&quot;)]):_c( 'li',[_v(&quot;else&quot;)])
<span class="token comment">&lt;!--&gt;格式化代码字符串&lt;--&gt;</span>
(has)
	?_c( 'li',[_v(&quot;if&quot;)])
	:_c( 'li',[_v(&quot;else&quot;)])
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="v-for指令原理"><a href="#v-for指令原理" class="header-anchor">#</a> <code>v-for</code>指令原理</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item, index) in list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>v-for{{index}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;代码字符串&lt;--&gt;</span>
_l((list),function(item,index){return _c( 'li',[_v(&quot;v-for &quot;+_s(index))])})
<span class="token comment">&lt;!--&gt;格式化代码字符串&lt;--&gt;</span>
_l((list),function(item,index){
	return _c( 'li',[
		_v(&quot;v-for &quot;+_s(index))
	])
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><font color="orange"><code>_l</code>是函数<code>renderList</code>的别名，当执行此函数时，<code>_l</code>会循环遍历list，并依次调用第二个参数所传递的函数。同时传递参数：item、index，此外，当<code>_c</code>函数执行时，会调用<code>_v</code>生成文本节点<code>li</code></font></p> <h4 id="v-on-指令"><a href="#v-on-指令" class="header-anchor">#</a> <code>v-on</code> 指令</h4> <p>​	<code>v-on</code>指令的作用是绑定事件监听器，事件类型由参数指定。它用在普通元素上时，可以监听原生DOM事件;用在自定义元素组件上时，可以监听子组件触发的自定义事件。</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name"><span class="token namespace">v-on:</span>click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>doWhat<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>我是按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;在Vnode中，可以通过vnode.data.on 读出以下事件对象&lt;--&gt;</span>
<span class="token comment">&lt;!--&gt;事件函数会在执行渲染函数生成虚拟节点时加入到vnode的data.on 属性上&lt;--&gt;</span>
{
	click:function(){}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>虚拟节点DOM在<code>patch</code>过程中会根据不同时机触发不同钩子函数</p> <p>​	事件绑定相关的处理逻辑分别设置了create与 update钩子函数，也就是说在修补的过程中，每当一个DOM元素被创建或更新时，都会触发事件绑定相关的处理逻辑。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> target  
<span class="token keyword">function</span> <span class="token function">updateDOMListeners</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>on<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> on <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>on <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> oldOn <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>on <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    target <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm		<span class="token comment">//保存当前DOM节点的DOM元素</span>
    <span class="token function">normalizeEvent</span><span class="token punctuation">(</span>on<span class="token punctuation">)</span>	
    <span class="token function">updateListeners</span><span class="token punctuation">(</span>on<span class="token punctuation">,</span> oldOn<span class="token punctuation">,</span> add<span class="token punctuation">,</span> remove<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span> <span class="token comment">//vnode.context vue实例</span>
    target <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> once<span class="token punctuation">,</span> capture<span class="token punctuation">,</span> passive</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    handler <span class="token operator">=</span> <span class="token function">withMacroTask</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token comment">//如果回到触发了视图更新加入宏任务队列</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>once<span class="token punctuation">)</span> handler <span class="token operator">=</span> <span class="token function">createOnceHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> event<span class="token punctuation">,</span> capture<span class="token punctuation">)</span><span class="token comment">//回调只触发一次</span>
    target<span class="token punctuation">.</span><span class="token function">addEventListeners</span><span class="token punctuation">(</span>
        event<span class="token punctuation">,</span>				<span class="token comment">//事件名</span>
        supportsPassive<span class="token punctuation">,</span>	 <span class="token comment">//回调函数</span>
        	<span class="token operator">?</span><span class="token punctuation">{</span>capture<span class="token punctuation">,</span> passive<span class="token punctuation">}</span>		
        	<span class="token operator">:</span>capture
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createOnceHandler</span><span class="token punctuation">(</span><span class="token parameter">handler<span class="token punctuation">,</span> event<span class="token punctuation">,</span> capture</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> _target <span class="token operator">=</span> target		<span class="token comment">//在闭包保存当前目标元素</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">onceHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">remove</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> onceHandler<span class="token punctuation">,</span> capture<span class="token punctuation">,</span> _target<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">remove</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span>handler<span class="token punctuation">,</span>capture，_target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span> _target <span class="token operator">||</span> target <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
        event<span class="token punctuation">,</span>
        handler<span class="token punctuation">.</span>_withTask <span class="token operator">||</span> handler<span class="token punctuation">,</span>
        capture
	<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="自定义指令内部原理"><a href="#自定义指令内部原理" class="header-anchor">#</a> 自定义指令内部原理</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">create</span><span class="token operator">:</span> updateDirectives<span class="token punctuation">,</span>
    <span class="token literal-property property">update</span><span class="token operator">:</span> updateDirectives<span class="token punctuation">,</span>
    <span class="token function-variable function">destory</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">unbindDirectives</span><span class="token punctuation">(</span><span class="token parameter">vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">updateDirectives</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> emptyNode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">updateDirectives</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives <span class="token operator">||</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">_update</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">_update</span> <span class="token punctuation">(</span><span class="token parameter">oldvnode<span class="token punctuation">,</span>vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isCreate <span class="token operator">=</span> oldvnode <span class="token operator">===</span> emptyNode
    <span class="token keyword">const</span> isDestroy <span class="token operator">=</span> vnode <span class="token operator">===</span> emptyNode
    <span class="token keyword">const</span> oldDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives，oldVnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
    <span class="token keyword">const</span> newDirs <span class="token operator">=</span> <span class="token function">normalizeDirectives</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>directives，vnode<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
    <span class="token keyword">const</span> dirswithInsert <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> dirswithPostpatch <span class="token operator">-</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> key<span class="token punctuation">,</span> oldDir<span class="token punctuation">,</span> dir
    <span class="token keyword">for</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> newDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldDir <span class="token operator">=</span> oldDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        dir <span class="token operator">=</span> newDirs <span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> loldDir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//新指令，触发bind</span>
            <span class="token function">callHook</span><span class="token punctuation">(</span> dir<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldvnode<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">.</span>inserted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dirswithInsert<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">//指令已存在，触发updale</span>
            dir<span class="token punctuation">.</span>oldvalue <span class="token operator">=</span> oldDir<span class="token punctuation">.</span>value
            <span class="token function">callHook</span><span class="token punctuation">(</span>dir，<span class="token string">&quot; update &quot;</span> <span class="token punctuation">,</span> vnode，oldVnode<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">.</span>componentUpdated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dirswithPostpatch<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dirswithinsert<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token function-variable function">callInsert</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirswithInsert<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">callHook</span><span class="token punctuation">(</span> dirswithInsert<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> 'inserted &quot; <span class="token punctuation">,</span> vnode，oldVnode<span class="token punctuation">)</span>
                 <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iscreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">mergeVNodeHook</span><span class="token punctuation">(</span> vnode<span class="token punctuation">,</span> <span class="token string">&quot;insert &quot;</span><span class="token punctuation">,</span> callInsert<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">callInsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirswithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">mergevNodeHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span><span class="token string">&quot;postpatch&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dirswithPostpatch<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">cailHook</span><span class="token punctuation">(</span>dirswithPostpatch<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'componentUpdated '</span> <span class="token punctuation">,</span> vnode，oldVnode<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>iscreate<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> key <span class="token keyword">in</span> oldDirs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>newDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//指令不再存在，触发unbind</span>
                    <span class="token function">callHook</span><span class="token punctuation">(</span>oldDirs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span>'unbind &quot; <span class="token punctuation">,</span> oldVnode，oldVnode，isDestroy<span class="token punctuation">)</span>
             <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
            
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">callHook</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> dir<span class="token punctuation">.</span>def <span class="token operator">&amp;&amp;</span> dir<span class="token punctuation">.</span>def<span class="token punctuation">[</span>hook<span class="token punctuation">]</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> oldVnode<span class="token punctuation">,</span> isDestroy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">handlerError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>context<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">directive </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dir<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hook<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> hook</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>该函数接收接收5个参数</p> <ul><li>dir：指令对象</li> <li>hook：将要触发的钩子函数名</li> <li>vnode：新虚拟节点</li> <li>oldVnode：旧虚拟节点</li> <li>isDestroy：当新虚拟节点不存在而旧虚拟节点存在时为真时</li></ul> <h3 id="虚拟dom钩子函数"><a href="#虚拟dom钩子函数" class="header-anchor">#</a> 虚拟DOM钩子函数</h3> <img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20210929142755364.png" alt="image-20210929142755364" style="zoom:80%;"> <h2 id="过滤器的奥秘"><a href="#过滤器的奥秘" class="header-anchor">#</a> 过滤器的奥秘</h2> <h3 id="过滤器用法及定义"><a href="#过滤器用法及定义" class="header-anchor">#</a> 过滤器用法及定义</h3> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;在花括号中&lt;--&gt;</span>
{{message | capitalize}}
<span class="token comment">&lt;!--&gt;在v-bind中&lt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name"><span class="token namespace">v-bind:</span>id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rwaId | formatId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--&gt;串联过滤&lt;--&gt;</span>
{{message | capitalize1 | capitalize2}}
<span class="token comment">&lt;!--&gt;含参数过滤&lt;--&gt;</span>
{{message | capitalize | suffix('!',' xx')}}  <span class="token comment">&lt;!--&gt;第一个参数是message、第二个是 ！、第三个是 xx&lt;--&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//定义全局过滤器</span>
<span class="token literal-property property">filters</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token function-variable function">capitalize</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span>
        value <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">chartAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>value<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="过滤器原理概述"><a href="#过滤器原理概述" class="header-anchor">#</a> 过滤器原理概述</h3> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>{{message | capitalize }}
<span class="token comment">&lt;!--&gt;这个过滤器在模板编译阶段会编译成下面的样子&lt;--&gt;</span>
_s(_f(&quot;capitalize&quot; )( message))
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中 _s是 <code>toString()</code>函数的别名，其处理结果会直接渲染视图并保存到Vnode的text属性中</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> val <span class="token operator">==</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token keyword">typeof</span> val <span class="token operator">===</span> <span class="token string">'object'</span>
    <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>_f</code>函数是<code>resolveFilter</code>函数的别名，其作用是从<code>this.$options.filters</code> 中找出注册的过滤器并返回。因此,上面例子中的<code>_f(&quot;capitalize&quot;)</code>与<code>this.$options.filters[ ' capitalize']</code>相同。而<code>this. $options.filters[ ' capitalize']</code>就是我们注册的<code>capitalize</code>过滤器函数:</p> <h4 id="串联过滤器"><a href="#串联过滤器" class="header-anchor">#</a> 串联过滤器</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>{{message | capitalize | suffix}}
<span class="token comment">&lt;!--&gt;过滤结果如下&lt;--&gt;</span>
_s(_f(&quot;suffix&quot;)(_f(&quot;capitalize&quot;)(message)))
<span class="token comment">&lt;!--&gt;第一个过滤器结果作为第二个过滤器的参数&lt;--&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><img src="https://cdn.jsdelivr.net/gh/FrancisSaber/image/markdown-Imageimage-20211001212508373.png" alt="image-20211001212508373" style="zoom:80%;"> <h4 id="接收参数"><a href="#接收参数" class="header-anchor">#</a> 接收参数</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;含参串联过滤器&lt;--&gt;</span>
{{ message | capitalize('x') | suffix('y')}}
<span class="token comment">&lt;!--&gt;编译结果&lt;--&gt;</span>
_s(_f('suffix')(_f('capitalize')(message, 'x'), y)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="resolvefilter-内部原理"><a href="#resolvefilter-内部原理" class="header-anchor">#</a> <code>resolveFilter</code> 内部原理</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>identify<span class="token punctuation">,</span> resolveAsset<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'core/util/index'</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveFilter</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>		<span class="token comment">//id为过滤器ID</span>
    <span class="token keyword">return</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'filters'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">||</span> identify
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">identify</span> <span class="token operator">=</span> <span class="token parameter">_</span><span class="token operator">=&gt;</span>_

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span><span class="token parameter">options<span class="token punctuation">,</span> type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> warnMissing</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> id <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token keyword">const</span> assets <span class="token operator">=</span> options<span class="token punctuation">[</span>type<span class="token punctuation">]</span>	<span class="token comment">//返回实例上的filter对象</span>
    <span class="token comment">// 检查本地注册的变动</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>assets<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token comment">//寻找对应的过滤器</span>
    <span class="token keyword">const</span> camelizedId <span class="token operator">=</span> <span class="token function">camelize</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>	<span class="token comment">//将ID驼峰化再次寻找</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasOwn</span><span class="token punctuation">(</span> assets<span class="token punctuation">,</span> camelizedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>camelizedId<span class="token punctuation">]</span>
    <span class="token keyword">const</span> PascalcaseId <span class="token operator">=</span> <span class="token function">capitalize</span><span class="token punctuation">(</span>camelizedId<span class="token punctuation">)</span>	<span class="token comment">//首字母大写寻找</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>assets，PascalcaseId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>
    <span class="token comment">//检查原型链</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> assets<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span> camelizedId<span class="token punctuation">]</span> <span class="token operator">||</span> assets<span class="token punctuation">[</span>PascalCaseId<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> warnMissing <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    	<span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'错误信息'</span>， options<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> res
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="解析过滤器"><a href="#解析过滤器" class="header-anchor">#</a> 解析过滤器</h3> <p>在Vue.js内部，<code>src/compiler/parser/filter-parser.js</code>文件中提供了一个<code>parseFilters</code>函数，专门用来解析过滤器，它可以将模板过滤器解析成过滤器函数调用表达式。这个逻辑并不复杂，我们只需要在解析出过滤器列表后，循环过滤器列表并拼接一个字符串即可。其代码如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">parseFilters</span><span class="token punctuation">(</span><span class="token parameter">exp</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> filter <span class="token operator">=</span> exp<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token comment">//将过滤器内容根据|生成数组</span>
    <span class="token keyword">let</span> expression <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//取第一个元素取出空格</span>
    <span class="token keyword">let</span> i
    <span class="token keyword">if</span><span class="token punctuation">(</span>filters<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> filters<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            expression <span class="token operator">=</span> <span class="token function">wrapFilter</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> filters<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">//不断获取下一个过滤器值形成代码字符串</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> expression
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">wrapFilter</span><span class="token punctuation">(</span><span class="token parameter">exp<span class="token punctuation">,</span> filter</span><span class="token punctuation">)</span><span class="token punctuation">{</span>	<span class="token comment">//第一个参数是已生成的代码字符串，作为接下来的参数</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">)</span>	<span class="token comment">//判断是否含参</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// _f: resolveFilter</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_f(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>filter<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>	<span class="token comment">//不含参直接形成代码字符串</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> name <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
        <span class="token keyword">const</span> args <span class="token operator">=</span> filter<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_f(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>exp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="总结-9"><a href="#总结-9" class="header-anchor">#</a> 总结</h3> <p>​	过滤器的原理是:在编译阶段将过滤器编译成函数调用，串联的过滤器编译后是一个嵌套的函数调用，前一个过滤器函数的执行结果是后一个过滤器函数的参数。</p> <p>​	编译后的<code>_f</code>函数是resolveFilter函数的别名，<code>resolveFilter</code>函数的作用是找到对应的过滤器并返回。</p> <h2 id="实际运用"><a href="#实际运用" class="header-anchor">#</a> 实际运用</h2> <h3 id="为列表渲染设置属性key"><a href="#为列表渲染设置属性key" class="header-anchor">#</a> 为列表渲染设置属性key</h3> <p>在更新子节点时，需要从旧虚拟节点列表中查找与新虚拟节点相同的节点进行更新。如果这个查找过程设置了属性key，那么查找速度会快很多。</p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item in items<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item.id<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 内容--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="在v-if-v-if-else-v-else-中使用key"><a href="#在v-if-v-if-else-v-else-中使用key" class="header-anchor">#</a> 在<code>v-if/v-if-else/v-else</code> 中使用<code>key</code></h3> <p><code>v-if</code>编译后为如下代码字符串</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span>has<span class="token punctuation">)</span>
	<span class="token operator">?</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;if&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token operator">:</span><span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;else&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>​		当状态发生变化时,生成的虚拟节点既有可能是v-if上的虚拟节点,也有可能是v-else上的虚拟节点。
​		默认情况下，Vue.js 会尽可能高效地更新DOM。这意味着，<font color="orange">当它在相同类型的元素之间切换时，会修补已存在的元素，而不是将旧的元素移除，然后在同一位置添加一个新元素。如果本不相同的元素被识别为相同，则会出现意料之外的副作用</font>。
​		如果添加了属性 key，那么在比对虚拟DOM时，则会认为它们是两个不同的节点，于是会将旧元素移除并在相同的位置添加一个新元素，从而避免意料之外的副作用。
<font color="orange">		因此在使用<code>v-if</code>的同时最好加上<code>key</code>属性</font></p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>error<span class="token punctuation">&quot;</span></span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>search-status<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    错误: {{ error }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-else</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>search-results<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	{{ results }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="路由切换组件不变"><a href="#路由切换组件不变" class="header-anchor">#</a> 路由切换组件不变</h3> <p>​		解决页面切换到同一个路由但不同的参数地址时，组件的生命钩子函数并不会触发。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'detail/:id'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'detail'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">component</span><span class="token operator">:</span>Detail
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>​		当从路由<code>/detail/1</code>切换到<code>/detail/2</code>时，<font color="orange">组件是不会发生任何变化的。</font></p> <h4 id="通过设置导航守卫beforerouteupdate解决"><a href="#通过设置导航守卫beforerouteupdate解决" class="header-anchor">#</a> 通过设置导航守卫beforeRouteUpdate解决</h4> <p>​		在Vue.js 实例中使用</p> <p>​		vue-router提供了导航守卫<code>beforeRouteUpdate</code>，<font color="orange">该守卫在当前路由改变且组件被复用时调用</font>，所以可以在组件内定义路由导航守卫来解决这个问题。
​		<font color="orange">组件的生命周期钩子虽然不会重新触发，但是路由提供的<code>beforeRouteUpdate</code>守卫可以被触发。</font>因此，<font color="orange">只需要把每次切换路由时需要执行的逻辑放到<code>beforeRouteUpdate</code>守卫中即可</font>。例如，在 <code>beforeRouteUpdate</code>守卫中发送请求拉取数据，更新状态并重新渲染视图。这种方式是我最推荐的一种方式，在 vue-router2.2之后的版本可以使用。</p> <h4 id="观察-route对象的变化"><a href="#观察-route对象的变化" class="header-anchor">#</a> 观察$route对象的变化</h4> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'...'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">watch</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">'$route'</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//对路由变化做出响应</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>​		这种方式也可以解决上述问题，但代价是组件内多了一个watch，这会带来依赖追踪的内存开销。
​		如果最终选择使用watch解决这个问题,那么在某些场景下我推荐<font color="orange">在组件里只观察自己需要的query，这样有利于减少不必要的请求。</font>
​		假设有这样一个场景，页面中有两部分内容，上面是个人的描述信息，下面一个带翻页的列表，这时假设路由中的参数是/user?id=4&amp;page=1时，说明用户ID是4，列表是第一页。
我们可以断定每次翻页时只需要发送列表的请求,而个人的描述信息只需要第一次进入组件时请求一次即可。当翻到第二页时，路由应该是这样的:<code>/user?id=4&amp;page=2</code>。
​		可以看到，参数中的id没有变，只有 page变了。所以为了避免发送多余的请求，应该这样去观察路由:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">template</span><span class="token operator">:</span><span class="token string">'...'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">watch</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">'$route.query.id'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        	<span class="token comment">//请求个人描述信息    </span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">'$route.query.page'</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//请求列表</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><font color="orange">既具体观察路由query对象的某个具体属性</font></p> <h4 id="为route-view设置属性key"><a href="#为route-view设置属性key" class="header-anchor">#</a> 为route-view设置属性key</h4> <p>​		这种做法非常取巧，非常“暴力”，但非常有效。它本质上是利用虚拟DOM在渲染时通过key来对比两个节点是否相同的原理。<font color="orange">通过给router-view组件设置key，可以使每次切换路由时的key都不一样，让虚拟DOM认为router-view组件是一个新节点，从而先销毁组件,然后再重新创建新组件。即使是相同的组件，但是如果url变了，key就变了，Vue.js就会重新创建这个组件。</font>
​		<font color="orange">因为组件是新创建的，所以组件内的生命周期会重复触发</font>。示例如下:</p> <p>​		<!----></p> <p>此方法非常浪费性能，优点是更明显，改动小。</p> <h3 id="为所有路由统一添加query"><a href="#为所有路由统一添加query" class="header-anchor">#</a> 为所有路由统一添加query</h3> <p>​		如果路由上的 query 中有一些是从上游链路上传下来的，那么需要在应用的任何路由中携带，但是在所有跳转路由的地方都设置一遍会非常麻烦。例如，在应用中的所有路由上都加上参数:<code>https:/berwin.me/a?referer=hao360cn</code>和 https://berwin.me/b?referer=hao360cn。</p> <h4 id="使用全局守卫beforeeach"><a href="#使用全局守卫beforeeach" class="header-anchor">#</a> 使用全局守卫beforeEach</h4> <p>​		具体思路：通过触发<code>beforeEach</code>时使用<code>next</code>中断当前导航，切换新导航并添加<code>query</code>，但需要解决由于再次进入新导航会循环触发<code>beforeEach</code>的问题</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">referer</span><span class="token operator">:</span><span class="token string">'hao360cn'</span><span class="token punctuation">}</span>
router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    to<span class="token punctuation">.</span>query<span class="token punctuation">.</span>referer		<span class="token comment">//判断路由的query对象是否包含referer对象</span>
    <span class="token operator">?</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>				    <span class="token comment">//包含直接跳转</span>
    <span class="token operator">:</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token operator">...</span>to<span class="token punctuation">,</span> <span class="token literal-property property">query</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token operator">...</span>to<span class="token punctuation">.</span>query<span class="token punctuation">.</span> <span class="token operator">...</span>query<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>	<span class="token comment">//否则添加进入新导航</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><font color="orange">在 beforeEach 中判断这个全局添加的参数在路由对象中是否存在，如果存在，则不开启新导航:</font></p> <p><font color="orange">这种方式的优点是，可以全局统一配置公共的query参数，并且在组件内切换路由时无须进行特殊处理。缺点是每次切换路由时，全局守卫beforeEach 会执行两次，即每次切换路由其实是切换两次。</font></p> <h4 id="使用函数劫持"><a href="#使用函数劫持" class="header-anchor">#</a> 使用函数劫持</h4> <p>​		通过修改源码避免两个切换路由的方法
​		这种方式的原理是:通过拦截<code>router.history.transitionTo</code>方法，<font color="orange">在<code>vue-router</code>内部在切换路由之前将参数添加到<code>query</code> 中</font>。其使用方式如下:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">referer</span><span class="token operator">:</span> 'hao368cn &quot;<span class="token punctuation">}</span>
<span class="token keyword">const</span> transitionTo <span class="token operator">=</span> router<span class="token punctuation">.</span>history<span class="token punctuation">.</span>transitionTo
router<span class="token punctuation">.</span>history<span class="token punctuation">.</span><span class="token function-variable function">transitionTo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">location，onComplete，onAbort</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    location <span class="token operator">=</span> <span class="token keyword">typeof</span> location <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span>		
	<span class="token operator">?</span> <span class="token punctuation">{</span><span class="token operator">...</span>location<span class="token punctuation">,</span> <span class="token literal-property property">query</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span>location<span class="token punctuation">.</span>query<span class="token punctuation">,</span> <span class="token operator">...</span>query<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token literal-property property">path</span><span class="token operator">:</span> location<span class="token punctuation">,</span> query<span class="token punctuation">}</span>
	<span class="token function">transitionTo</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span>history<span class="token punctuation">,</span> location<span class="token punctuation">,</span> onComplete<span class="token punctuation">,</span> onAbort<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language- extra-class"><pre><code>	代码中，先将vue-router内部的router.history.transitionTo方法缓存到变量transitionTo中。随后使用一个新的函数重写router.history.transitionTo方法，通过在函数中修改参数来达到全局添加 query参数的目的。当执行缓存的原始方法时，将修改后的参数传递进去即可。
	这种方式的优点是可以全局添加 query参数并且不会导致路由切换两次。缺点是通过修改vue-router内部方法实现目的，这是一种很危险的操作。
</code></pre></div><h3 id="区分vuex和props的使用边界"><a href="#区分vuex和props的使用边界" class="header-anchor">#</a> 区分Vuex和props的使用边界</h3> <p>​		在项目开发过程中，业务组件使用Vuex维护状态，使用不同组件统一操作Vuex中的状态。</p> <p>​		对于通用组件，使用props 以及事件进行父子组件间的通信(通用组件不需要兄弟组件间的通信)。这样做是因为通用组件会拿到各个业务组件中使用，它要与业务解耦，所以需要使用props 获取状态。</p> <div class="language- extra-class"><pre><code>	通用组件要定义细致的prop，并且尽可能详细，至少需要指定其类型。这样做的好处是:
	写明了组件的API，所以很容易看懂组件的用法;
	在开发环境下，如果向一个组件提供格式不正确的 prop，Vue.js 将会在控制台发出警告，帮助我们捕获潜在的错误来源。
</code></pre></div><h3 id="避免v-if和v-for一起使用"><a href="#避免v-if和v-for一起使用" class="header-anchor">#</a> 避免v-if和v-for一起使用</h3> <p>通常,我们在下面两种常见的情况下，会倾向于不同的做法。</p> <ul><li><p>为了过滤一个列表中的项目（比如v-for=&quot;user in users&quot; v-if=&quot;user.isActive&quot; ) ,请将<code>users</code>替换为一个计算属性（比如 activeUsers ) ，让它返回过滤后的列表。</p></li> <li><p>为了避免渲染本应该被隐藏的列表（比如v-for=&quot;user in users&quot; v-if=&quot;shouldShow-
Users&quot;&quot; )，请将<code>v-if</code>移动至容器元素上（比如ul和 ol )。</p></li> <li><div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;情况1&lt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user in userList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{user.name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
computed:{
	userList:function(){		<span class="token comment">&lt;!--&gt;返回要渲染的userList&lt;--&gt;</span>
		return this.users.filter(function(user){
			return user.isActive 
		})
	}
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token comment">&lt;!--&gt;情况2&lt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ol</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>shouldShow<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user in userList<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    {{user.name}}
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ol</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h3 id="为组件设置作用域"><a href="#为组件设置作用域" class="header-anchor">#</a> 为组件设置作用域</h3> <p>​		CSS的规则都是全局的，任何一个组件的样式规则都对整个页面有效。因此，我们很容易在一个组件中写了某个样式，而不小心影响了另一个组件的样式，或者自己的组件被第三方库的CSS影响了。
​		<font color="orange">对于应用来说，最佳实践是只有顶级App 组件和布局组件中的样式可以是全局的，其他所有组件都应该是有作用域的。</font></p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
 	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">	<span class="token selector">//使用scoped
    .btn</span><span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span>none
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-vue line-numbers-mode"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[$style.button，$style.buttonclose]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>X<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--使用CSS Modules--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">.button</span> <span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 2px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token selector">.buttonClose</span> <span class="token punctuation">{</span>
        <span class="token property">background-color</span><span class="token punctuation">:</span> red <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="避免在scoped中使用元素选择器"><a href="#避免在scoped中使用元素选择器" class="header-anchor">#</a> 避免在scoped中使用元素选择器</h3> <p>​		在<code>scoped</code>样式中，类选择器比元素选择器更好，因为大量使用元素选择器是很慢的。为了给样式设置作用域，<font color="orange">Vue.js会为元素添加一个独一无二的特性，例如data-v-f3f3eg9。</font>然后修改选择器，使得在匹配选择器的元素中，只有带这个特性的才会真正生效（比如<code>button[ data-v-f3f3eg9]</code>)。
​		问题在于，<font color="orange">大量的元素和特性组合的选择器（比如 <code>button[data-v-f3f3eg9]</code>)会比类和特性组合的选择器慢．所以应该尽可能选用类选择器。</font></p> <p><font color="orange">即最好通过类名修改目标元素样式，避免通过元素名直接修改</font></p> <h3 id="避免隐形的父子组件通信"><a href="#避免隐形的父子组件通信" class="header-anchor">#</a> 避免隐形的父子组件通信</h3> <p>​		应该优先通过prop和事件进行父子组件之间的通信，而不是使用 <code>this.$parent</code>或改变<code>prop</code></p> <p>​		<font color="pink">一个理想的 Vue.js应用是“prop向下传递，事件向上传递”。遵循这一约定会让你的组件更容易理解。然而，在一些边界情况下，prop 的变更或this.$parent能够简化两个深度耦合的组件。</font></p> <h3 id="单文件组件如何命名"><a href="#单文件组件如何命名" class="header-anchor">#</a> 单文件组件如何命名</h3> <h4 id="单文件组件的文件名的大小写"><a href="#单文件组件的文件名的大小写" class="header-anchor">#</a> 单文件组件的文件名的大小写</h4> <p>​		单文件组件的文件名应该始终是单词首字母大写( PascalCase )，或者始终是横线连接的( kebab-case )。</p> <p>​		<font color="orange">单词首字母大写对于代码编辑器的自动补全最为友好</font>，<font color="orange">因为这会使JS(X)和模板中引用组件的方式尽可能一致</font>。然而，混用文件的命名方式有时候会导致文件系统对大小写不敏感的问题，这也是横线连接命名可取的原因。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>components/
|- MyComponent.vue
------------------------
components/
|- my-component.vue
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="基础组件名"><a href="#基础组件名" class="header-anchor">#</a> 基础组件名</h4> <h4 id="单例组件名-不可复用组件"><a href="#单例组件名-不可复用组件" class="header-anchor">#</a> 单例组件名（不可复用组件）</h4> <p>​		只拥有单个活跃实例的组件以The前缀命名，以示其唯一性。但这并不意味着组件只可用于一个单页面，而是每个页面只使用一次<font color="orange">。这些组件永远不接受任何 prop，因为它们是为你的应用定制的，而不是应用中的上下文。如果你发现有必要添加 prop，就表明这实际上是一个可复用的组件，只是目前在每个页面里只使用了一次。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>//比如后台管路系统的整体布局样式组件
components/
|- TheHeading.vue
|- TheSidebar.vue
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="紧密耦合的组件名"><a href="#紧密耦合的组件名" class="header-anchor">#</a> 紧密耦合的组件名</h4> <p>​		<font color="orange">和父组件紧密耦合的子组件应该以父组件名作为前缀命名。</font>
​		<font color="orange">如果一个组件只在某个父组件的场景下有意义，那么这层关系应该体现在其名字上。编辑器通常会按字母顺序组织文件，这样做可以把相关联的文件排在一起。</font>
​		通常，我们可以通过在父组件命名的目录中嵌套子组件以解决这个问题。
​	<font color="orange">	但是许多文件的名字相同，这使得在编辑器中快速切换文件变得困难；过多嵌套的子目录增加了在编辑器侧边栏中浏览组件所花的时间。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>推荐方式
components/		
|- TodoList.vue
|- TodoListItem.vue			与父组件有公共前缀
|- TodoListItemButton.vue
components/
|- SearchSidebar.vue
|- SearchsidebarNavigation.vue

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="组件名中的单词顺序"><a href="#组件名中的单词顺序" class="header-anchor">#</a> 组件名中的单词顺序</h4> <p>​	<font color="orange">组件名应该以描述单词开头，以描述性的修饰词结尾</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>好的例子
components/
|- SearchButtonclear.vue
|- SearchButtonRun.vue
|- searchInputExcludeGlob.vue
|- SearchInputQuery.vue
|- SettingsCheckboxLaunchonstartup.vue
|- settingscheckboxTerms.vue
此例子中，描述为搜索、设置 ，修饰为清除、运行等
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>​		<font color="orange">编辑器通常会按字母顺序组织文件</font>，所以现在组件之间的重要关系一目了然了。
​		<font color="pink">如果换成多级目录的方式，把所有的搜索组件放到search目录，把所有的设置组件放到settings目录。Vue.js官方推荐只有在非常大型（如有100+个组件）的应用下才考虑这么做，原因有以下几点。</font></p> <ul><li>在多级目录间找来找去比在单个components目录下滚动查找花费更多的精力。</li> <li>存在组件重名的时候（比如存在多个 ButtonDelete组件)，在编辑器里更难快速定位。</li> <li>让重构变得更难，因为为一个移动了的组件更新相关引用时，查找或替换通常并不高效。</li></ul> <h4 id="完整单词的组件名"><a href="#完整单词的组件名" class="header-anchor">#</a> 完整单词的组件名</h4> <p>​		<font color="orange">组件名应该倾向于完整单词而不是缩写。编辑器中的自动补全已经让书写长命名的代价非常低了，而它带来的明确性却是非常宝贵的。尤其应该避免不常用的缩写。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>components/
|- StudentDashbordSettings.vue
|- UserProfileOptions.vue
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h4 id="组件名为多个单词"><a href="#组件名为多个单词" class="header-anchor">#</a> 组件名为多个单词</h4> <p>​		<font color="orange">组件名应该始终由多个单词组成，但是根组件App 除外。这样做可以避免与现有的以及未来的HTML元素相冲突，因为所有的HTML元素名称都是单个单词的。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>推荐例子
Vue.components('todo-item',{})
export default {
	name:&quot;TodoItem&quot;,
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="模板中组件名的大小写"><a href="#模板中组件名的大小写" class="header-anchor">#</a> 模板中组件名的大小写</h4> <p>​		<font color="orange">对于绝大多数项目来说，在单文件组件和字符串模板中的组件名应该总是单词首字母大写,但是在DOM模板中总是横线连接的。</font></p> <p>单词中首字母大写的优势在于在模板里可以自动补全组件名。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>推荐方式
单文件组件
&lt;MyComponent/&gt;
在DOM模板中
&lt;my-component&gt;&lt;/my-component&gt;
------------
在所有地方
&lt;my-component&gt;&lt;/my-component&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="js-jsx中的组件名大小写"><a href="#js-jsx中的组件名大小写" class="header-anchor">#</a> JS/JSX中的组件名大小写</h4> <p>​		<font color="orange">JS/JSX 中的组件名应该始终是单词首字母大写的。尽管在较为简单的应用中只使用Vue.component进行全局组件注册时，可以使用横线连接字符串。</font></p> <p>​		在JavaScript中，单词首字母大写是类和构造函数（<font color="orange">本质上是任何可以产生多份不同实例的东西</font>)的命名约定。Vue.js组件也有多份实例，所以同样使用单词首字母大写是有意义的。额外的好处是，在JSX(和模板）里使用单词首字母大写能够<font color="orange">让读者更容易分辨Vue.js组件和HTML元素。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>推荐例子
Vue.component('MyComponent', {
	//..
})
Vue.component('my-component',{})
import MyComponent from './MyComponent.vue'
export default {
	name:'MyCompoent'
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="自闭合组件"><a href="#自闭合组件" class="header-anchor">#</a> 自闭合组件</h3> <p>​		<font color="orange">在单文件组件、字符串模板和JSX中，没有内容的组件应该是自闭合的，但在DOM模板中永远不要这样做。</font>
​		自闭合组件表示它们不仅没有内容，而且刻意没有内容，这就好像书上的一页白纸对比贴有“本页有意留白”标签的白纸。而且没有额外的闭合标签，你的代码也更简洁。
​		不幸的是，<font color="orange">HTML并不支持自闭合的自定义元素</font>，只有官方的“空”元素。所以上述策略仅适用于，进入DOM之前Vue.js 的模板编译器能够触达的地方，然后再生成符合DOM规范的HTML。这也是不要在DOM模板中这样做的原因。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>在单文件组件、字符串模板和JSX中
&lt;MyComponent/&gt;
在DOM模板中
&lt;my-component&gt;&lt;my-component&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="prop名的大小写"><a href="#prop名的大小写" class="header-anchor">#</a> prop名的大小写</h3> <p>​		<font color="orange">在声明prop 的时候，其命名应该始终使用驼峰式命名规则，而在模板和JSX中应该始终使用横线连接的方式。</font></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>推荐方式
props:{
	greetingText:String
}
&lt;my-component greeting-text=&quot;hi&quot; /&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="多个特性的元素"><a href="#多个特性的元素" class="header-anchor">#</a> 多个特性的元素</h3> <p>​		<font color="orange">多个特性的元素应该分多行撰写，每个特性一行。在 JavaScript 中，用多行分隔对象的多个属性是很常见的最佳实践，因为这更易读。模板和JSX值得我们做相同的考虑。</font></p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>推荐方式
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span>
	<span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://vuejs . org/ images/1ogo. png<span class="token punctuation">&quot;</span></span>
	<span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Vue Logo<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MyComponent</span>
	<span class="token attr-name">foo</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>a<span class="token punctuation">&quot;</span></span>
	<span class="token attr-name">bar</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>b<span class="token punctuation">&quot;</span></span>
	<span class="token attr-name">baz</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>c<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="模板中简单的表达式"><a href="#模板中简单的表达式" class="header-anchor">#</a> 模板中简单的表达式</h3> <p>​		组件模板应该只包含简单的表达式，复杂的表达式则应该重构为计算属性或方法。
​		<font color="orange">复杂的表达式会让模板变得不是那么声明式。我们应该尽量描述理应出现的是什么，而非如何计算那个值。而且计算属性和方法使得代码可以重用。</font></p> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>推荐方式
<span class="token comment">&lt;!--在模板中 --&gt;</span>
{{normalizedFullName}}
//复杂表达式已经移入一个计算属性
computed: {
normalizedFullName : function(){
	return this.fullName.split('').map(function (word) {
		return word[0].toUpperCase() + word.slice(1)
	}).join('')
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="简单的计算属性"><a href="#简单的计算属性" class="header-anchor">#</a> 简单的计算属性</h3> <p>​		应该把复杂的计算属性分隔为尽可能多更简单的属性。简单、命名得当的计算属性具有以下特点。</p> <ul><li>易于测试:当每个计算属性都包含一个非常简单且很少依赖的表达式时，撰写测试以确保其正确工作会更加容易。</li> <li>易于阅读:简化计算属性要求你为每一个值都起一个描述性的名称，即便它不可复用。这使得开发者更容易专注在代码上并搞清楚发生了什么。</li> <li>更好地“拥抱变化”:任何能够命名的值都可能用在视图上。举个例子，我们可能打算展示一个信息，告诉用户他们存了多少钱;也可能打算计算税费，但是可能会分开展现，而不是作为总价的一部分。</li></ul> <p><font color="orange">即如果一个值可计算处理后能用于多种视图信息，应为这个数据定义不同的计算属性名</font></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//好的例子</span>
<span class="token literal-property property">computed</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">basePrice</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> i
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>manufacturecost <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>profitMargin<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">discount</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>discountPercent <span class="token operator">|</span>l e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">finalprice</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>basePrice <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>discount
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="指令缩写"><a href="#指令缩写" class="header-anchor">#</a> 指令缩写</h3> <p>指令缩写要统一</p> <p><code>用 :表示 v-bind：用@表示v-on</code></p> <h3 id="良好的代码顺序"><a href="#良好的代码顺序" class="header-anchor">#</a> 良好的代码顺序</h3> <p><font color="orange">		代码顺序指的是组件/实例的选项的顺序、元素特性的顺序以及单文件组件的顶级元素的顺序。</font></p> <h4 id="组件-实例的选项顺序"><a href="#组件-实例的选项顺序" class="header-anchor">#</a> 组件/实例的选项顺序</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>副作用 (触发组件外的影响)
el

全局感知 (要求组件以外的知识)

name
parent
组件类型 (更改组件的类型)

functional
模板修改器 (改变模板的编译方式)

delimiters
comments
模板依赖 (模板内使用的资源)

components
directives
filters
组合 (向选项里合并属性)

extends
mixins
接口 (组件的接口)

inheritAttrs
model
props/propsData
本地状态 (本地的响应式属性)

data
computed
事件 (通过响应式事件触发的回调)

watch
生命周期钩子 (按照它们被调用的顺序)
beforeCreate
created
beforeMount
mounted
beforeUpdate
updated
activated
deactivated
beforeDestroy
destroyed
非响应式的属性 (不依赖响应系统的实例属性)

methods
渲染 (组件输出的声明式描述)

template/render
renderError
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><h4 id="元素特性的顺序"><a href="#元素特性的顺序" class="header-anchor">#</a> 元素特性的顺序</h4> <h4 id="单文件组件顶级元素顺序"><a href="#单文件组件顶级元素顺序" class="header-anchor">#</a> 单文件组件顶级元素顺序</h4> <div class="language-vue line-numbers-mode"><pre class="language-vue"><code>组件A
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
组件B
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><hr> <p>noop是空函数</p> <p><font color="orange">每个watcher的deps里存储的是：收集我的，全部属性，的dep实例</font></p> <p><font color="orange">dep.subs中，存的是，这个属性收集全部watcher</font></p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-70334359><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#变化侦测" class="sidebar-link reco-side-变化侦测" data-v-70334359>变化侦测</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#什么是变化侦测" class="sidebar-link reco-side-什么是变化侦测" data-v-70334359>什么是变化侦测</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#如何追踪变化侦测" class="sidebar-link reco-side-如何追踪变化侦测" data-v-70334359>如何追踪变化侦测</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#如何收集函数依赖" class="sidebar-link reco-side-如何收集函数依赖" data-v-70334359>如何收集函数依赖</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#依赖收集在哪-订阅者" class="sidebar-link reco-side-依赖收集在哪-订阅者" data-v-70334359>依赖收集在哪  （订阅者）</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#什么是依赖" class="sidebar-link reco-side-什么是依赖" data-v-70334359>什么是依赖</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#递归侦测所有的key" class="sidebar-link reco-side-递归侦测所有的key" data-v-70334359>递归侦测所有的key</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#dep和watcher类" class="sidebar-link reco-side-dep和watcher类" data-v-70334359>Dep和Watcher类</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#问题" class="sidebar-link reco-side-问题" data-v-70334359>问题</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结" class="sidebar-link reco-side-总结" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#arrary的变化侦测" class="sidebar-link reco-side-arrary的变化侦测" data-v-70334359>Arrary的变化侦测</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#如何追踪变化" class="sidebar-link reco-side-如何追踪变化" data-v-70334359>如何追踪变化</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#拦截器" class="sidebar-link reco-side-拦截器" data-v-70334359>拦截器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#使用拦截器覆盖array原型" class="sidebar-link reco-side-使用拦截器覆盖array原型" data-v-70334359>使用拦截器覆盖Array原型</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#依赖列表的存储" class="sidebar-link reco-side-依赖列表的存储" data-v-70334359>依赖列表的存储</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#收集依赖" class="sidebar-link reco-side-收集依赖" data-v-70334359>收集依赖</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#在拦截器获取observer实例" class="sidebar-link reco-side-在拦截器获取observer实例" data-v-70334359>在拦截器获取Observer实例</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#发送通知" class="sidebar-link reco-side-发送通知" data-v-70334359>发送通知</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#对数组单个元素进行侦测" class="sidebar-link reco-side-对数组单个元素进行侦测" data-v-70334359>对数组单个元素进行侦测</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#侦测新增元素的变化" class="sidebar-link reco-side-侦测新增元素的变化" data-v-70334359>侦测新增元素的变化</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#问题-2" class="sidebar-link reco-side-问题-2" data-v-70334359>问题</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-2" class="sidebar-link reco-side-总结-2" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#变化侦测相关api实现" class="sidebar-link reco-side-变化侦测相关api实现" data-v-70334359>变化侦测相关API实现</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vm-watch" class="sidebar-link reco-side-vm-watch" data-v-70334359>vm.$watch</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#watch内部原理" class="sidebar-link reco-side-watch内部原理" data-v-70334359>watch内部原理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vm-set" class="sidebar-link reco-side-vm-set" data-v-70334359>vm.$set</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#deep参数原理" class="sidebar-link reco-side-deep参数原理" data-v-70334359>deep参数原理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vm-set-2" class="sidebar-link reco-side-vm-set-2" data-v-70334359>vm.$set</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vm-delete" class="sidebar-link reco-side-vm-delete" data-v-70334359>vm.$delete</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#虚拟dom" class="sidebar-link reco-side-虚拟dom" data-v-70334359>虚拟DOM</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#为什么引入虚拟dom" class="sidebar-link reco-side-为什么引入虚拟dom" data-v-70334359>为什么引入虚拟DOM</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vue-js的虚拟dom" class="sidebar-link reco-side-vue-js的虚拟dom" data-v-70334359>Vue.js的虚拟DOM</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-3" class="sidebar-link reco-side-总结-3" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vnode" class="sidebar-link reco-side-vnode" data-v-70334359>VNode</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#vnode类型" class="sidebar-link reco-side-vnode类型" data-v-70334359>VNode类型</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-4" class="sidebar-link reco-side-总结-4" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#patch算法" class="sidebar-link reco-side-patch算法" data-v-70334359>patch算法</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#patch介绍" class="sidebar-link reco-side-patch介绍" data-v-70334359>patch介绍</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#更新节点" class="sidebar-link reco-side-更新节点" data-v-70334359>更新节点</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#创建节点" class="sidebar-link reco-side-创建节点" data-v-70334359>创建节点</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#删除节点-2" class="sidebar-link reco-side-删除节点-2" data-v-70334359>删除节点</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#更新节点-2" class="sidebar-link reco-side-更新节点-2" data-v-70334359>更新节点</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#更新策略" class="sidebar-link reco-side-更新策略" data-v-70334359>更新策略</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#优化策略" class="sidebar-link reco-side-优化策略" data-v-70334359>优化策略</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#判断未处理的节点" class="sidebar-link reco-side-判断未处理的节点" data-v-70334359>判断未处理的节点</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#第三篇" class="sidebar-link reco-side-第三篇" data-v-70334359>第三篇</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#模板编译" class="sidebar-link reco-side-模板编译" data-v-70334359>模板编译</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#概念" class="sidebar-link reco-side-概念" data-v-70334359>概念</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#模板编译成渲染函数" class="sidebar-link reco-side-模板编译成渲染函数" data-v-70334359>模板编译成渲染函数</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#解析器-2" class="sidebar-link reco-side-解析器-2" data-v-70334359>解析器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#解析器的作用" class="sidebar-link reco-side-解析器的作用" data-v-70334359>解析器的作用</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#解析器内部原理" class="sidebar-link reco-side-解析器内部原理" data-v-70334359>解析器内部原理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#html解析器-2" class="sidebar-link reco-side-html解析器-2" data-v-70334359>HTML解析器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#文本解析器" class="sidebar-link reco-side-文本解析器" data-v-70334359>文本解析器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-5" class="sidebar-link reco-side-总结-5" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#优化器-2" class="sidebar-link reco-side-优化器-2" data-v-70334359>优化器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#找出静态节点并标记" class="sidebar-link reco-side-找出静态节点并标记" data-v-70334359>找出静态节点并标记</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#找出所有的静态根节点" class="sidebar-link reco-side-找出所有的静态根节点" data-v-70334359>找出所有的静态根节点</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#代码生成器-2" class="sidebar-link reco-side-代码生成器-2" data-v-70334359>代码生成器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#通过ast生成代码字符串" class="sidebar-link reco-side-通过ast生成代码字符串" data-v-70334359>通过AST生成代码字符串</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#具体原理" class="sidebar-link reco-side-具体原理" data-v-70334359>具体原理</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#第四篇" class="sidebar-link reco-side-第四篇" data-v-70334359>第四篇</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#整体流程" class="sidebar-link reco-side-整体流程" data-v-70334359>整体流程</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#架构设计" class="sidebar-link reco-side-架构设计" data-v-70334359>架构设计</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-6" class="sidebar-link reco-side-总结-6" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#实例方法与全局api的实现" class="sidebar-link reco-side-实例方法与全局api的实现" data-v-70334359>实例方法与全局API的实现</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#数据相关的实例方法" class="sidebar-link reco-side-数据相关的实例方法" data-v-70334359>数据相关的实例方法</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#事件相关的实例方法" class="sidebar-link reco-side-事件相关的实例方法" data-v-70334359>事件相关的实例方法</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#全局api的实现原理" class="sidebar-link reco-side-全局api的实现原理" data-v-70334359>全局API的实现原理</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#某些方法源码" class="sidebar-link reco-side-某些方法源码" data-v-70334359>某些方法源码</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#toarray" class="sidebar-link reco-side-toarray" data-v-70334359>toArray</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#生命周期" class="sidebar-link reco-side-生命周期" data-v-70334359>生命周期</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#_14-1" class="sidebar-link reco-side-_14-1" data-v-70334359>14.1</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#从源码角度了解生命周期" class="sidebar-link reco-side-从源码角度了解生命周期" data-v-70334359>从源码角度了解生命周期</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#errorcaptured与错误处理" class="sidebar-link reco-side-errorcaptured与错误处理" data-v-70334359>errorCaptured与错误处理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化实例属性" class="sidebar-link reco-side-初始化实例属性" data-v-70334359>初始化实例属性</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化事件" class="sidebar-link reco-side-初始化事件" data-v-70334359>初始化事件</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化-inject" class="sidebar-link reco-side-初始化-inject" data-v-70334359>初始化 inject</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化状态" class="sidebar-link reco-side-初始化状态" data-v-70334359>初始化状态</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化methods" class="sidebar-link reco-side-初始化methods" data-v-70334359>初始化methods</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化data" class="sidebar-link reco-side-初始化data" data-v-70334359>初始化data</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化computed" class="sidebar-link reco-side-初始化computed" data-v-70334359>初始化computed</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化watch" class="sidebar-link reco-side-初始化watch" data-v-70334359>初始化watch</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#初始化provide" class="sidebar-link reco-side-初始化provide" data-v-70334359>初始化provide</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-8" class="sidebar-link reco-side-总结-8" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#指令的奥秘" class="sidebar-link reco-side-指令的奥秘" data-v-70334359>指令的奥秘</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#什么是指令" class="sidebar-link reco-side-什么是指令" data-v-70334359>什么是指令</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#指令的原理" class="sidebar-link reco-side-指令的原理" data-v-70334359>指令的原理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#自定义指令内部原理" class="sidebar-link reco-side-自定义指令内部原理" data-v-70334359>自定义指令内部原理</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#虚拟dom钩子函数" class="sidebar-link reco-side-虚拟dom钩子函数" data-v-70334359>虚拟DOM钩子函数</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#过滤器的奥秘" class="sidebar-link reco-side-过滤器的奥秘" data-v-70334359>过滤器的奥秘</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#过滤器用法及定义" class="sidebar-link reco-side-过滤器用法及定义" data-v-70334359>过滤器用法及定义</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#过滤器原理概述" class="sidebar-link reco-side-过滤器原理概述" data-v-70334359>过滤器原理概述</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#解析过滤器" class="sidebar-link reco-side-解析过滤器" data-v-70334359>解析过滤器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#总结-9" class="sidebar-link reco-side-总结-9" data-v-70334359>总结</a></li><li class="level-2" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#实际运用" class="sidebar-link reco-side-实际运用" data-v-70334359>实际运用</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#为列表渲染设置属性key" class="sidebar-link reco-side-为列表渲染设置属性key" data-v-70334359>为列表渲染设置属性key</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#在v-if-v-if-else-v-else-中使用key" class="sidebar-link reco-side-在v-if-v-if-else-v-else-中使用key" data-v-70334359>在v-if/v-if-else/v-else 中使用key</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#路由切换组件不变" class="sidebar-link reco-side-路由切换组件不变" data-v-70334359>路由切换组件不变</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#为所有路由统一添加query" class="sidebar-link reco-side-为所有路由统一添加query" data-v-70334359>为所有路由统一添加query</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#区分vuex和props的使用边界" class="sidebar-link reco-side-区分vuex和props的使用边界" data-v-70334359>区分Vuex和props的使用边界</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#避免v-if和v-for一起使用" class="sidebar-link reco-side-避免v-if和v-for一起使用" data-v-70334359>避免v-if和v-for一起使用</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#为组件设置作用域" class="sidebar-link reco-side-为组件设置作用域" data-v-70334359>为组件设置作用域</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#避免在scoped中使用元素选择器" class="sidebar-link reco-side-避免在scoped中使用元素选择器" data-v-70334359>避免在scoped中使用元素选择器</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#避免隐形的父子组件通信" class="sidebar-link reco-side-避免隐形的父子组件通信" data-v-70334359>避免隐形的父子组件通信</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#单文件组件如何命名" class="sidebar-link reco-side-单文件组件如何命名" data-v-70334359>单文件组件如何命名</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#自闭合组件" class="sidebar-link reco-side-自闭合组件" data-v-70334359>自闭合组件</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#prop名的大小写" class="sidebar-link reco-side-prop名的大小写" data-v-70334359>prop名的大小写</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#多个特性的元素" class="sidebar-link reco-side-多个特性的元素" data-v-70334359>多个特性的元素</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#模板中简单的表达式" class="sidebar-link reco-side-模板中简单的表达式" data-v-70334359>模板中简单的表达式</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#简单的计算属性" class="sidebar-link reco-side-简单的计算属性" data-v-70334359>简单的计算属性</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#指令缩写" class="sidebar-link reco-side-指令缩写" data-v-70334359>指令缩写</a></li><li class="level-3" data-v-70334359><a href="/ccyblog/blogs/vue/yuan-ma.html#良好的代码顺序" class="sidebar-link reco-side-良好的代码顺序" data-v-70334359>良好的代码顺序</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-6e863240><div class="banniang-container" style="display:;" data-v-6e863240><div class="messageBox" style="right:88px;bottom:270px;display:none;" data-v-6e863240></div> <div class="operation" style="right:15px;bottom:100px;" data-v-6e863240><i class="kbnfont kbn-ban-home ban-home" data-v-6e863240></i> <i class="kbnfont kbn-ban-message message" data-v-6e863240></i> <i class="kbnfont kbn-ban-info info" data-v-6e863240></i> <i class="kbnfont kbn-ban-close close" data-v-6e863240></i></div> <div id="L2dCanvas" class="Canvas" style="position: absolute; bottom: -50px;z-index:100000" data-v-6e863240></div></div> <div class="showBanNiang" style="display:none;" data-v-6e863240>看板娘</div></div><!----></div></div>
    <script src="/ccyblog/assets/js/app.61cc9ff9.js" defer></script><script src="/ccyblog/assets/js/3.897744a6.js" defer></script><script src="/ccyblog/assets/js/1.371d3697.js" defer></script><script src="/ccyblog/assets/js/18.71e79375.js" defer></script><script src="/ccyblog/assets/js/8.b19724a0.js" defer></script>
  </body>
</html>
